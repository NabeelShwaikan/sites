<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ© â€” Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</title>
  <style>
    /* â€”â€”â€”â€”â€” Ù†Ù…Ø· ØµØ¨Ø§Ø­ÙŠ Ù…Ø´Ø±Ù‚ (Ø§Ù„Ø®ÙŠØ§Ø± Ø±Ù‚Ù… 2) â€”â€”â€”â€”â€” */
    :root{
      --bg1:#e0f2fe; /* ØµØ¨Ø§Ø­ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ */
      --bg2:#ede9fe;
      --panel:#ffffff;
      --border:rgba(2, 6, 23, .08);
      --muted:#334155;
      --text:#0f172a;
      --accent:#818cf8;
      --accent2:#38bdf8;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.10)
    }
    /* â€”â€” Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ù…Ø§Øª â€”â€” */
    html[data-theme="day"]{
      /* Ù†Ù‡Ø§Ø±ÙŠ Ø¯Ø§ÙØ¦ ÙˆÙ…Ø´Ø±Ù‚ (Ù…Ø®ØªÙ„Ù Ø¨ÙˆØ¶ÙˆØ­ Ø¹Ù† Ø§Ù„ØµØ¨Ø§Ø­ÙŠ Ø§Ù„Ø£Ø²Ø±Ù‚/Ù„Ø§ÙÙ†Ø¯Ø±) */
      --bg1:#fff7ed; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ù‹Ø§ */
      --bg2:#ffedd5; /* Ø®ÙˆØ®ÙŠ Ø¨Ø§Ù‡Øª */
      --panel:#ffffff;
      --border:rgba(2,6,23,.08);
      --text:#0f172a;
      --muted:#6b7280;
      --accent:#f59e0b; /* Ø£Ù…Ø¨Ø± */
      --accent2:#f97316; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
    }
    html[data-theme="morning"]{
      --bg1:#e0f2fe; --bg2:#ede9fe; --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#0f172a; --muted:#334155; --accent:#818cf8; --accent2:#38bdf8;
    }
    html[data-theme="dark"]{
      --bg1:#0b1220; --bg2:#111827; --panel:#0b1220; --border:rgba(255,255,255,.10);
      --text:#e2e8f0; --muted:#cbd5e1; --accent:#a78bfa; --accent2:#22d3ee;
    }
    /* â€”â€”â€” Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© â€”â€”â€” */
    html[data-theme="nature"]{
      --bg1:#ecfccb; /* Ø£Ø®Ø¶Ø± Ù„ÙŠÙ…ÙˆÙ†ÙŠ ÙØ§ØªØ­ */
      --bg2:#d9f99d; /* Ø£Ø®Ø¶Ø± Ø¹Ø´Ø¨ÙŠ ÙØ§ØªØ­ */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#052e16; --muted:#166534; --accent:#22c55e; --accent2:#4ade80;
    }
    html[data-theme="sunset"]{
      --bg1:#fce7f3; /* ÙˆØ±Ø¯ÙŠ ÙØ§ØªØ­ */
      --bg2:#fde68a; /* Ø£ØµÙØ± ØºØ±ÙˆØ¨ */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#3f1d2e; --muted:#7c2d12; --accent:#f472b6; --accent2:#fb923c;
    }
    html[data-theme="ice"]{
      --bg1:#e0f2fe; /* Ø£Ø²Ø±Ù‚ Ø«Ù„Ø¬ÙŠ */
      --bg2:#f0f9ff; /* Ø³Ù…Ø§ÙˆÙŠ Ø¨Ø§Ù‡Øª */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#0c4a6e; --muted:#0369a1; --accent:#38bdf8; --accent2:#7dd3fc;
    }
    html[data-theme="neon"]{
      --bg1:#080b12; --bg2:#0f172a; --panel:#0b1220; --border:rgba(255,255,255,.12);
      --text:#e5e7eb; --muted:#a5b4fc; --accent:#22d3ee; --accent2:#a78bfa; /* Ø£Ù„ÙˆØ§Ù† Ù†ÙŠÙˆÙ† */
    }
    html[data-theme="cosmic"]{
      --bg1:#1f1d2b; --bg2:#111827; --panel:#141624; --border:rgba(255,255,255,.10);
      --text:#e2e8f0; --muted:#c7d2fe; --accent:#8b5cf6; --accent2:#06b6d4;
    }
    html[data-theme="blossom"]{
      --bg1:#ffe4e6; /* ÙˆØ±Ø¯ÙŠ Ø¨Ø§Ù‡Øª */
      --bg2:#ede9fe; /* Ù„Ø§ÙÙ†Ø¯Ø± ÙØ§ØªØ­ */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#4a044e; --muted:#7e22ce; --accent:#f9a8d4; --accent2:#c084fc;
    }
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif; min-height:100vh; padding:18px 18px 90px; transition:background .35s ease, color .35s ease}
    .card, .viz, .viz3d, .kpi, .weather{ transition: background .35s ease, border-color .35s ease, color .35s ease }
    .app{width:min(1200px,100%); margin:0 auto}
    h1{margin:0 0 6px; font-size:clamp(20px,2.8vw,28px)}
    p.subtitle{margin:0 0 14px; color:var(--muted); font-size:14px}

    .grid{display:grid; grid-template-columns:.95fr 1.05fr; gap:16px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    label{font-size:14px; color:var(--muted)}
    input,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(2,6,23,.12); background:#f8fafc; color:var(--text); outline:none}
    html[data-theme="dark"] input, html[data-theme="dark"] select { background:#0f172a; border-color:rgba(255,255,255,.16); color:#e2e8f0 }
    html[data-theme="dark"] .kpi{ background:#0b1220; border-color:rgba(255,255,255,.12) }
    html[data-theme="dark"] .weather{ background:rgba(17,24,39,.7); border-color:rgba(255,255,255,.1) }
    html[data-theme="dark"] .w-chip{ background:#0f172a; border-color:rgba(255,255,255,.12) }

    .btn{cursor:pointer; border:none; border-radius:999px; padding:10px 16px; font-weight:700; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1220; display:inline-flex; align-items:center; gap:8px; box-shadow:0 6px 16px rgba(2,6,23,.12)}
    .ghost{background:transparent; color:var(--text); border:1px solid rgba(2,6,23,.18)}
    html[data-theme="dark"] .ghost{ border-color: rgba(255,255,255,.22) }
    .themebtn.active{ box-shadow:0 0 0 2px var(--accent) inset; }
    .ghost{background:transparent; color:var(--text); border:1px solid rgba(2,6,23,.18)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .kpis{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    @media (max-width:900px){ .kpis{grid-template-columns:1fr} }
    .kpi{background:#ffffff; border:1px solid var(--border); border-radius:14px; padding:10px}
    .kpi h3{margin:0 0 4px; font-size:15px}
    .kpi .value{font-size:22px; font-weight:900}
    .kpi .detail{color:var(--muted); font-size:12px}
    .ok{border-color:rgba(22,163,74,.4)} .warn{border-color:rgba(217,119,6,.5)} .bad{border-color:rgba(220,38,38,.55)}

    .section-title{font-weight:700; margin:10px 0 6px; font-size:14px; color:var(--muted)}
    .viz,.viz3d{background:#ffffff; border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; align-items:center; justify-content:center}
    .viz svg{width:100%; height:auto; max-height:360px}
    #body3d{width:100%; height:360px; display:block}
    .toggle{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; margin-top:10px}
    .foot{color:var(--muted); font-size:12px; margin-top:8px}

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø·Ù‚Ø³ */
    .weather{display:flex; align-items:center; gap:12px; padding:10px 12px; background:rgba(255,255,255,.75); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
    .w-main{display:flex; align-items:center; gap:10px}
    .w-icon{font-size:26px}
    .w-city{font-weight:800}
    .w-meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--text)}
    .w-chip{background:#f1f5f9; border:1px solid rgba(2,6,23,.08); padding:4px 8px; border-radius:999px; font-size:12px}

    /* Ø³Ø¬Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª */
    .history{display:grid; gap:10px}
    .hrow{display:grid; grid-template-columns: 130px 1fr 1fr 1fr 1fr 1fr auto; gap:8px; align-items:center; border:1px solid var(--border); border-radius:10px; padding:8px; background:#ffffff}
    .hhead{font-weight:800; color:#0f172a; background:rgba(2,6,23,.04)}
    .hcell{font-size:13px; color:#0f172a}
    .hcell small{color:#475569}
    .del{border:none; background:transparent; color:#b91c1c; cursor:pointer; font-weight:900; font-size:16px}
  .select-wrap{ position:relative; display:inline-flex; align-items:center; }
    #themeSelect{ appearance:none; -moz-appearance:none; -webkit-appearance:none; padding:10px 36px 10px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-weight:700; box-shadow:0 6px 16px rgba(2,6,23,.06) }
    .chev{ position:absolute; right:10px; pointer-events:none; color:var(--muted); font-weight:900 }
    html[data-theme="dark"] #themeSelect{ background:#0f172a; color:#e2e8f0; border-color:rgba(255,255,255,.16) }
  </style>
</head>
<body>
  <div class="app">
    <h1>ğŸ©º Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ© â€” Ù…Ø¹ Ø³Ø¬Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</h1>
    <!-- Ø´Ø±ÙŠØ· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…Ø· (Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©) -->
    <div class="themebar" style="display:flex; gap:10px; align-items:center; margin:8px 0 12px">
      <span style="font-size:13px; color:var(--muted)">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…Ø·:</span>
      <div class="select-wrap">
        <select id="themeSelect" aria-label="Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…Ø·">
          <option value="day">Ù†Ù‡Ø§Ø±ÙŠ</option>
          <option value="morning">ØµØ¨Ø§Ø­ÙŠ Ù…Ø´Ø±Ù‚</option>
          <option value="dark">Ø¯Ø§ÙƒÙ† Ø­ÙŠÙˆÙŠ</option>
          <option value="nature">Ø·Ø¨ÙŠØ¹ÙŠ (Ø£Ø®Ø¶Ø±)</option>
          <option value="sunset">ØºØ±ÙˆØ¨</option>
          <option value="ice">Ø«Ù„Ø¬ÙŠ</option>
          <option value="neon">Ù†ÙŠÙˆÙ† Ø¯Ø§ÙƒÙ†</option>
          <option value="cosmic">ÙØ¶Ø§Ø¦ÙŠ</option>
          <option value="blossom">Ø²Ù‡Ø±ÙŠ</option>
        </select>
        <span class="chev">â–¾</span>
      </div>
    </div>
    <p class="subtitle">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ (Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„Ø¬Ù†Ø³ØŒ Ø§Ù„Ø·ÙˆÙ„ØŒ Ø§Ù„ÙˆØ²Ù†ØŒ Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ±). Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¹ "Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ" Ù„ÙƒÙ„ Ù…Ø¤Ø´Ø±. ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø·Ù‚Ø³ Ø§Ù„Ù„Ø­Ø¸ÙŠ -->
    <div id="weatherBar" class="weather" aria-live="polite" style="margin:12px 0; display:none">
      <div class="w-main">
        <div class="w-icon" id="wIcon">â˜€ï¸</div>
        <div>
          <div class="w-city" id="wCity">â€”</div>
          <div class="w-meta">
            <span class="w-chip" id="wTemp">â€”Â°C</span>
            <span class="w-chip" id="wCloud">ØºÙŠÙˆÙ… â€”%</span>
            <span class="w-chip" id="wUV">UV â€”</span>
            <span class="w-chip" id="wSuit">Ø§Ù„Ø¬Ùˆ: â€”</span>
          </div>
        </div>
      </div>
      <button class="btn ghost" id="refreshWx" title="ØªØ­Ø¯ÙŠØ«">ØªØ­Ø¯ÙŠØ«</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div>
            <label>Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†Ø©)</label>
            <input id="age" type="number" min="5" max="120" placeholder="Ù…Ø«Ø§Ù„: 35" />
          </div>
          <div>
            <label>Ø§Ù„Ø¬Ù†Ø³</label>
            <select id="sex">
              <option value="male">Ø°ÙƒØ±</option>
              <option value="female">Ø£Ù†Ø«Ù‰</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
            <input id="height" type="number" min="80" max="250" placeholder="Ù…Ø«Ø§Ù„: 175" />
          </div>
          <div>
            <label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
            <input id="weight" type="number" min="20" max="400" placeholder="Ù…Ø«Ø§Ù„: 80" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…)</label>
            <input id="waist" type="number" min="30" max="200" placeholder="Ù…Ø«Ø§Ù„: 92" />
          </div>
          <div>
            <label>Ø§Ù„Ù†Ø´Ø§Ø· (Ù„Ù€ TDEE)</label>
            <select id="activity">
              <option value="1.2">Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©</option>
              <option value="1.375">Ù†Ø´Ø§Ø· Ø®ÙÙŠÙ (1â€“3 Ø£ÙŠØ§Ù…/Ø£Ø³Ø¨ÙˆØ¹)</option>
              <option value="1.55">Ù†Ø´Ø§Ø· Ù…ØªÙˆØ³Ø· (3â€“5 Ø£ÙŠØ§Ù…/Ø£Ø³Ø¨ÙˆØ¹)</option>
              <option value="1.725">Ù†Ø´Ø§Ø· Ø¹Ø§Ù„Ù (6â€“7 Ø£ÙŠØ§Ù…/Ø£Ø³Ø¨ÙˆØ¹)</option>
              <option value="1.9">Ù†Ø´Ø§Ø· Ø¹Ø§Ù„Ù Ø¬Ø¯Ù‹Ø§ / Ø¹Ù…Ù„ Ø¨Ø¯Ù†ÙŠ</option>
            </select>
          </div>
        </div>
        <div class="section-title">Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</div>
        <div class="row">
          <div>
            <label>Ù…Ø­ÙŠØ· Ø§Ù„ÙˆØ±Ùƒ (Ø³Ù…) â€” Ù„Ø§Ø­ØªØ³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµØ±/Ø§Ù„ÙˆØ±Ùƒ</label>
            <input id="hip" type="number" min="40" max="220" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
          <div>
            <label>Ù…Ø­ÙŠØ· Ø§Ù„Ø±Ù‚Ø¨Ø© (Ø³Ù…) â€” Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠØ© Ù„Ù„Ø¯Ù‡ÙˆÙ†</label>
            <input id="neck" type="number" min="20" max="70" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ (Ø£Ø¹Ù„Ù‰) mmHg</label>
            <input id="sbp" type="number" min="70" max="240" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
          <div>
            <label>Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ø§Ù„Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ (Ø£Ø¯Ù†Ù‰) mmHg</label>
            <input id="dbp" type="number" min="40" max="140" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="calc">Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¢Ù†</button>
          <button class="btn ghost" id="reset">Ù…Ø³Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª</button>
        </div>
        <p class="foot">ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ‚Ø¯ÙŠØ±ÙŠØ© ÙˆÙ„Ø§ ØªÙØºÙ†ÙŠ Ø¹Ù† Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø·Ø¨ÙŠ.</p>
      </div>

      <div class="card">
        <div class="kpis" id="kpis"><div class="kpi"><h3>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø«Ù… Ø§Ø¶ØºØ· Â«Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¢Ù†Â»</h3><div class="detail">Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„ÙƒÙ„ Ù…Ø¤Ø´Ø±.</div></div></div>
        <div class="section-title">ØªØµÙˆÙ‘Ø± Ø«Ù†Ø§Ø¦ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ø§Ø³ØªØ±Ø´Ø§Ø¯ÙŠ)</div>
        <div class="viz"><svg id="bodyViz" viewBox="0 0 200 420" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="200" height="420" fill="none"/></svg></div>
        <label class="toggle"><input type="checkbox" id="enable3d"> Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ 3D Ù…ØªØ­Ø±Ùƒ</label>
        <div class="viz3d" id="viz3d" style="display:none"><canvas id="body3d" width="640" height="360"></canvas></div>
        <p class="foot">Ø§Ù„ØªÙ„ÙˆÙŠÙ†: <span style="color:#16a34a">Ø¬ÙŠØ¯</span> â€¢ <span style="color:#d97706">Ø­Ø¯Ù‘ÙŠ/Ù…ØªÙˆØ³Ø·</span> â€¢ <span style="color:#dc2626">Ù…Ø±ØªÙØ¹</span>.</p>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© -->
    <div class="card" id="historyCard" style="margin-top:16px">
      <div class="section-title">Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ)</div>
      <div class="actions" style="margin-bottom:8px">
        <button class="btn ghost" id="clearHistory">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
      </div>
      <div id="history" class="history"></div>
      <p class="foot">Ù„Ø§ ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª â€” ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¯Ø§Ø®Ù„ Ù…ØªØµÙØ­Ùƒ ÙÙ‚Ø·.</p>
    </div>
  </div>
  
  <!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ -->
  <button id="scrollTop" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø£Ø¹Ù„Ù‰" style="position:fixed; inset:auto 16px 16px auto; z-index:50; display:none; border:none; border-radius:999px; padding:10px 14px; font-weight:800; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1220; box-shadow:0 8px 20px rgba(2,6,23,.18); cursor:pointer">â–² Ø£Ø¹Ù„Ù‰</button>

  <script>
    // Ø¹Ù†Ø§ØµØ±
    const $ = s=>document.querySelector(s);
    const age=$('#age'), sex=$('#sex'), height=$('#height'), weight=$('#weight'), waist=$('#waist'), act=$('#activity');
    const hip=$('#hip'), neck=$('#neck'), sbp=$('#sbp'), dbp=$('#dbp');
    const kpis=$('#kpis');

    // ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ
    const LS='health:inputs:v4';
    const HIST='health:history:v3';
    function saveInputs(){ localStorage.setItem(LS, JSON.stringify({age:age.value, sex:sex.value, height:height.value, weight:weight.value, waist:waist.value, act:act.value, hip:hip.value, neck:neck.value, sbp:sbp.value, dbp:dbp.value})); }
    function loadInputs(){ try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); Object.entries(d).forEach(([k,v])=>{ const el={age,sex,height,weight,waist,act,hip,neck,sbp,dbp}[k]; if(el) el.value=v; }); }catch(e){} }

    // â€”â€”â€” Ø´Ø±ÙŠØ· Ø§Ù„Ø·Ù‚Ø³ (Open-Meteo + Geolocation) â€”â€”â€”
    async function fetchWeather(){
      const bar=$('#weatherBar'); const icon=$('#wIcon'); const city=$('#wCity'); const wTemp=$('#wTemp'); const wCloud=$('#wCloud'); const wUV=$('#wUV'); const wSuit=$('#wSuit');
      const fallback={lat:24.7136, lon:46.6753, name:'Ø§Ù„Ø±ÙŠØ§Ø¶'}; // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„Ø±ÙŠØ§Ø¶
      function pickIcon(isDay, cloud){
        if(!isDay) return 'ğŸŒ™';
        if(cloud<20) return 'â˜€ï¸';
        if(cloud<70) return 'â›…';
        return 'â˜ï¸';
      }
      function suitability(temp, uv, cloud){
        let ok=true, note='Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø®Ø±ÙˆØ¬';
        if(temp<18 || temp>38) ok=false;
        if(uv>=8) ok=false; // UV Ø¹Ø§Ù„Ù
        if(!ok) note='ÙŠØªØ·Ù„Ù‘Ø¨ Ø§Ø­ØªÙŠØ§Ø·Ø§Øª';
        return note;
      }
      async function doFetch(lat,lon,label){
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,cloud_cover,uv_index,is_day&timezone=Asia%2FRiyadh`;
        const r=await fetch(url); const j=await r.json(); const c=j.current||{};
        icon.textContent=pickIcon(c.is_day, c.cloud_cover??0);
        city.textContent=label||'Ù…ÙˆÙ‚Ø¹Ùƒ';
        wTemp.textContent=`${Math.round(c.temperature_2m)}Â°C`;
        wCloud.textContent=`ØºÙŠÙˆÙ… ${c.cloud_cover??0}%`;
        wUV.textContent=`UV ${c.uv_index??0}`;
        wSuit.textContent=suitability(c.temperature_2m, c.uv_index, c.cloud_cover);
        bar.style.display='flex';
      }
      try{
        const pos = await new Promise((res,rej)=> navigator.geolocation ? navigator.geolocation.getCurrentPosition(res,rej,{timeout:6000, enableHighAccuracy:false}) : rej('no geo'));
        await doFetch(pos.coords.latitude, pos.coords.longitude, 'Ù…ÙˆÙ‚Ø¹Ùƒ');
      }catch(e){
        await doFetch(fallback.lat, fallback.lon, fallback.name);
      }
    }

    $('#refreshWx').addEventListener('click', fetchWeather);

    // â€”â€”â€” Ø¯ÙˆØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© â€”â€”â€”
    const toM = cm => Number(cm)/100; const toIn = cm => Number(cm)/2.54;
    const BMI = (kg, cm) => kg/Math.pow(toM(cm),2);
    const BMIcat = b => (b<18.5?['Ù†Ø­Ø§ÙØ©','warn']: b<25?['Ø·Ø¨ÙŠØ¹ÙŠ','ok']: b<30?['Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù†','warn']: b<35?['Ø³Ù…Ù†Ø© (1)','bad']: b<40?['Ø³Ù…Ù†Ø© (2)','bad']: ['Ø³Ù…Ù†Ø© (3)','bad']);
    const BMIPrime = bmi => bmi/25; // (BMI/25)
    const PI = (kg, cm) => kg/Math.pow(toM(cm),3);
    const WHtR = (wc, h) => wc/h;
    const WHtRcat = x => (x<0.45?['Ù…Ù…ØªØ§Ø²','ok']: x<0.5?['ØµØ­ÙŠ','ok']: x<0.55?['Ø­Ø¯Ù‘ÙŠ','warn']: x<0.6?['Ù…Ø±ØªÙØ¹','warn']: ['Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ù‹Ø§','bad']);
    const waistRisk = (s,wc) => (s==='male' ? (wc>=102?['Ù…Ø±ØªÙØ¹','bad']: wc>=94?['Ø­Ø¯Ù‘ÙŠ','warn']: ['Ø·Ø¨ÙŠØ¹ÙŠ','ok']) : (wc>=88?['Ù…Ø±ØªÙØ¹','bad']: wc>=80?['Ø­Ø¯Ù‘ÙŠ','warn']: ['Ø·Ø¨ÙŠØ¹ÙŠ','ok']) );
    const bodyFatDeurenberg = (bmi, a, s) => 1.20*bmi + 0.23*a - 10.8*(s==='male'?1:0) - 5.4;
    const BMR = (kg, cm, a, s) => (s==='male'? (10*kg + 6.25*cm - 5*a + 5) : (10*kg + 6.25*cm - 5*a - 161));
    const TDEE = (bmr, mult) => bmr*mult;
    const BSA = (kg, cm) => Math.sqrt((kg*cm)/3600);
    const LBM = (kg, cm, s) => (s==='male' ? (0.407*kg + 0.267*cm - 19.2) : (0.252*kg + 0.473*cm - 48.3));
    const FFMI = (lbmKg, cm) => lbmKg/Math.pow(toM(cm),2);
    const ABSI = (wc, bmi, cm) => { const w=wc/100, h=cm/100; return w/(Math.pow(bmi,2/3)*Math.pow(h,1/2)); };
    const idealWeightDevine = (cm, s) => { const inches=cm/2.54; const over5ft=Math.max(0,inches-60); return (s==='male'?50:45.5)+2.3*over5ft; };
    const healthyWeightRange = cm => { const m2=Math.pow(toM(cm),2); return {min:22*m2, max:25*m2}; };
    const WHR = (waistCm, hipCm) => waistCm/hipCm;
    const NavyBF = (s, waistCm, neckCm, hipCm, heightCm) => {
      const w = toIn(waistCm), n=toIn(neckCm), h=toIn(heightCm), hp = hipCm? toIn(hipCm):0;
      if(s==='male') return 86.010*Math.log10(w - n) - 70.041*Math.log10(h) + 36.76;
      return 163.205*Math.log10(w + hp - n) - 97.684*Math.log10(h) - 78.387;
    };

    function bpCategory(sys, dia){
      if(!sys||!dia) return ['â€”',''];
      if(sys>=180 || dia>=120) return ['Ø£Ø²Ù…Ø© Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ·','bad'];
      if(sys>=140 || dia>=90)  return ['Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· (Ø¯Ø±Ø¬Ø© 2)','bad'];
      if(sys>=130 || dia>=80)  return ['Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· (Ø¯Ø±Ø¬Ø© 1)','warn'];
      if(sys>=120 && dia<80)   return ['Ø¶ØºØ· Ù…Ø±ØªÙØ¹ (Ù…Ø³Ø¨Ù‚)','warn'];
      if(sys<120 && dia<80)    return ['Ø·Ø¨ÙŠØ¹ÙŠ','ok'];
      return ['â€”',''];
    }

    // â€”â€”â€” ØªÙˆØµÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© â€”â€”â€”
    function waterRecLiters(weightKg, activity){
      const base = Math.max(1.0, weightKg * 0.035);
      const extra = (activity>=1.9)?1.0 : (activity>=1.725)?0.8 : (activity>=1.55)?0.6 : (activity>=1.375)?0.35 : 0.0;
      const total = Math.min(5.0, Math.max(1.5, base + extra));
      return total;
    }
    function stepsRec(age, bmi, activity){
      let min=8000, max=10000, note='Ø¶Ù…Ù† Ù†Ù…Ø· ØµØ­ÙŠ Ø¹Ø§Ù…';
      if(age>=65){ min=6000; max=8000; note='Ù…Ù„Ø§Ø¦Ù… Ù„ÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù†'; }
      if(bmi>=30){ min=10000; max=12000; note='Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø®ÙØ¶ Ø§Ù„ÙˆØ²Ù†'; }
      else if(bmi>=25){ min=Math.max(min,9000); max=Math.max(max,11000); note='Ù„Ù„Ø­ÙØ§Ø¸/Ø®ÙØ¶ Ø¨Ø³ÙŠØ·'; }
      if(activity>=1.725){ min=Math.max(5000,min-1000); max=Math.max(7000,max-1000); }
      if(activity<=1.2){ min+=1000; max+=1000; }
      return {min, max, note};
    }
    function proteinRange(weightKg, age, bmi){
      let lo=1.2, hi=1.6; if(age>=65){ lo=1.2; hi=1.8; } if(bmi>=30){ lo=Math.max(lo,1.6); hi=2.2; }
      return {lo: Math.round(lo*weightKg), hi: Math.round(hi*weightKg)};
    }
    function sugarLimits(tdee){ const max10 = Math.round((0.10*tdee)/4); const ideal5 = Math.round((0.05*tdee)/4); return {max10, ideal5}; }
    function fiberTarget(tdee){ return Math.round(14*(tdee/1000)); }
    function activityGuide(activity){
      let level='Ù‚Ù„ÙŠÙ„/Ø®Ø§Ù…Ù„', weekly='Ø£Ù‚Ù„ Ù…Ù† 60 Ø¯Ù‚ÙŠÙ‚Ø©';
      if(activity>=1.375){ level='Ø®ÙÙŠÙ'; weekly='Ø­ÙˆØ§Ù„ÙŠ 60â€“150 Ø¯Ù‚ÙŠÙ‚Ø©/Ø£Ø³Ø¨ÙˆØ¹'; }
      if(activity>=1.55){ level='Ù…ØªÙˆØ³Ø·'; weekly='Ø­ÙˆØ§Ù„ÙŠ 150â€“300 Ø¯Ù‚ÙŠÙ‚Ø©/Ø£Ø³Ø¨ÙˆØ¹'; }
      if(activity>=1.725){ level='Ø¹Ø§Ù„Ù'; weekly='Ø£ÙƒØ«Ø± Ù…Ù† 300 Ø¯Ù‚ÙŠÙ‚Ø©/Ø£Ø³Ø¨ÙˆØ¹'; }
      if(activity>=1.9){ level='Ø¹Ø§Ù„Ù Ø¬Ø¯Ù‹Ø§'; weekly='Ù…Ø±ØªÙØ¹ Ø¬Ø¯Ù‹Ø§ (>300 Ø¯Ù‚ÙŠÙ‚Ø©)'; }
      return {level, weekly};
    }

    // Ø£Ø¯ÙˆØ§Øª Ø¹Ø±Ø¶ ÙˆØ³Ø¬Ù„
    const fmt = (x,d=2) => Number.isFinite(x)? x.toFixed(d) : 'â€”';
    const fmtInt = x => Number.isFinite(x)? Math.round(x).toLocaleString(): 'â€”';
    const fmtDate = (ts)=>{ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; };
    const loadHistory = ()=>{ try{ return JSON.parse(localStorage.getItem(HIST)||'[]'); }catch(e){ return []; } };
    const saveHistory = (arr)=> localStorage.setItem(HIST, JSON.stringify(arr));
    function addHistory(entry){ const arr=loadHistory(); arr.unshift(entry); saveHistory(arr); renderHistory(); }

    function render(){
      const a=+age.value, s=sex.value, h=+height.value, w=+weight.value, wc=+waist.value, am=+act.value;
      const hp=+hip.value, nk=+neck.value, SYS=+sbp.value, DIA=+dbp.value;
      if(!a||!h||!w||!wc){ kpis.innerHTML='<div class="kpi"><h3>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø£ÙˆÙ„Ù‹Ø§</h3><div class="detail">Ø§Ù„Ø¹Ù…Ø±ØŒ Ø§Ù„Ø¬Ù†Ø³ØŒ Ø§Ù„Ø·ÙˆÙ„ØŒ Ø§Ù„ÙˆØ²Ù†ØŒ Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ±</div></div>'; draw2D(null); stop3D(); return; }

      const bmi=BMI(w,h); const [bmiTxt,bmiCls]=BMIcat(bmi);
      const whtr=WHtR(wc,h); const [whtrTxt,whtrCls]=WHtRcat(whtr);
      const [wcTxt,wcCls]=waistRisk(s,wc);
      const bf=bodyFatDeurenberg(bmi,a,s);
      const bmr=BMR(w,h,a,s); const tdee=TDEE(bmr,am);
      const bsa=BSA(w,h);
      const lbm=LBM(w,h,s); const ffmi=FFMI(lbm,h);
      const absi=ABSI(wc,bmi,h);
      const iw=idealWeightDevine(h,s); const diff=w-iw;
      const {min:hwMin,max:hwMax}=healthyWeightRange(h);
      const bmiPrime=BMIPrime(bmi);
      const pi=PI(w,h);
      const whr = (hp? WHR(wc,hp): NaN);
      const navy = (nk && (s==='male' ? wc>nk : (wc && hp && nk))) ? NavyBF(s,wc,nk,hp,h) : NaN;
      const [bpTxt,bpCls]=bpCategory(SYS,DIA);

      // Ø¥Ø¶Ø§ÙÙŠØ§Øª Ù…Ù‚ØªØ±Ø­Ø©
      const water = waterRecLiters(w, am);
      const steps = stepsRec(a, bmi, am);
      const prot = proteinRange(w, a, bmi);
      const sugar = sugarLimits(tdee);
      const fiber = fiberTarget(tdee);
      const actG = activityGuide(am);
      const waistTargetMin = 0.42*h, waistTargetMax = 0.50*h;

      const ideal = { bmi:'18.5â€“24.9', whtr:'0.45â€“0.49 (Ø§Ù„Ø£ÙØ¶Ù„ < 0.50)', waistMale:'Ø­ØªÙ‰ 93 Ø³Ù…', waistFemale:'Ø­ØªÙ‰ 79 Ø³Ù…', bfpMale:'10â€“20%', bfpFemale:'20â€“30%', ffmiMale:'18â€“25', ffmiFemale:'15â€“22', prime:'0.80â€“1.00', pi:'11â€“14', whrMale:'0.80â€“0.90', whrFemale:'0.75â€“0.85', bp:'Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ 90â€“119 / Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ 60â€“79' };

      const ffmiRange = (s==='male')?[18,25]:[15,22]; const ffmiCls = ffmi<ffmiRange[0]?'warn':(ffmi>ffmiRange[1]?'warn':'ok');
      let primeCls='ok'; if(bmiPrime<0.8) primeCls='warn'; else if(bmiPrime>1.0&&bmiPrime<=1.2) primeCls='warn'; else if(bmiPrime>1.2) primeCls='bad';
      let piCls='ok'; if(pi<11||pi>14) piCls='warn';
      let hwCls='ok'; if(w<hwMin-3||w>hwMax+3) hwCls='bad'; else if(w<hwMin||w>hwMax) hwCls='warn';
      let whrCls = isFinite(whr)? ( (s==='male' ? (whr<=0.9?'ok':whr<=1?'warn':'bad') : (whr<=0.85?'ok':whr<=0.95?'warn':'bad')) ): '';
      let navyCls = isFinite(navy)? ((s==='male' ? (navy<=20?'ok':navy<=25?'warn':'bad') : (navy<=30?'ok':navy<=35?'warn':'bad'))): '';
      const waistTargetCls = (wc<=waistTargetMax && wc>=waistTargetMin)?'ok': (wc<=waistTargetMax+5?'warn':'bad');

      kpis.innerHTML = `
        <div class="kpi ${bmiCls}"><h3>Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù… (BMI)</h3><div class="value">${fmt(bmi)} ÙƒØ¬Ù…/Ù…Â²</div><div class="detail">ØªØµÙ†ÙŠÙ: ${bmiTxt} â€¢ <b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${ideal.bmi}</b></div></div>
        <div class="kpi ${whtrCls}"><h3>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµØ± Ù„Ù„Ø·ÙˆÙ„ (WHtR)</h3><div class="value">${fmt(whtr)}</div><div class="detail">${whtrTxt} â€¢ <b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${ideal.whtr}</b></div></div>
        <div class="kpi ${wcCls}"><h3>Ù…Ø­ÙŠØ· Ø§Ù„Ø®ØµØ± (Ø³Ù…)</h3><div class="value">${fmt(wc,0)} Ø³Ù…</div><div class="detail">${s==='male'?'Ù„Ù„Ø°ÙƒÙˆØ±':'Ù„Ù„Ø¥Ù†Ø§Ø«'}: ${wcTxt} â€¢ <b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${s==='male'?ideal.waistMale:ideal.waistFemale}</b></div></div>
        <div class="kpi"><h3>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† ÙÙŠ Ø§Ù„Ø¬Ø³Ù… % (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</h3><div class="value">${fmt(bf)}%</div><div class="detail"><b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${s==='male'?ideal.bfpMale:ideal.bfpFemale}</b></div></div>
        <div class="kpi ${ffmiCls}"><h3>Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªÙ„Ø© Ø§Ù„Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¯Ù‡ÙˆÙ† (FFMI)</h3><div class="value">${fmt(ffmi,2)}</div><div class="detail"><b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${s==='male'?ideal.ffmiMale:ideal.ffmiFemale}</b></div></div>
        <div class="kpi ${primeCls}"><h3>Ù…Ø¤Ø´Ø± BMI Prime</h3><div class="value">${fmt(bmiPrime,2)}</div><div class="detail"><b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${ideal.prime}</b> â€” (Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù… Ã· 25)</div></div>
        <div class="kpi ${piCls}"><h3>Ù…Ø¤Ø´Ø± Ø¨ÙˆÙ†Ø¯ÙŠØ±Ø§Ù„ (PI)</h3><div class="value">${fmt(pi,2)} ÙƒØ¬Ù…/Ù…Â³</div><div class="detail"><b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${ideal.pi}</b> â€” (Ø§Ù„ÙˆØ²Ù† Ã· Ø§Ù„Ø·ÙˆÙ„Â³)</div></div>
        <div class="kpi ${hwCls}"><h3>Ù†Ø·Ø§Ù‚ ÙˆØ²Ù† ØµØ­ÙŠ Ù„Ø·ÙˆÙ„Ùƒ</h3><div class="value">${fmt(hwMin,1)}â€“${fmt(hwMax,1)} ÙƒØ¬Ù…</div><div class="detail">ÙˆØ²Ù†Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${fmt(w,1)} ÙƒØ¬Ù…</div></div>
        <div class="kpi"><h3>Ø§Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ (Devine)</h3><div class="value">${fmt(iw,1)} ÙƒØ¬Ù…</div><div class="detail">ÙØ§Ø±Ù‚Ùƒ: ${diff>0?'+':''}${fmt(diff,1)} ÙƒØ¬Ù…</div></div>
        <div class="kpi ${waistTargetCls}"><h3>Ø®ØµØ± Ù…Ø³ØªÙ‡Ø¯Ù Ù…Ù† Ø§Ù„Ø·ÙˆÙ„</h3><div class="value">${fmt(waistTargetMin,0)}â€“${fmt(waistTargetMax,0)} Ø³Ù…</div><div class="detail">(0.42â€“0.50 Ã— Ø§Ù„Ø·ÙˆÙ„)</div></div>
        <div class="kpi ${whrCls}"><h3>Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµØ± Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ±Ùƒ (WHR)</h3><div class="value">${isFinite(whr)?fmt(whr,2):'â€”'}</div><div class="detail">${isFinite(whr)? `<b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${s==='male'?ideal.whrMale:ideal.whrFemale}</b>`: 'Ø£Ø¯Ø®Ù„ Ù…Ø­ÙŠØ· Ø§Ù„ÙˆØ±Ùƒ'}</div></div>
        <div class="kpi ${navyCls}"><h3>Ø¯Ù‡ÙˆÙ† Ø§Ù„Ø¬Ø³Ù… % (Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø­Ø±ÙŠØ©)</h3><div class="value">${isFinite(navy)?fmt(navy,1):'â€”'}</div><div class="detail">${isFinite(navy)? `<b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${s==='male'?ideal.bfpMale:ideal.bfpFemale}</b>`: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ø¨Ø© + (Ø§Ù„ÙˆØ±Ùƒ Ù„Ù„Ø¥Ù†Ø§Ø«)'}</div></div>
        <div class="kpi ${bpCls}"><h3>Ø¶ØºØ· Ø§Ù„Ø¯Ù… (ØªØµÙ†ÙŠÙ)</h3><div class="value">${(SYS&&DIA)? `${fmt(SYS,0)}/${fmt(DIA,0)}`:'â€”'} mmHg</div><div class="detail">${(SYS&&DIA)? bpTxt : 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡ØªÙŠÙ†'} â€¢ <b>Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: ${ideal.bp}</b></div></div>
        <div class="kpi"><h3>Ø³Ø¹Ø±Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (TDEE)</h3><div class="value">â‰ˆ ${fmt(tdee,0)} Ø³Ø¹Ø±Ø©/ÙŠÙˆÙ…</div><div class="detail">Ø®Ø³Ø§Ø±Ø© ØµØ­ÙŠØ©: âˆ’10% Ø¥Ù„Ù‰ âˆ’20% â‡’ ${fmt(tdee*0.9,0)}â€“${fmt(tdee*0.8,0)}</div></div>
        <div class="kpi"><h3>Ø§Ù„Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­</h3><div class="value">â‰ˆ ${fmt(water,1)} Ù„ØªØ±/ÙŠÙˆÙ…</div><div class="detail">ØªÙ‚Ø¯ÙŠØ±ÙŠ Ø­Ø³Ø¨ ÙˆØ²Ù†Ùƒ ÙˆÙ†Ø´Ø§Ø·Ùƒ (Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ù…Ø¹ØªØ§Ø¯ 1.5â€“5 Ù„ØªØ±)</div></div>
        ${(()=>{ const st=steps; return `<div class=\"kpi\"><h3>Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© ÙŠÙˆÙ…ÙŠÙ‹Ø§</h3><div class=\"value\">${st.min.toLocaleString()}â€“${st.max.toLocaleString()} Ø®Ø·ÙˆØ©</div><div class=\"detail\">${st.note}</div></div>`; })()}
        ${(()=>{ const pr=prot; return `<div class=\"kpi\"><h3>Ø§Ø­ØªÙŠØ§Ø¬ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3><div class=\"value\">${pr.lo}â€“${pr.hi} Øº/ÙŠÙˆÙ…</div><div class=\"detail\">${(bmi>=30)?'Ù…Ø±ÙÙˆØ¹ Ù„ÙˆØ²Ù† Ø²Ø§Ø¦Ø¯/Ø³Ù…Ù†Ø©':'Ù†Ø·Ø§Ù‚ Ø¹Ø§Ù…ØŒ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·'}</div></div>`; })()}
        ${(()=>{ const sg=sugar; return `<div class=\"kpi\"><h3>Ø§Ù„Ø³ÙƒØ± Ø§Ù„Ø­Ø±Ù‘ (Ø­Ø¯ Ø£Ù‚ØµÙ‰)</h3><div class=\"value\">â‰¤ ${sg.max10} Øº/ÙŠÙˆÙ…</div><div class=\"detail\">Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ: â‰¤ ${sg.ideal5} Øº/ÙŠÙˆÙ… (5% Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª)</div></div>`; })()}
        <div class="kpi"><h3>Ø§Ù„Ø£Ù„ÙŠØ§Ù Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©</h3><div class="value">â‰ˆ ${fmtInt(fiber)} Øº/ÙŠÙˆÙ…</div><div class="detail">â‰ˆ 14 Øº Ù„ÙƒÙ„ 1000 Ø³Ø¹Ø±Ø©</div></div>
        <div class="kpi"><h3>Ù…Ø³Ø§Ø­Ø© Ø³Ø·Ø­ Ø§Ù„Ø¬Ø³Ù… (BSA)</h3><div class="value">${fmt(bsa,2)} Ù…Â²</div><div class="detail">Mosteller â€” Ù„Ù„Ø¹Ù„Ù… ÙÙ‚Ø·</div></div>
        <div class="kpi"><h3>ABSI (ÙˆØµÙ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ù‡ÙˆÙ†)</h3><div class="value">${fmt(absi,4)}</div><div class="detail">Ù‚ÙŠÙ…Ø© Ø£Ø¹Ù„Ù‰ Ù‚Ø¯ ØªØ¹Ù†ÙŠ ØªÙ…Ø±ÙƒØ² Ø¯Ù‡ÙˆÙ† Ø­ÙˆÙ„ Ø§Ù„Ø®ØµØ±</div></div>
        <div class="kpi"><h3>Ù†Ø´Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</h3><div class="value">${actG.level}</div><div class="detail">${actG.weekly} â€¢ Ø§Ù„Ù‡Ø¯Ù: 150â€“300 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹ØªØ¯Ù„ Ø£Ùˆ 75â€“150 Ø´Ø¯ÙŠØ¯/Ø£Ø³Ø¨ÙˆØ¹</div></div>
      `;

      // Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®ØªØµØ±
      addHistory({ts: Date.now(), a, s, h, w, wc, bmi, bmiTxt, whtr});

      draw2D({sex:s, height:h, bmi, whtr, waist:wc});
      if(enable3d.checked){ start3D(s, bmi, whtr); } else { stop3D(); }
    }

    // Ø£Ø²Ø±Ø§Ø±
    $('#calc').addEventListener('click', ()=>{ render(); saveInputs(); });
    $('#reset').addEventListener('click', ()=>{ age.value=''; height.value=''; weight.value=''; waist.value=''; hip.value=''; neck.value=''; sbp.value=''; dbp.value=''; kpis.innerHTML='<div class="kpi"><h3>Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø«Ù… Ø§Ø¶ØºØ· Â«Ø§Ø­Ø³Ø¨ Ø§Ù„Ø¢Ù†Â»</h3></div>'; draw2D(null); stop3D(); saveInputs(); });

    loadInputs();
    renderHistory();
    fetchWeather();

    // ===== Ø§Ù„ØªØµÙˆÙ‘Ø± 2D (SVG) =====
    function draw2D(state){
      const svg=document.getElementById('bodyViz'); if(!svg) return; if(!state){ svg.innerHTML='<rect x="0" y="0" width="200" height="420" fill="none"/>'; return; }
      const {sex,bmi,whtr}=state; const base={shoulderW:120,chestW:110,waistW:70,hipW:105,torsoH:190,legH:170,headR:28};
      const sexAdj=(sex==='male')?{shoulder:1.06,hip:0.95}:{shoulder:0.92,hip:1.06};
      const bmiNorm=Math.max(16,Math.min(40,bmi)); const bmiScale=1+(bmiNorm-22)/40; const waistScale=Math.max(0.8,Math.min(1.6,whtr/0.5));
      const shoulderW=base.shoulderW*sexAdj.shoulder*(0.9+(bmiScale-1)*0.5);
      const chestW=base.chestW*(0.9+(bmiScale-1)*0.6);
      const waistW=base.waistW*waistScale;
      const hipW=base.hipW*sexAdj.hip*(0.9+(bmiScale-1)*0.5);
      const riskColor=(whtr>=0.6)?'#dc2626':(whtr>=0.5?'#d97706':'#16a34a');
      const stroke='#94a3b8'; const fillTorso='url(#gradTorso)'; const cx=100; let y=10;
      svg.innerHTML=`
        <defs>
          <linearGradient id="gradTorso" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#e2e8f0"/>
            <stop offset="100%" stop-color="#cbd5e1"/>
          </linearGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#000" flood-opacity="0.08"/></filter>
        </defs>
        <circle cx="${cx}" cy="${y+base.headR}" r="${base.headR}" fill="#e2e8f0" stroke="#cbd5e1"/>
        ${(()=>{y+=base.headR*2+6;return''})()}
        <path d="M ${cx-shoulderW/2} ${y} C ${cx-shoulderW/2} ${y-10}, ${cx+shoulderW/2} ${y-10}, ${cx+shoulderW/2} ${y} L ${cx+chestW/2} ${y+base.torsoH*0.35} C ${cx+chestW*0.2} ${y+base.torsoH*0.45}, ${cx-chestW*0.2} ${y+base.torsoH*0.45}, ${cx-chestW/2} ${y+base.torsoH*0.35} Z" fill="${fillTorso}" stroke="#cbd5e1" filter="url(#glow)"/>
      `;
      const wy=y+base.torsoH*0.35, wy2=wy+base.torsoH*0.25, hy=y+base.torsoH*0.65, hy2=hy+base.torsoH*0.22;
      svg.innerHTML+=`
        <path d="M ${cx-chestW/2} ${wy} C ${cx-waistW/2} ${wy2}, ${cx+waistW/2} ${wy2}, ${cx+chestW/2} ${wy} Z" fill="${fillTorso}" stroke="#cbd5e1"/>
        <path d="M ${cx-waistW/2} ${hy} C ${cx-hipW/2} ${hy2}, ${cx+hipW/2} ${hy2}, ${cx+waistW/2} ${hy} Z" fill="${fillTorso}" stroke="#cbd5e1"/>
      `;
      const yLeg=10+base.headR*2+6+base.torsoH+10;
      svg.innerHTML+=`
        <path d="M ${cx-hipW*0.25} ${yLeg} L ${cx-hipW*0.15} ${yLeg+base.legH}" stroke="#cbd5e1" stroke-width="8"/>
        <path d="M ${cx+hipW*0.25} ${yLeg} L ${cx+hipW*0.15} ${yLeg+base.legH}" stroke="#cbd5e1" stroke-width="8"/>
        <ellipse cx="${cx}" cy="${10+base.headR*2+6+base.torsoH*0.55}" rx="${Math.max(waistW/2,20)}" ry="14" fill="none" stroke="${riskColor}" stroke-width="3" opacity="0.9"/>
      `;
    }

    // ===== Ù†Ù…ÙˆØ°Ø¬ 3D Canvas =====
    const enable3d=$('#enable3d'); const canvas3d=$('#body3d'); const ctx3d=canvas3d.getContext('2d'); const viz3d=$('#viz3d');
    let rafId=null, yaw=0, profile=null;
    enable3d.addEventListener('change', ()=>{ if(enable3d.checked){ viz3d.style.display='flex'; const h=+height.value||0, w=+weight.value||0, wc=+waist.value||0; start3D(sex.value, BMI(w,h), WHtR(wc,h)); } else { stop3D(); } });

    function makeProfile(sex,bmi,whtr){
      const pts=[]; const baseShoulder=(sex==='male'?0.58:0.50)*(1+(bmi-22)/60); const baseChest=(sex==='male'?0.55:0.52)*(1+(bmi-22)/50); const baseWaist=0.36*Math.max(0.8,Math.min(1.6,whtr/0.5)); const baseHip=(sex==='male'?0.50:0.58)*(1+(bmi-22)/60);
      for(let i=0;i<=40;i++){ const t=i/40; const chestBlend=Math.max(0,1-Math.abs(t-0.2)/0.25); const waistBlend=Math.max(0,1-Math.abs(t-0.5)/0.18); const hipBlend=Math.max(0,1-Math.abs(t-0.8)/0.22); let r=0; r+=baseChest*chestBlend; r+=baseWaist*waistBlend; r+=baseHip*hipBlend; r=Math.max(r, baseShoulder*Math.max(0,1-Math.abs(t-0.05)/0.18)); pts.push({y:t,r}); } return pts; }

    function start3D(sex,bmi,whtr){ profile=makeProfile(sex,bmi,whtr); if(rafId) cancelAnimationFrame(rafId); yaw=0; viz3d.style.display='flex'; loop3D(); }
    function stop3D(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; viz3d.style.display='none'; }

    function loop3D(){
      const W=canvas3d.width, H=canvas3d.height; ctx3d.clearRect(0,0,W,H); const cx=W/2, cy=H*0.48; const scale=Math.min(W,H)*0.42; yaw+=0.02; const light={x:Math.cos(yaw+1), y:-0.2, z:Math.sin(yaw+1)}; const slices=60;
      for(let i=0;i<profile.length-1;i++){ const y1=cy+(profile[i].y-0.5)*scale*1.4; const y2=cy+(profile[i+1].y-0.5)*scale*1.4; for(let j=0;j<slices;j++){ const a1=(j/slices)*Math.PI*2+yaw; const a2=((j+1)/slices)*Math.PI*2+yaw; const r1=profile[i].r*scale; const r2=profile[i+1].r*scale; const x11=cx+Math.cos(a1)*r1*0.7; const x12=cx+Math.cos(a2)*r1*0.7; const x21=cx+Math.cos(a1)*r2*0.7; const x22=cx+Math.cos(a2)*r2*0.7; const nx=(Math.cos(a1)+Math.cos(a2))/2; const nz=(Math.sin(a1)+Math.sin(a2))/2; const ny=(y2-y1)/scale; const ndotl=Math.max(0.05,(nx*light.x+ny*light.y+nz*light.z)); const shade=Math.floor(160+65*ndotl); ctx3d.fillStyle=`rgb(${shade}, ${shade+12}, ${shade+20})`; ctx3d.beginPath(); ctx3d.moveTo(x11,y1); ctx3d.lineTo(x12,y1); ctx3d.lineTo(x22,y2); ctx3d.lineTo(x21,y2); ctx3d.closePath(); ctx3d.fill(); } }
      const whtr=WHtR(+waist.value||0, +height.value||0); const riskColor=(whtr>=0.6)?'#dc2626':(whtr>=0.5?'#d97706':'#16a34a'); ctx3d.strokeStyle=riskColor; ctx3d.lineWidth=3; const waistIdx=Math.floor(profile.length*0.5); const rr=profile[waistIdx].r*scale*0.7; ctx3d.beginPath(); ctx3d.ellipse(cx,cy,rr,rr*0.35,0,0,Math.PI*2); ctx3d.stroke(); rafId=requestAnimationFrame(loop3D);
    }

    function renderHistory(){
      const wrap=document.getElementById('history'); if(!wrap) return; const arr=loadHistory();
      if(arr.length===0){ wrap.innerHTML = '<div class="hcell" style="opacity:.8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯ â€” Ø§Ø­Ø³Ø¨ Ø£ÙˆÙ„Ø§Ù‹ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‡Ù†Ø§.</div>'; return; }
      let html = '';
      html += `<div class="hrow hhead"><div class="hcell">Ø§Ù„ØªØ§Ø±ÙŠØ®</div><div class="hcell">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</div><div class="hcell">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</div><div class="hcell">Ø§Ù„Ø®ØµØ± (Ø³Ù…)</div><div class="hcell">Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªÙ„Ø© BMI</div><div class="hcell">WHtR</div><div class="hcell"></div></div>`;
      arr.forEach((r,i)=>{
        html += `<div class=\"hrow\"><div class=\"hcell\">${fmtDate(r.ts)}</div><div class=\"hcell\">${fmt(r.w,1)}</div><div class=\"hcell\">${fmt(r.h,0)}</div><div class=\"hcell\">${fmt(r.wc,0)}</div><div class=\"hcell\">${fmt(r.bmi,1)} <small>(${r.bmiTxt})</small></div><div class=\"hcell\">${fmt(r.whtr,2)}</div><div class=\"hcell\"><button class=\"del\" data-i=\"${i}\" title=\"Ø­Ø°Ù\">Ã—</button></div></div>`;
      });
      wrap.innerHTML = html;
      wrap.querySelectorAll('.del').forEach(btn=> btn.addEventListener('click', (e)=>{ const idx=+e.currentTarget.dataset.i; const arr=loadHistory(); arr.splice(idx,1); saveHistory(arr); renderHistory(); }));
    }

    // Ø£Ø²Ø±Ø§Ø± Ø¹Ø§Ù…Ø©
    const btnTop = document.getElementById('scrollTop');
    window.addEventListener('scroll',()=>{ btnTop.style.display = (window.scrollY>200)?'inline-flex':'none'; });
    btnTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    document.getElementById('clearHistory').addEventListener('click', ()=>{ localStorage.removeItem(HIST); renderHistory(); });
    
    const THEME_KEY='health:theme:v1';
    function setTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      try{ localStorage.setItem(THEME_KEY, t); }catch(e){}
      const sel=document.getElementById('themeSelect'); if(sel && sel.value!==t) sel.value=t;
    }
    (function(){
      const saved = (localStorage.getItem(THEME_KEY)||'morning');
      setTheme(saved);
      const sel=document.getElementById('themeSelect');
      if(sel){ sel.value=saved; sel.addEventListener('change', ()=> setTheme(sel.value)); }
    })();
  </script>
</body>
</html>
