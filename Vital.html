<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حاسبة المؤشرات الصحية — مع سجل القياسات</title>
  <style>
    /* ————— نمط صباحي مشرق (الخيار رقم 2) ————— */
    :root{
      --bg1:#e0f2fe; /* صباحي افتراضي */
      --bg2:#ede9fe;
      --panel:#ffffff;
      --border:rgba(2, 6, 23, .08);
      --muted:#334155;
      --text:#0f172a;
      --accent:#818cf8;
      --accent2:#38bdf8;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --radius:18px; --shadow:0 10px 30px rgba(2,6,23,.10)
    }
    /* —— أنماط السمات —— */
    html[data-theme="day"]{
      /* نهاري دافئ ومشرق (مختلف بوضوح عن الصباحي الأزرق/لافندر) */
      --bg1:#fff7ed; /* برتقالي فاتح جدًا */
      --bg2:#ffedd5; /* خوخي باهت */
      --panel:#ffffff;
      --border:rgba(2,6,23,.08);
      --text:#0f172a;
      --muted:#6b7280;
      --accent:#f59e0b; /* أمبر */
      --accent2:#f97316; /* برتقالي */
    }
    html[data-theme="morning"]{
      --bg1:#e0f2fe; --bg2:#ede9fe; --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#0f172a; --muted:#334155; --accent:#818cf8; --accent2:#38bdf8;
    }
    html[data-theme="dark"]{
      --bg1:#0b1220; --bg2:#111827; --panel:#0b1220; --border:rgba(255,255,255,.10);
      --text:#e2e8f0; --muted:#cbd5e1; --accent:#a78bfa; --accent2:#22d3ee;
    }
    /* ——— أنماط إضافية ——— */
    html[data-theme="nature"]{
      --bg1:#ecfccb; /* أخضر ليموني فاتح */
      --bg2:#d9f99d; /* أخضر عشبي فاتح */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#052e16; --muted:#166534; --accent:#22c55e; --accent2:#4ade80;
    }
    html[data-theme="sunset"]{
      --bg1:#fce7f3; /* وردي فاتح */
      --bg2:#fde68a; /* أصفر غروب */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#3f1d2e; --muted:#7c2d12; --accent:#f472b6; --accent2:#fb923c;
    }
    html[data-theme="ice"]{
      --bg1:#e0f2fe; /* أزرق ثلجي */
      --bg2:#f0f9ff; /* سماوي باهت */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#0c4a6e; --muted:#0369a1; --accent:#38bdf8; --accent2:#7dd3fc;
    }
    html[data-theme="neon"]{
      --bg1:#080b12; --bg2:#0f172a; --panel:#0b1220; --border:rgba(255,255,255,.12);
      --text:#e5e7eb; --muted:#a5b4fc; --accent:#22d3ee; --accent2:#a78bfa; /* ألوان نيون */
    }
    html[data-theme="cosmic"]{
      --bg1:#1f1d2b; --bg2:#111827; --panel:#141624; --border:rgba(255,255,255,.10);
      --text:#e2e8f0; --muted:#c7d2fe; --accent:#8b5cf6; --accent2:#06b6d4;
    }
    html[data-theme="blossom"]{
      --bg1:#ffe4e6; /* وردي باهت */
      --bg2:#ede9fe; /* لافندر فاتح */
      --panel:#ffffff; --border:rgba(2,6,23,.08);
      --text:#4a044e; --muted:#7e22ce; --accent:#f9a8d4; --accent2:#c084fc;
    }
    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif; min-height:100vh; padding:18px 18px 90px; transition:background .35s ease, color .35s ease}
    .card, .viz, .viz3d, .kpi, .weather{ transition: background .35s ease, border-color .35s ease, color .35s ease }
    .app{width:min(1200px,100%); margin:0 auto}
    h1{margin:0 0 6px; font-size:clamp(20px,2.8vw,28px)}
    p.subtitle{margin:0 0 14px; color:var(--muted); font-size:14px}

    .grid{display:grid; grid-template-columns:.95fr 1.05fr; gap:16px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:700px){ .row{grid-template-columns:1fr} }
    label{font-size:14px; color:var(--muted)}
    input,select{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(2,6,23,.12); background:#f8fafc; color:var(--text); outline:none}
    html[data-theme="dark"] input, html[data-theme="dark"] select { background:#0f172a; border-color:rgba(255,255,255,.16); color:#e2e8f0 }
    html[data-theme="dark"] .kpi{ background:#0b1220; border-color:rgba(255,255,255,.12) }
    html[data-theme="dark"] .weather{ background:rgba(17,24,39,.7); border-color:rgba(255,255,255,.1) }
    html[data-theme="dark"] .w-chip{ background:#0f172a; border-color:rgba(255,255,255,.12) }

    .btn{cursor:pointer; border:none; border-radius:999px; padding:10px 16px; font-weight:700; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1220; display:inline-flex; align-items:center; gap:8px; box-shadow:0 6px 16px rgba(2,6,23,.12)}
    .ghost{background:transparent; color:var(--text); border:1px solid rgba(2,6,23,.18)}
    html[data-theme="dark"] .ghost{ border-color: rgba(255,255,255,.22) }
    .themebtn.active{ box-shadow:0 0 0 2px var(--accent) inset; }
    .ghost{background:transparent; color:var(--text); border:1px solid rgba(2,6,23,.18)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .kpis{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px}
    @media (max-width:900px){ .kpis{grid-template-columns:1fr} }
    .kpi{background:#ffffff; border:1px solid var(--border); border-radius:14px; padding:10px}
    .kpi h3{margin:0 0 4px; font-size:15px}
    .kpi .value{font-size:22px; font-weight:900}
    .kpi .detail{color:var(--muted); font-size:12px}
    .ok{border-color:rgba(22,163,74,.4)} .warn{border-color:rgba(217,119,6,.5)} .bad{border-color:rgba(220,38,38,.55)}

    .section-title{font-weight:700; margin:10px 0 6px; font-size:14px; color:var(--muted)}
    .viz,.viz3d{background:#ffffff; border:1px solid var(--border); border-radius:14px; padding:10px; display:flex; align-items:center; justify-content:center}
    .viz svg{width:100%; height:auto; max-height:360px}
    #body3d{width:100%; height:360px; display:block}
    .toggle{display:flex; align-items:center; gap:8px; color:var(--muted); font-size:14px; margin-top:10px}
    .foot{color:var(--muted); font-size:12px; margin-top:8px}

    /* شريط الطقس */
    .weather{display:flex; align-items:center; gap:12px; padding:10px 12px; background:rgba(255,255,255,.75); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow)}
    .w-main{display:flex; align-items:center; gap:10px}
    .w-icon{font-size:26px}
    .w-city{font-weight:800}
    .w-meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--text)}
    .w-chip{background:#f1f5f9; border:1px solid rgba(2,6,23,.08); padding:4px 8px; border-radius:999px; font-size:12px}

    /* سجل القياسات */
    .history{display:grid; gap:10px}
    .hrow{display:grid; grid-template-columns: 130px 1fr 1fr 1fr 1fr 1fr auto; gap:8px; align-items:center; border:1px solid var(--border); border-radius:10px; padding:8px; background:#ffffff}
    .hhead{font-weight:800; color:#0f172a; background:rgba(2,6,23,.04)}
    .hcell{font-size:13px; color:#0f172a}
    .hcell small{color:#475569}
    .del{border:none; background:transparent; color:#b91c1c; cursor:pointer; font-weight:900; font-size:16px}
  .select-wrap{ position:relative; display:inline-flex; align-items:center; }
    #themeSelect{ appearance:none; -moz-appearance:none; -webkit-appearance:none; padding:10px 36px 10px 12px; border-radius:999px; border:1px solid var(--border); background:var(--panel); color:var(--text); font-weight:700; box-shadow:0 6px 16px rgba(2,6,23,.06) }
    .chev{ position:absolute; right:10px; pointer-events:none; color:var(--muted); font-weight:900 }
    html[data-theme="dark"] #themeSelect{ background:#0f172a; color:#e2e8f0; border-color:rgba(255,255,255,.16) }
  </style>
</head>
<body>
  <div class="app">
    <h1>🩺 حاسبة المؤشرات الصحية — مع سجل القياسات</h1>
    <!-- شريط اختيار النمط (قائمة منسدلة) -->
    <div class="themebar" style="display:flex; gap:10px; align-items:center; margin:8px 0 12px">
      <span style="font-size:13px; color:var(--muted)">اختيار النمط:</span>
      <div class="select-wrap">
        <select id="themeSelect" aria-label="اختيار النمط">
          <option value="day">نهاري</option>
          <option value="morning">صباحي مشرق</option>
          <option value="dark">داكن حيوي</option>
          <option value="nature">طبيعي (أخضر)</option>
          <option value="sunset">غروب</option>
          <option value="ice">ثلجي</option>
          <option value="neon">نيون داكن</option>
          <option value="cosmic">فضائي</option>
          <option value="blossom">زهري</option>
        </select>
        <span class="chev">▾</span>
      </div>
    </div>
    <p class="subtitle">أدخل بياناتك (العمر، الجنس، الطول، الوزن، محيط الخصر). النتائج بالعربية مع "النطاق المثالي" لكل مؤشر. كل البيانات محفوظة محليًا على جهازك.</p>

    <!-- شريط الطقس اللحظي -->
    <div id="weatherBar" class="weather" aria-live="polite" style="margin:12px 0; display:none">
      <div class="w-main">
        <div class="w-icon" id="wIcon">☀️</div>
        <div>
          <div class="w-city" id="wCity">—</div>
          <div class="w-meta">
            <span class="w-chip" id="wTemp">—°C</span>
            <span class="w-chip" id="wCloud">غيوم —%</span>
            <span class="w-chip" id="wUV">UV —</span>
            <span class="w-chip" id="wSuit">الجو: —</span>
          </div>
        </div>
      </div>
      <button class="btn ghost" id="refreshWx" title="تحديث">تحديث</button>
    </div>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div>
            <label>العمر (سنة)</label>
            <input id="age" type="number" min="5" max="120" placeholder="مثال: 35" />
          </div>
          <div>
            <label>الجنس</label>
            <select id="sex">
              <option value="male">ذكر</option>
              <option value="female">أنثى</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>الطول (سم)</label>
            <input id="height" type="number" min="80" max="250" placeholder="مثال: 175" />
          </div>
          <div>
            <label>الوزن (كجم)</label>
            <input id="weight" type="number" min="20" max="400" placeholder="مثال: 80" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>محيط الخصر (سم)</label>
            <input id="waist" type="number" min="30" max="200" placeholder="مثال: 92" />
          </div>
          <div>
            <label>النشاط (لـ TDEE)</label>
            <select id="activity">
              <option value="1.2">قليل الحركة</option>
              <option value="1.375">نشاط خفيف (1–3 أيام/أسبوع)</option>
              <option value="1.55">نشاط متوسط (3–5 أيام/أسبوع)</option>
              <option value="1.725">نشاط عالٍ (6–7 أيام/أسبوع)</option>
              <option value="1.9">نشاط عالٍ جدًا / عمل بدني</option>
            </select>
          </div>
        </div>
        <div class="section-title">قياسات اختيارية لمؤشرات إضافية</div>
        <div class="row">
          <div>
            <label>محيط الورك (سم) — لاحتساب نسبة الخصر/الورك</label>
            <input id="hip" type="number" min="40" max="220" placeholder="اختياري" />
          </div>
          <div>
            <label>محيط الرقبة (سم) — لطريقة البحرية للدهون</label>
            <input id="neck" type="number" min="20" max="70" placeholder="اختياري" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label>ضغط الدم الانقباضي (أعلى) mmHg</label>
            <input id="sbp" type="number" min="70" max="240" placeholder="اختياري" />
          </div>
          <div>
            <label>ضغط الدم الانبساطي (أدنى) mmHg</label>
            <input id="dbp" type="number" min="40" max="140" placeholder="اختياري" />
          </div>
        </div>
        <div class="actions" style="margin-top:10px">
          <button class="btn" id="calc">احسب الآن</button>
          <button class="btn ghost" id="reset">مسح المدخلات</button>
        </div>
        <p class="foot">تنبيه: النتائج تقديرية ولا تُغني عن التقييم الطبي.</p>
      </div>

      <div class="card">
        <div class="kpis" id="kpis"><div class="kpi"><h3>أدخل القيم ثم اضغط «احسب الآن»</h3><div class="detail">ستظهر هنا النتائج مع النطاق المثالي لكل مؤشر.</div></div></div>
        <div class="section-title">تصوّر ثنائي الأبعاد (استرشادي)</div>
        <div class="viz"><svg id="bodyViz" viewBox="0 0 200 420" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="200" height="420" fill="none"/></svg></div>
        <label class="toggle"><input type="checkbox" id="enable3d"> عرض نموذج 3D متحرك</label>
        <div class="viz3d" id="viz3d" style="display:none"><canvas id="body3d" width="640" height="360"></canvas></div>
        <p class="foot">التلوين: <span style="color:#16a34a">جيد</span> • <span style="color:#d97706">حدّي/متوسط</span> • <span style="color:#dc2626">مرتفع</span>.</p>
      </div>
    </div>

    <!-- قسم القياسات السابقة -->
    <div class="card" id="historyCard" style="margin-top:16px">
      <div class="section-title">القياسات السابقة (محفوظة محليًا على جهازك)</div>
      <div class="actions" style="margin-bottom:8px">
        <button class="btn ghost" id="clearHistory">مسح كل السجلات</button>
      </div>
      <div id="history" class="history"></div>
      <p class="foot">لا يتم رفع أي بيانات — كل المعلومات محفوظة داخل متصفحك فقط.</p>
    </div>
  </div>
  
  <!-- زر العودة للأعلى -->
  <button id="scrollTop" aria-label="العودة لأعلى" style="position:fixed; inset:auto 16px 16px auto; z-index:50; display:none; border:none; border-radius:999px; padding:10px 14px; font-weight:800; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1220; box-shadow:0 8px 20px rgba(2,6,23,.18); cursor:pointer">▲ أعلى</button>

  <script>
    // عناصر
    const $ = s=>document.querySelector(s);
    const age=$('#age'), sex=$('#sex'), height=$('#height'), weight=$('#weight'), waist=$('#waist'), act=$('#activity');
    const hip=$('#hip'), neck=$('#neck'), sbp=$('#sbp'), dbp=$('#dbp');
    const kpis=$('#kpis');

    // تخزين محلي
    const LS='health:inputs:v4';
    const HIST='health:history:v3';
    function saveInputs(){ localStorage.setItem(LS, JSON.stringify({age:age.value, sex:sex.value, height:height.value, weight:weight.value, waist:waist.value, act:act.value, hip:hip.value, neck:neck.value, sbp:sbp.value, dbp:dbp.value})); }
    function loadInputs(){ try{ const d=JSON.parse(localStorage.getItem(LS)||'{}'); Object.entries(d).forEach(([k,v])=>{ const el={age,sex,height,weight,waist,act,hip,neck,sbp,dbp}[k]; if(el) el.value=v; }); }catch(e){} }

    // ——— شريط الطقس (Open-Meteo + Geolocation) ———
    async function fetchWeather(){
      const bar=$('#weatherBar'); const icon=$('#wIcon'); const city=$('#wCity'); const wTemp=$('#wTemp'); const wCloud=$('#wCloud'); const wUV=$('#wUV'); const wSuit=$('#wSuit');
      const fallback={lat:24.7136, lon:46.6753, name:'الرياض'}; // افتراضي: الرياض
      function pickIcon(isDay, cloud){
        if(!isDay) return '🌙';
        if(cloud<20) return '☀️';
        if(cloud<70) return '⛅';
        return '☁️';
      }
      function suitability(temp, uv, cloud){
        let ok=true, note='مناسب للخروج';
        if(temp<18 || temp>38) ok=false;
        if(uv>=8) ok=false; // UV عالٍ
        if(!ok) note='يتطلّب احتياطات';
        return note;
      }
      async function doFetch(lat,lon,label){
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,cloud_cover,uv_index,is_day&timezone=Asia%2FRiyadh`;
        const r=await fetch(url); const j=await r.json(); const c=j.current||{};
        icon.textContent=pickIcon(c.is_day, c.cloud_cover??0);
        city.textContent=label||'موقعك';
        wTemp.textContent=`${Math.round(c.temperature_2m)}°C`;
        wCloud.textContent=`غيوم ${c.cloud_cover??0}%`;
        wUV.textContent=`UV ${c.uv_index??0}`;
        wSuit.textContent=suitability(c.temperature_2m, c.uv_index, c.cloud_cover);
        bar.style.display='flex';
      }
      try{
        const pos = await new Promise((res,rej)=> navigator.geolocation ? navigator.geolocation.getCurrentPosition(res,rej,{timeout:6000, enableHighAccuracy:false}) : rej('no geo'));
        await doFetch(pos.coords.latitude, pos.coords.longitude, 'موقعك');
      }catch(e){
        await doFetch(fallback.lat, fallback.lon, fallback.name);
      }
    }

    $('#refreshWx').addEventListener('click', fetchWeather);

    // ——— دوال الحساب الأساسية ———
    const toM = cm => Number(cm)/100; const toIn = cm => Number(cm)/2.54;
    const BMI = (kg, cm) => kg/Math.pow(toM(cm),2);
    const BMIcat = b => (b<18.5?['نحافة','warn']: b<25?['طبيعي','ok']: b<30?['زيادة وزن','warn']: b<35?['سمنة (1)','bad']: b<40?['سمنة (2)','bad']: ['سمنة (3)','bad']);
    const BMIPrime = bmi => bmi/25; // (BMI/25)
    const PI = (kg, cm) => kg/Math.pow(toM(cm),3);
    const WHtR = (wc, h) => wc/h;
    const WHtRcat = x => (x<0.45?['ممتاز','ok']: x<0.5?['صحي','ok']: x<0.55?['حدّي','warn']: x<0.6?['مرتفع','warn']: ['مرتفع جدًا','bad']);
    const waistRisk = (s,wc) => (s==='male' ? (wc>=102?['مرتفع','bad']: wc>=94?['حدّي','warn']: ['طبيعي','ok']) : (wc>=88?['مرتفع','bad']: wc>=80?['حدّي','warn']: ['طبيعي','ok']) );
    const bodyFatDeurenberg = (bmi, a, s) => 1.20*bmi + 0.23*a - 10.8*(s==='male'?1:0) - 5.4;
    const BMR = (kg, cm, a, s) => (s==='male'? (10*kg + 6.25*cm - 5*a + 5) : (10*kg + 6.25*cm - 5*a - 161));
    const TDEE = (bmr, mult) => bmr*mult;
    const BSA = (kg, cm) => Math.sqrt((kg*cm)/3600);
    const LBM = (kg, cm, s) => (s==='male' ? (0.407*kg + 0.267*cm - 19.2) : (0.252*kg + 0.473*cm - 48.3));
    const FFMI = (lbmKg, cm) => lbmKg/Math.pow(toM(cm),2);
    const ABSI = (wc, bmi, cm) => { const w=wc/100, h=cm/100; return w/(Math.pow(bmi,2/3)*Math.pow(h,1/2)); };
    const idealWeightDevine = (cm, s) => { const inches=cm/2.54; const over5ft=Math.max(0,inches-60); return (s==='male'?50:45.5)+2.3*over5ft; };
    const healthyWeightRange = cm => { const m2=Math.pow(toM(cm),2); return {min:22*m2, max:25*m2}; };
    const WHR = (waistCm, hipCm) => waistCm/hipCm;
    const NavyBF = (s, waistCm, neckCm, hipCm, heightCm) => {
      const w = toIn(waistCm), n=toIn(neckCm), h=toIn(heightCm), hp = hipCm? toIn(hipCm):0;
      if(s==='male') return 86.010*Math.log10(w - n) - 70.041*Math.log10(h) + 36.76;
      return 163.205*Math.log10(w + hp - n) - 97.684*Math.log10(h) - 78.387;
    };

    function bpCategory(sys, dia){
      if(!sys||!dia) return ['—',''];
      if(sys>=180 || dia>=120) return ['أزمة ارتفاع ضغط','bad'];
      if(sys>=140 || dia>=90)  return ['ارتفاع ضغط (درجة 2)','bad'];
      if(sys>=130 || dia>=80)  return ['ارتفاع ضغط (درجة 1)','warn'];
      if(sys>=120 && dia<80)   return ['ضغط مرتفع (مسبق)','warn'];
      if(sys<120 && dia<80)    return ['طبيعي','ok'];
      return ['—',''];
    }

    // ——— توصيات إضافية ———
    function waterRecLiters(weightKg, activity){
      const base = Math.max(1.0, weightKg * 0.035);
      const extra = (activity>=1.9)?1.0 : (activity>=1.725)?0.8 : (activity>=1.55)?0.6 : (activity>=1.375)?0.35 : 0.0;
      const total = Math.min(5.0, Math.max(1.5, base + extra));
      return total;
    }
    function stepsRec(age, bmi, activity){
      let min=8000, max=10000, note='ضمن نمط صحي عام';
      if(age>=65){ min=6000; max=8000; note='ملائم لكبار السن'; }
      if(bmi>=30){ min=10000; max=12000; note='للمساعدة في خفض الوزن'; }
      else if(bmi>=25){ min=Math.max(min,9000); max=Math.max(max,11000); note='للحفاظ/خفض بسيط'; }
      if(activity>=1.725){ min=Math.max(5000,min-1000); max=Math.max(7000,max-1000); }
      if(activity<=1.2){ min+=1000; max+=1000; }
      return {min, max, note};
    }
    function proteinRange(weightKg, age, bmi){
      let lo=1.2, hi=1.6; if(age>=65){ lo=1.2; hi=1.8; } if(bmi>=30){ lo=Math.max(lo,1.6); hi=2.2; }
      return {lo: Math.round(lo*weightKg), hi: Math.round(hi*weightKg)};
    }
    function sugarLimits(tdee){ const max10 = Math.round((0.10*tdee)/4); const ideal5 = Math.round((0.05*tdee)/4); return {max10, ideal5}; }
    function fiberTarget(tdee){ return Math.round(14*(tdee/1000)); }
    function activityGuide(activity){
      let level='قليل/خامل', weekly='أقل من 60 دقيقة';
      if(activity>=1.375){ level='خفيف'; weekly='حوالي 60–150 دقيقة/أسبوع'; }
      if(activity>=1.55){ level='متوسط'; weekly='حوالي 150–300 دقيقة/أسبوع'; }
      if(activity>=1.725){ level='عالٍ'; weekly='أكثر من 300 دقيقة/أسبوع'; }
      if(activity>=1.9){ level='عالٍ جدًا'; weekly='مرتفع جدًا (>300 دقيقة)'; }
      return {level, weekly};
    }

    // أدوات عرض وسجل
    const fmt = (x,d=2) => Number.isFinite(x)? x.toFixed(d) : '—';
    const fmtInt = x => Number.isFinite(x)? Math.round(x).toLocaleString(): '—';
    const fmtDate = (ts)=>{ const d=new Date(ts); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; };
    const loadHistory = ()=>{ try{ return JSON.parse(localStorage.getItem(HIST)||'[]'); }catch(e){ return []; } };
    const saveHistory = (arr)=> localStorage.setItem(HIST, JSON.stringify(arr));
    function addHistory(entry){ const arr=loadHistory(); arr.unshift(entry); saveHistory(arr); renderHistory(); }

    function render(){
      const a=+age.value, s=sex.value, h=+height.value, w=+weight.value, wc=+waist.value, am=+act.value;
      const hp=+hip.value, nk=+neck.value, SYS=+sbp.value, DIA=+dbp.value;
      if(!a||!h||!w||!wc){ kpis.innerHTML='<div class="kpi"><h3>أدخل القيم أولًا</h3><div class="detail">العمر، الجنس، الطول، الوزن، محيط الخصر</div></div>'; draw2D(null); stop3D(); return; }

      const bmi=BMI(w,h); const [bmiTxt,bmiCls]=BMIcat(bmi);
      const whtr=WHtR(wc,h); const [whtrTxt,whtrCls]=WHtRcat(whtr);
      const [wcTxt,wcCls]=waistRisk(s,wc);
      const bf=bodyFatDeurenberg(bmi,a,s);
      const bmr=BMR(w,h,a,s); const tdee=TDEE(bmr,am);
      const bsa=BSA(w,h);
      const lbm=LBM(w,h,s); const ffmi=FFMI(lbm,h);
      const absi=ABSI(wc,bmi,h);
      const iw=idealWeightDevine(h,s); const diff=w-iw;
      const {min:hwMin,max:hwMax}=healthyWeightRange(h);
      const bmiPrime=BMIPrime(bmi);
      const pi=PI(w,h);
      const whr = (hp? WHR(wc,hp): NaN);
      const navy = (nk && (s==='male' ? wc>nk : (wc && hp && nk))) ? NavyBF(s,wc,nk,hp,h) : NaN;
      const [bpTxt,bpCls]=bpCategory(SYS,DIA);

      // إضافيات مقترحة
      const water = waterRecLiters(w, am);
      const steps = stepsRec(a, bmi, am);
      const prot = proteinRange(w, a, bmi);
      const sugar = sugarLimits(tdee);
      const fiber = fiberTarget(tdee);
      const actG = activityGuide(am);
      const waistTargetMin = 0.42*h, waistTargetMax = 0.50*h;

      const ideal = { bmi:'18.5–24.9', whtr:'0.45–0.49 (الأفضل < 0.50)', waistMale:'حتى 93 سم', waistFemale:'حتى 79 سم', bfpMale:'10–20%', bfpFemale:'20–30%', ffmiMale:'18–25', ffmiFemale:'15–22', prime:'0.80–1.00', pi:'11–14', whrMale:'0.80–0.90', whrFemale:'0.75–0.85', bp:'انقباضي 90–119 / انبساطي 60–79' };

      const ffmiRange = (s==='male')?[18,25]:[15,22]; const ffmiCls = ffmi<ffmiRange[0]?'warn':(ffmi>ffmiRange[1]?'warn':'ok');
      let primeCls='ok'; if(bmiPrime<0.8) primeCls='warn'; else if(bmiPrime>1.0&&bmiPrime<=1.2) primeCls='warn'; else if(bmiPrime>1.2) primeCls='bad';
      let piCls='ok'; if(pi<11||pi>14) piCls='warn';
      let hwCls='ok'; if(w<hwMin-3||w>hwMax+3) hwCls='bad'; else if(w<hwMin||w>hwMax) hwCls='warn';
      let whrCls = isFinite(whr)? ( (s==='male' ? (whr<=0.9?'ok':whr<=1?'warn':'bad') : (whr<=0.85?'ok':whr<=0.95?'warn':'bad')) ): '';
      let navyCls = isFinite(navy)? ((s==='male' ? (navy<=20?'ok':navy<=25?'warn':'bad') : (navy<=30?'ok':navy<=35?'warn':'bad'))): '';
      const waistTargetCls = (wc<=waistTargetMax && wc>=waistTargetMin)?'ok': (wc<=waistTargetMax+5?'warn':'bad');

      kpis.innerHTML = `
        <div class="kpi ${bmiCls}"><h3>مؤشر كتلة الجسم (BMI)</h3><div class="value">${fmt(bmi)} كجم/م²</div><div class="detail">تصنيف: ${bmiTxt} • <b>المثالي: ${ideal.bmi}</b></div></div>
        <div class="kpi ${whtrCls}"><h3>نسبة الخصر للطول (WHtR)</h3><div class="value">${fmt(whtr)}</div><div class="detail">${whtrTxt} • <b>المثالي: ${ideal.whtr}</b></div></div>
        <div class="kpi ${wcCls}"><h3>محيط الخصر (سم)</h3><div class="value">${fmt(wc,0)} سم</div><div class="detail">${s==='male'?'للذكور':'للإناث'}: ${wcTxt} • <b>المثالي: ${s==='male'?ideal.waistMale:ideal.waistFemale}</b></div></div>
        <div class="kpi"><h3>نسبة الدهون في الجسم % (تقديري)</h3><div class="value">${fmt(bf)}%</div><div class="detail"><b>المثالي: ${s==='male'?ideal.bfpMale:ideal.bfpFemale}</b></div></div>
        <div class="kpi ${ffmiCls}"><h3>مؤشر الكتلة الخالية من الدهون (FFMI)</h3><div class="value">${fmt(ffmi,2)}</div><div class="detail"><b>المثالي: ${s==='male'?ideal.ffmiMale:ideal.ffmiFemale}</b></div></div>
        <div class="kpi ${primeCls}"><h3>مؤشر BMI Prime</h3><div class="value">${fmt(bmiPrime,2)}</div><div class="detail"><b>المثالي: ${ideal.prime}</b> — (مؤشر كتلة الجسم ÷ 25)</div></div>
        <div class="kpi ${piCls}"><h3>مؤشر بونديرال (PI)</h3><div class="value">${fmt(pi,2)} كجم/م³</div><div class="detail"><b>المثالي: ${ideal.pi}</b> — (الوزن ÷ الطول³)</div></div>
        <div class="kpi ${hwCls}"><h3>نطاق وزن صحي لطولك</h3><div class="value">${fmt(hwMin,1)}–${fmt(hwMax,1)} كجم</div><div class="detail">وزنك الحالي: ${fmt(w,1)} كجم</div></div>
        <div class="kpi"><h3>الوزن المثالي (Devine)</h3><div class="value">${fmt(iw,1)} كجم</div><div class="detail">فارقك: ${diff>0?'+':''}${fmt(diff,1)} كجم</div></div>
        <div class="kpi ${waistTargetCls}"><h3>خصر مستهدف من الطول</h3><div class="value">${fmt(waistTargetMin,0)}–${fmt(waistTargetMax,0)} سم</div><div class="detail">(0.42–0.50 × الطول)</div></div>
        <div class="kpi ${whrCls}"><h3>نسبة الخصر إلى الورك (WHR)</h3><div class="value">${isFinite(whr)?fmt(whr,2):'—'}</div><div class="detail">${isFinite(whr)? `<b>المثالي: ${s==='male'?ideal.whrMale:ideal.whrFemale}</b>`: 'أدخل محيط الورك'}</div></div>
        <div class="kpi ${navyCls}"><h3>دهون الجسم % (طريقة البحرية)</h3><div class="value">${isFinite(navy)?fmt(navy,1):'—'}</div><div class="detail">${isFinite(navy)? `<b>المثالي: ${s==='male'?ideal.bfpMale:ideal.bfpFemale}</b>`: 'أدخل الرقبة + (الورك للإناث)'}</div></div>
        <div class="kpi ${bpCls}"><h3>ضغط الدم (تصنيف)</h3><div class="value">${(SYS&&DIA)? `${fmt(SYS,0)}/${fmt(DIA,0)}`:'—'} mmHg</div><div class="detail">${(SYS&&DIA)? bpTxt : 'أدخل القراءتين'} • <b>المثالي: ${ideal.bp}</b></div></div>
        <div class="kpi"><h3>سعرات الصيانة اليومية (TDEE)</h3><div class="value">≈ ${fmt(tdee,0)} سعرة/يوم</div><div class="detail">خسارة صحية: −10% إلى −20% ⇒ ${fmt(tdee*0.9,0)}–${fmt(tdee*0.8,0)}</div></div>
        <div class="kpi"><h3>الماء اليومي المقترح</h3><div class="value">≈ ${fmt(water,1)} لتر/يوم</div><div class="detail">تقديري حسب وزنك ونشاطك (المدى المعتاد 1.5–5 لتر)</div></div>
        ${(()=>{ const st=steps; return `<div class=\"kpi\"><h3>الخطوات المقترحة يوميًا</h3><div class=\"value\">${st.min.toLocaleString()}–${st.max.toLocaleString()} خطوة</div><div class=\"detail\">${st.note}</div></div>`; })()}
        ${(()=>{ const pr=prot; return `<div class=\"kpi\"><h3>احتياج البروتين اليومي</h3><div class=\"value\">${pr.lo}–${pr.hi} غ/يوم</div><div class=\"detail\">${(bmi>=30)?'مرفوع لوزن زائد/سمنة':'نطاق عام، قابل للتعديل حسب النشاط'}</div></div>`; })()}
        ${(()=>{ const sg=sugar; return `<div class=\"kpi\"><h3>السكر الحرّ (حد أقصى)</h3><div class=\"value\">≤ ${sg.max10} غ/يوم</div><div class=\"detail\">المثالي: ≤ ${sg.ideal5} غ/يوم (5% من السعرات)</div></div>`; })()}
        <div class="kpi"><h3>الألياف الغذائية</h3><div class="value">≈ ${fmtInt(fiber)} غ/يوم</div><div class="detail">≈ 14 غ لكل 1000 سعرة</div></div>
        <div class="kpi"><h3>مساحة سطح الجسم (BSA)</h3><div class="value">${fmt(bsa,2)} م²</div><div class="detail">Mosteller — للعلم فقط</div></div>
        <div class="kpi"><h3>ABSI (وصف توزيع الدهون)</h3><div class="value">${fmt(absi,4)}</div><div class="detail">قيمة أعلى قد تعني تمركز دهون حول الخصر</div></div>
        <div class="kpi"><h3>نشاطك الحالي (تقديري)</h3><div class="value">${actG.level}</div><div class="detail">${actG.weekly} • الهدف: 150–300 دقيقة معتدل أو 75–150 شديد/أسبوع</div></div>
      `;

      // حفظ السجل المختصر
      addHistory({ts: Date.now(), a, s, h, w, wc, bmi, bmiTxt, whtr});

      draw2D({sex:s, height:h, bmi, whtr, waist:wc});
      if(enable3d.checked){ start3D(s, bmi, whtr); } else { stop3D(); }
    }

    // أزرار
    $('#calc').addEventListener('click', ()=>{ render(); saveInputs(); });
    $('#reset').addEventListener('click', ()=>{ age.value=''; height.value=''; weight.value=''; waist.value=''; hip.value=''; neck.value=''; sbp.value=''; dbp.value=''; kpis.innerHTML='<div class="kpi"><h3>أدخل القيم ثم اضغط «احسب الآن»</h3></div>'; draw2D(null); stop3D(); saveInputs(); });

    loadInputs();
    renderHistory();
    fetchWeather();

    // ===== التصوّر 2D (SVG) =====
    function draw2D(state){
      const svg=document.getElementById('bodyViz'); if(!svg) return; if(!state){ svg.innerHTML='<rect x="0" y="0" width="200" height="420" fill="none"/>'; return; }
      const {sex,bmi,whtr}=state; const base={shoulderW:120,chestW:110,waistW:70,hipW:105,torsoH:190,legH:170,headR:28};
      const sexAdj=(sex==='male')?{shoulder:1.06,hip:0.95}:{shoulder:0.92,hip:1.06};
      const bmiNorm=Math.max(16,Math.min(40,bmi)); const bmiScale=1+(bmiNorm-22)/40; const waistScale=Math.max(0.8,Math.min(1.6,whtr/0.5));
      const shoulderW=base.shoulderW*sexAdj.shoulder*(0.9+(bmiScale-1)*0.5);
      const chestW=base.chestW*(0.9+(bmiScale-1)*0.6);
      const waistW=base.waistW*waistScale;
      const hipW=base.hipW*sexAdj.hip*(0.9+(bmiScale-1)*0.5);
      const riskColor=(whtr>=0.6)?'#dc2626':(whtr>=0.5?'#d97706':'#16a34a');
      const stroke='#94a3b8'; const fillTorso='url(#gradTorso)'; const cx=100; let y=10;
      svg.innerHTML=`
        <defs>
          <linearGradient id="gradTorso" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="#e2e8f0"/>
            <stop offset="100%" stop-color="#cbd5e1"/>
          </linearGradient>
          <filter id="glow" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="#000" flood-opacity="0.08"/></filter>
        </defs>
        <circle cx="${cx}" cy="${y+base.headR}" r="${base.headR}" fill="#e2e8f0" stroke="#cbd5e1"/>
        ${(()=>{y+=base.headR*2+6;return''})()}
        <path d="M ${cx-shoulderW/2} ${y} C ${cx-shoulderW/2} ${y-10}, ${cx+shoulderW/2} ${y-10}, ${cx+shoulderW/2} ${y} L ${cx+chestW/2} ${y+base.torsoH*0.35} C ${cx+chestW*0.2} ${y+base.torsoH*0.45}, ${cx-chestW*0.2} ${y+base.torsoH*0.45}, ${cx-chestW/2} ${y+base.torsoH*0.35} Z" fill="${fillTorso}" stroke="#cbd5e1" filter="url(#glow)"/>
      `;
      const wy=y+base.torsoH*0.35, wy2=wy+base.torsoH*0.25, hy=y+base.torsoH*0.65, hy2=hy+base.torsoH*0.22;
      svg.innerHTML+=`
        <path d="M ${cx-chestW/2} ${wy} C ${cx-waistW/2} ${wy2}, ${cx+waistW/2} ${wy2}, ${cx+chestW/2} ${wy} Z" fill="${fillTorso}" stroke="#cbd5e1"/>
        <path d="M ${cx-waistW/2} ${hy} C ${cx-hipW/2} ${hy2}, ${cx+hipW/2} ${hy2}, ${cx+waistW/2} ${hy} Z" fill="${fillTorso}" stroke="#cbd5e1"/>
      `;
      const yLeg=10+base.headR*2+6+base.torsoH+10;
      svg.innerHTML+=`
        <path d="M ${cx-hipW*0.25} ${yLeg} L ${cx-hipW*0.15} ${yLeg+base.legH}" stroke="#cbd5e1" stroke-width="8"/>
        <path d="M ${cx+hipW*0.25} ${yLeg} L ${cx+hipW*0.15} ${yLeg+base.legH}" stroke="#cbd5e1" stroke-width="8"/>
        <ellipse cx="${cx}" cy="${10+base.headR*2+6+base.torsoH*0.55}" rx="${Math.max(waistW/2,20)}" ry="14" fill="none" stroke="${riskColor}" stroke-width="3" opacity="0.9"/>
      `;
    }

    // ===== نموذج 3D Canvas =====
    const enable3d=$('#enable3d'); const canvas3d=$('#body3d'); const ctx3d=canvas3d.getContext('2d'); const viz3d=$('#viz3d');
    let rafId=null, yaw=0, profile=null;
    enable3d.addEventListener('change', ()=>{ if(enable3d.checked){ viz3d.style.display='flex'; const h=+height.value||0, w=+weight.value||0, wc=+waist.value||0; start3D(sex.value, BMI(w,h), WHtR(wc,h)); } else { stop3D(); } });

    function makeProfile(sex,bmi,whtr){
      const pts=[]; const baseShoulder=(sex==='male'?0.58:0.50)*(1+(bmi-22)/60); const baseChest=(sex==='male'?0.55:0.52)*(1+(bmi-22)/50); const baseWaist=0.36*Math.max(0.8,Math.min(1.6,whtr/0.5)); const baseHip=(sex==='male'?0.50:0.58)*(1+(bmi-22)/60);
      for(let i=0;i<=40;i++){ const t=i/40; const chestBlend=Math.max(0,1-Math.abs(t-0.2)/0.25); const waistBlend=Math.max(0,1-Math.abs(t-0.5)/0.18); const hipBlend=Math.max(0,1-Math.abs(t-0.8)/0.22); let r=0; r+=baseChest*chestBlend; r+=baseWaist*waistBlend; r+=baseHip*hipBlend; r=Math.max(r, baseShoulder*Math.max(0,1-Math.abs(t-0.05)/0.18)); pts.push({y:t,r}); } return pts; }

    function start3D(sex,bmi,whtr){ profile=makeProfile(sex,bmi,whtr); if(rafId) cancelAnimationFrame(rafId); yaw=0; viz3d.style.display='flex'; loop3D(); }
    function stop3D(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; viz3d.style.display='none'; }

    function loop3D(){
      const W=canvas3d.width, H=canvas3d.height; ctx3d.clearRect(0,0,W,H); const cx=W/2, cy=H*0.48; const scale=Math.min(W,H)*0.42; yaw+=0.02; const light={x:Math.cos(yaw+1), y:-0.2, z:Math.sin(yaw+1)}; const slices=60;
      for(let i=0;i<profile.length-1;i++){ const y1=cy+(profile[i].y-0.5)*scale*1.4; const y2=cy+(profile[i+1].y-0.5)*scale*1.4; for(let j=0;j<slices;j++){ const a1=(j/slices)*Math.PI*2+yaw; const a2=((j+1)/slices)*Math.PI*2+yaw; const r1=profile[i].r*scale; const r2=profile[i+1].r*scale; const x11=cx+Math.cos(a1)*r1*0.7; const x12=cx+Math.cos(a2)*r1*0.7; const x21=cx+Math.cos(a1)*r2*0.7; const x22=cx+Math.cos(a2)*r2*0.7; const nx=(Math.cos(a1)+Math.cos(a2))/2; const nz=(Math.sin(a1)+Math.sin(a2))/2; const ny=(y2-y1)/scale; const ndotl=Math.max(0.05,(nx*light.x+ny*light.y+nz*light.z)); const shade=Math.floor(160+65*ndotl); ctx3d.fillStyle=`rgb(${shade}, ${shade+12}, ${shade+20})`; ctx3d.beginPath(); ctx3d.moveTo(x11,y1); ctx3d.lineTo(x12,y1); ctx3d.lineTo(x22,y2); ctx3d.lineTo(x21,y2); ctx3d.closePath(); ctx3d.fill(); } }
      const whtr=WHtR(+waist.value||0, +height.value||0); const riskColor=(whtr>=0.6)?'#dc2626':(whtr>=0.5?'#d97706':'#16a34a'); ctx3d.strokeStyle=riskColor; ctx3d.lineWidth=3; const waistIdx=Math.floor(profile.length*0.5); const rr=profile[waistIdx].r*scale*0.7; ctx3d.beginPath(); ctx3d.ellipse(cx,cy,rr,rr*0.35,0,0,Math.PI*2); ctx3d.stroke(); rafId=requestAnimationFrame(loop3D);
    }

    function renderHistory(){
      const wrap=document.getElementById('history'); if(!wrap) return; const arr=loadHistory();
      if(arr.length===0){ wrap.innerHTML = '<div class="hcell" style="opacity:.8">لا توجد سجلات بعد — احسب أولاً وسيتم حفظ النتيجة هنا.</div>'; return; }
      let html = '';
      html += `<div class="hrow hhead"><div class="hcell">التاريخ</div><div class="hcell">الوزن (كجم)</div><div class="hcell">الطول (سم)</div><div class="hcell">الخصر (سم)</div><div class="hcell">مؤشر الكتلة BMI</div><div class="hcell">WHtR</div><div class="hcell"></div></div>`;
      arr.forEach((r,i)=>{
        html += `<div class=\"hrow\"><div class=\"hcell\">${fmtDate(r.ts)}</div><div class=\"hcell\">${fmt(r.w,1)}</div><div class=\"hcell\">${fmt(r.h,0)}</div><div class=\"hcell\">${fmt(r.wc,0)}</div><div class=\"hcell\">${fmt(r.bmi,1)} <small>(${r.bmiTxt})</small></div><div class=\"hcell\">${fmt(r.whtr,2)}</div><div class=\"hcell\"><button class=\"del\" data-i=\"${i}\" title=\"حذف\">×</button></div></div>`;
      });
      wrap.innerHTML = html;
      wrap.querySelectorAll('.del').forEach(btn=> btn.addEventListener('click', (e)=>{ const idx=+e.currentTarget.dataset.i; const arr=loadHistory(); arr.splice(idx,1); saveHistory(arr); renderHistory(); }));
    }

    // أزرار عامة
    const btnTop = document.getElementById('scrollTop');
    window.addEventListener('scroll',()=>{ btnTop.style.display = (window.scrollY>200)?'inline-flex':'none'; });
    btnTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    document.getElementById('clearHistory').addEventListener('click', ()=>{ localStorage.removeItem(HIST); renderHistory(); });
    
    const THEME_KEY='health:theme:v1';
    function setTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      try{ localStorage.setItem(THEME_KEY, t); }catch(e){}
      const sel=document.getElementById('themeSelect'); if(sel && sel.value!==t) sel.value=t;
    }
    (function(){
      const saved = (localStorage.getItem(THEME_KEY)||'morning');
      setTheme(saved);
      const sel=document.getElementById('themeSelect');
      if(sel){ sel.value=saved; sel.addEventListener('change', ()=> setTheme(sel.value)); }
    })();
  </script>
</body>
</html>
