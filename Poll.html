<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ØµÙØ­Ø© Ø§Ù„Ù‚Ø±Ø¹Ø© Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e5e7eb;        /* gray-200 */
      --accent:#22d3ee;      /* cyan-400 */
      --accent-2:#a78bfa;    /* violet-400 */
      --danger:#ef4444;      /* red-500 */
      --success:#22c55e;     /* green-500 */
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    html,body{height:100%;}
    body{
      margin:0; background:linear-gradient(180deg, #0b1220, #0f172a 30%, #0b1220);
      color:var(--text); font-family:"Segoe UI", system-ui, -apple-system, Arial, sans-serif;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{ width: min(1100px, 100%);}
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:20px;}
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{ background:rgba(17,24,39,.7); border:1px solid rgba(148,163,184,.15);
           border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(8px);
           padding:18px;}

    h1{ margin:0 0 10px; font-size:clamp(20px, 2.8vw, 28px); font-weight:700; }
    p.subtitle{ margin:0 0 12px; color:var(--muted); font-size:14px }

    textarea{ width:100%; min-height:220px; resize:vertical; border-radius:14px; outline:none;
              padding:14px; border:1px solid rgba(148,163,184,.25); background:#0b1220; color:var(--text);
              box-shadow: inset 0 0 0 9999px rgba(255,255,255,.02);
    }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .row + .row{ margin-top:10px; }

    .btn{ cursor:pointer; border:none; border-radius:999px; padding:10px 16px; font-weight:600;
          background:#1f2937; color:#e5e7eb; transition:.2s transform, .2s opacity, .2s background;
          display:inline-flex; align-items:center; gap:8px; box-shadow:0 6px 16px rgba(0,0,0,.25); }
    .btn:hover{ transform:translateY(-1px); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .primary{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1220; }
    .danger{ background:var(--danger); color:#fff; }
    .success{ background:var(--success); color:#0b1220; }
    .ghost{ background:transparent; border:1px solid rgba(148,163,184,.2); }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; max-height:130px; overflow:auto; margin-top:10px; }
    .chip{ background:#0b1220; border:1px solid rgba(148,163,184,.25); color:var(--text);
           border-radius:999px; padding:6px 12px; display:inline-flex; gap:8px; align-items:center; }
    .chip .x{ cursor:pointer; opacity:.8; font-weight:700; }

    .result-card{ display:flex; flex-direction:column; gap:14px; align-items:stretch; justify-content:center; }
    .display{ position:relative; background:#0b1220; border:1px solid rgba(148,163,184,.25);
              border-radius:var(--radius); padding:26px; min-height:130px; display:flex; align-items:center; justify-content:center; text-align:center; }
    .name{ font-size: clamp(26px, 4.2vw, 44px); font-weight:800; letter-spacing:.5px; }
    .hint{ color:var(--muted); font-size:13px; }

    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
    .left, .right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    label.switch{ display:inline-flex; align-items:center; gap:8px; font-size:14px; color:var(--muted); }
    input[type="checkbox"]{ width:18px; height:18px; }

    .section-title{ font-weight:700; margin-top:8px; margin-bottom:6px; font-size:14px; color:var(--muted); }

    .winners{ display:flex; flex-direction:column; gap:8px; max-height:190px; overflow:auto; }
    .winner{ background:rgba(34,197,94,.12); border:1px solid rgba(34,197,94,.35); color:#d1fae5;
             border-radius:12px; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }

    .count{ color:var(--muted); font-size:13px; }
    .badge{ background:rgba(34,211,238,.15); color:#67e8f9; padding:2px 10px; border-radius:999px; font-size:12px; }

    .footnote{ color:var(--muted); font-size:12px; text-align:center; margin-top:8px; }

    /* Confetti */
    canvas#confetti { position: fixed; inset:0; pointer-events:none; }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="app">
    <h1>ğŸ‰ ØµÙØ­Ø© Ø§Ù„Ù‚Ø±Ø¹Ø© Ø¨Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</h1>
    <p class="subtitle">Ø§ÙƒØªØ¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±) Ø«Ù… Ø§Ø¶ØºØ· Â«Ø¨Ø¯Ø¡Â» ÙˆÂ«ØªÙˆÙ‚ÙÂ» Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø². ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.</p>

    <div class="grid">
      <!-- Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
      <div class="card">
        <div class="toolbar">
          <div class="left">
            <span class="count">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: <span id="nameCount">0</span></span>
            <span class="badge" id="statusBadge">Ø¬Ø§Ù‡Ø²</span>
          </div>
          <div class="right">
            <button class="btn ghost" id="btnShuffle" title="Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ù…Ø§Ø¡">ğŸ”€ Ø®Ù„Ø·</button>
            <button class="btn" id="btnSave">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
            <button class="btn danger" id="btnClear">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
          </div>
        </div>

        <textarea id="namesInput" placeholder="Ù…Ø«Ø§Ù„:\nØ£Ø­Ù…Ø¯\nØ³Ø§Ø±Ø©\nÙ…Ø­Ù…Ø¯\nÙ†Ø¬Ù„Ø§Ø¡\n...\n"></textarea>

        <div class="section-title">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</div>
        <div class="chips" id="chips"></div>

        <div class="row">
          <label class="switch"><input type="checkbox" id="excludeWinner"/> Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„ÙØ§Ø¦Ø² Ù…Ù† Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
          <label class="switch"><input type="checkbox" id="avoidDuplicates" checked/> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸</label>
        </div>
      </div>

      <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø±Ø¹Ø© ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ -->
      <div class="card result-card">
        <div class="display">
          <div>
            <div class="name" id="displayName">â€”</div>
            <div class="hint">Ø§Ø¶ØºØ· Â«Ø¨Ø¯Ø¡Â»ØŒ Ø«Ù… Â«ØªÙˆÙ‚ÙÂ» Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø³Ù…</div>
          </div>
        </div>

        <div class="row" style="justify-content:center; gap:12px;">
          <button class="btn primary" id="btnStart">â–¶ï¸ Ø¨Ø¯Ø¡</button>
          <button class="btn danger" id="btnStop" disabled>â¹ï¸ ØªÙˆÙ‚Ù</button>
          <button class="btn ghost" id="btnReset">â†º Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
        </div>

        <div class="section-title">Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ†</div>
        <div class="winners" id="winners"></div>
        <div class="row">
          <button class="btn" id="btnExportWinners">ğŸ“„ Ù†Ø³Ø® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†</button>
          <button class="btn ghost" id="btnClearWinners">Ù…Ø³Ø­ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†</button>
        </div>
        <div class="footnote">Ø§Ø®ØªØµØ§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­: Ù…ÙØªØ§Ø­ <b>Ø§Ù„Ù…Ø³Ø§ÙØ©</b> = Ø¨Ø¯Ø¡/ØªÙˆÙ‚Ù â€¢ <b>R</b> = Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</div>
      </div>
    </div>
  </div>

  <script>
    // â€”â€” Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© â€”â€”
    const LS_KEYS = {
      names: "raffle:names",
      winners: "raffle:winners",
      exclude: "raffle:excludeWinner",
      dedup: "raffle:avoidDuplicates"
    };

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const namesInput = $("#namesInput");
    const chips = $("#chips");
    const nameCount = $("#nameCount");
    const statusBadge = $("#statusBadge");
    const displayName = $("#displayName");
    const winnersEl = $("#winners");
    const excludeWinner = $("#excludeWinner");
    const avoidDuplicates = $("#avoidDuplicates");

    const btnSave = $("#btnSave");
    const btnClear = $("#btnClear");
    const btnShuffle = $("#btnShuffle");
    const btnStart = $("#btnStart");
    const btnStop = $("#btnStop");
    const btnReset = $("#btnReset");
    const btnExportWinners = $("#btnExportWinners");
    const btnClearWinners = $("#btnClearWinners");

    let names = [];
    let winners = [];
    let rollingTimer = null;
    let lastShownIndex = -1;

    // â€”â€” Ø£Ø¯ÙˆØ§Øª â€”â€”
    const cleanNames = (arr) => arr
      .map(s => (s||"").trim())
      .filter(Boolean);

    const dedup = (arr) => Array.from(new Set(arr));

    const saveAll = () => {
      localStorage.setItem(LS_KEYS.names, JSON.stringify(names));
      localStorage.setItem(LS_KEYS.winners, JSON.stringify(winners));
      localStorage.setItem(LS_KEYS.exclude, JSON.stringify(!!excludeWinner.checked));
      localStorage.setItem(LS_KEYS.dedup, JSON.stringify(!!avoidDuplicates.checked));
    };

    const loadAll = () => {
      try{
        names = JSON.parse(localStorage.getItem(LS_KEYS.names) || "[]");
        winners = JSON.parse(localStorage.getItem(LS_KEYS.winners) || "[]");
        excludeWinner.checked = JSON.parse(localStorage.getItem(LS_KEYS.exclude) || "false");
        avoidDuplicates.checked = JSON.parse(localStorage.getItem(LS_KEYS.dedup) || "true");
      }catch(e){ names = []; winners=[]; }
      render();
    };

    const render = () => {
      // textarea
      namesInput.value = names.join("\n");
      // chips
      chips.innerHTML = "";
      names.forEach((n, i) => {
        const c = document.createElement("span");
        c.className = "chip";
        c.innerHTML = `<span>${escapeHtml(n)}</span> <span class="x" title="Ø­Ø°Ù" data-i="${i}">Ã—</span>`;
        chips.appendChild(c);
      });
      nameCount.textContent = names.length;
      // winners
      winnersEl.innerHTML = "";
      winners.forEach((w, idx) => {
        const li = document.createElement("div");
        li.className = "winner";
        li.innerHTML = `<div>ğŸ¥³ <b>${escapeHtml(w.name)}</b> <span class="badge">#${idx+1}</span></div>
                        <div style="font-size:12px; color:#a7f3d0">${new Date(w.time).toLocaleString()}</div>`;
        winnersEl.appendChild(li);
      });
      saveAll();
    };

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, (m)=>({"&":"&amp;","<":"&lt;",
              ">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    function setStatus(text, kind="ready"){
      statusBadge.textContent = text;
      // simple color cue
      if(kind==="ok"){ statusBadge.style.background = "rgba(34,197,94,.15)"; statusBadge.style.color = "#86efac"; }
      else if(kind==="warn"){ statusBadge.style.background = "rgba(234,179,8,.15)"; statusBadge.style.color = "#fde68a"; }
      else if(kind==="err"){ statusBadge.style.background = "rgba(239,68,68,.15)"; statusBadge.style.color = "#fecaca"; }
      else { statusBadge.style.background = "rgba(34,211,238,.15)"; statusBadge.style.color = "#67e8f9"; }
    }

    // â€”â€” Ø£Ø­Ø¯Ø§Ø« â€”â€”
    btnSave.addEventListener("click", () => {
      let list = cleanNames(namesInput.value.split(/\n+/));
      if(avoidDuplicates.checked) list = dedup(list);
      names = list;
      setStatus("ØªÙ… Ø§Ù„Ø­ÙØ¸", "ok");
      render();
    });

    btnClear.addEventListener("click", () => {
      if(confirm("Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ØŸ")){
        names = []; render(); setStatus("ØªÙ… Ø§Ù„Ù…Ø³Ø­", "warn");
      }
    });

    chips.addEventListener("click", (e)=>{
      const x = e.target.closest('.x');
      if(!x) return;
      const i = +x.dataset.i;
      names.splice(i,1);
      render();
    });

    btnShuffle.addEventListener("click", () => {
      for(let i=names.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [names[i], names[j]] = [names[j], names[i]];
      }
      render(); setStatus("ØªÙ… Ø§Ù„Ø®Ù„Ø·", "ok");
    });

    function startRolling(){
      if(names.length === 0){ setStatus("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡", "err"); return; }
      if(rollingTimer) return;
      btnStart.disabled = true; btnStop.disabled = false;
      setStatus("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨ ...");
      rollingTimer = setInterval(()=>{
        // Ø§Ø®ØªØ± Ù…Ø¤Ø´Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠØŒ ÙˆØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ Ù„ØªØ£Ø«ÙŠØ± Ø£Ø¬Ù…Ù„
        let idx;
        do{ idx = Math.floor(Math.random()*names.length); } while(names.length>1 && idx===lastShownIndex);
        lastShownIndex = idx;
        displayName.textContent = names[idx];
      }, 75);
    }

    function stopRolling(){
      if(!rollingTimer) return;
      clearInterval(rollingTimer); rollingTimer = null;
      btnStart.disabled = false; btnStop.disabled = true;
      const selected = displayName.textContent || (names[0]||"â€”");
      setStatus("ØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±", "ok");
      celebrate();
      winners.unshift({ name: selected, time: Date.now() });
      if(excludeWinner.checked){
        const i = names.findIndex(n => n === selected);
        if(i>-1){ names.splice(i,1); }
      }
      render();
    }

    function reset(){
      if(rollingTimer){ clearInterval(rollingTimer); rollingTimer=null; }
      displayName.textContent = "â€”";
      btnStart.disabled = false; btnStop.disabled = true;
      setStatus("Ø¬Ø§Ù‡Ø²");
    }

    btnStart.addEventListener("click", startRolling);
    btnStop.addEventListener("click", stopRolling);
    btnReset.addEventListener("click", reset);

    btnExportWinners.addEventListener("click", () => {
      const txt = winners.map((w, i)=> `${i+1}. ${w.name} (${new Date(w.time).toLocaleString()})`).join("\n");
      if(!txt){ alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯"); return; }
      navigator.clipboard.writeText(txt).then(()=> setStatus("ØªÙ… Ø§Ù„Ù†Ø³Ø®", "ok"));
    });

    btnClearWinners.addEventListener("click", () => {
      if(confirm("Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†ØŸ")){
        winners = []; render(); setStatus("ØªÙ… Ø§Ù„Ù…Ø³Ø­", "warn");
      }
    });

    // Ù…ÙØ§ØªÙŠØ­ Ø³Ø±ÙŠØ¹Ø©
    document.addEventListener("keydown", (e)=>{
      if(e.code === "Space"){ e.preventDefault(); if(rollingTimer) stopRolling(); else startRolling(); }
      if(e.key.toLowerCase() === 'r'){ reset(); }
    });

    // Ø­ÙØ¸ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„Ø§Øª
    excludeWinner.addEventListener('change', saveAll);
    avoidDuplicates.addEventListener('change', saveAll);

    // â€”â€” Ù…Ø¤Ø«Ø± Ø¨Ø³ÙŠØ· Ø§Ø­ØªÙØ§Ù„ â€”â€”
    const confettiCanvas = document.getElementById('confetti');
    const ctx = confettiCanvas.getContext('2d');
    function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    let confettiPieces = [];
    function celebrate(){
      confettiPieces = Array.from({length: 120}, () => ({
        x: Math.random()*confettiCanvas.width,
        y: -10 - Math.random()*50,
        r: 4 + Math.random()*6,
        vy: 2 + Math.random()*3,
        vx: (Math.random()-.5)*2,
        a: Math.random()*Math.PI*2
      }));
      let t = 0, maxT = 120; // ~2 Ø«ÙˆØ§Ù†ÙŠ
      (function loop(){
        ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
        confettiPieces.forEach(p=>{
          p.x += p.vx; p.y += p.vy; p.a += 0.1;
          ctx.save();
          ctx.translate(p.x, p.y); ctx.rotate(p.a);
          ctx.fillStyle = `hsl(${(p.y/4)%360}, 90%, 60%)`;
          ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r);
          ctx.restore();
        });
        t++;
        if(t<maxT) requestAnimationFrame(loop); else ctx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
      })();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    loadAll();
  </script>
</body>
</html>
