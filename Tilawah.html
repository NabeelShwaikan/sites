<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
  <style>
    :root{
      --bg1:#f8fafc; --bg2:#eef2ff; --panel:#ffffff; --ink:#0f172a; --muted:#475569;
      --accent:#16a34a; --accent2:#60a5fa; --warn:#d97706; --danger:#dc2626;
      --border:rgba(2,6,23,.10); --radius:18px; --shadow: 0 14px 36px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic", "Amiri", Arial, sans-serif;
      background: linear-gradient(160deg,var(--bg1),var(--bg2));
      color:var(--ink); margin:0; padding:24px;
    }
    .wrap{max-width:980px; margin:0 auto;}
    header{display:flex; align-items:start; justify-content:space-between; gap:16px; margin-bottom:20px; flex-wrap:wrap}
    h1{font-size: clamp(1.2rem, 1rem + 1.6vw, 2rem); margin:0}

    .datebox{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:8px 12px; box-shadow:var(--shadow); font-weight:600}
    .chip .sub{font-weight:500; color:var(--muted); margin-inline-start:6px}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px 18px 6px; margin-bottom:18px}
    label{display:block; font-weight:600; margin-bottom:8px}
    select, input[type="range"], button{ width:100%; font-size:1rem; }
    select{ padding:12px; border-radius:14px; border:1px solid var(--border); background:#fff; }
    .row{display:grid; grid-template-columns: 1fr; gap:14px}
    @media (min-width:820px){ .row{ grid-template-columns: 1.2fr 1fr } }

    .stat{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 2px}
    .pill{font-variant-numeric:tabular-nums; background:#f1f5f9; border:1px solid var(--border); padding:6px 10px; border-radius:999px}

    .range-box{padding:12px; background:#f8fafc; border:1px dashed var(--border); border-radius:14px}
    input[type="range"]{ accent-color: var(--accent); }
    .progress{height:10px; border-radius:999px; background:#e2e8f0; overflow:hidden;}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}

    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .btn{cursor:pointer; border:none; border-radius:12px; padding:10px 14px; font-weight:700}
    .btn.reset{background:#f1f5f9; color:var(--ink); border:1px solid var(--border)}
    .btn.tiny{padding:6px 10px; font-size:.85rem; font-weight:600}

    .notes{margin-top:12px}
    textarea#note{width:100%; border:1px solid var(--border); border-radius:14px; padding:12px; resize:vertical; min-height:96px; font-family:inherit; font-size:1rem; background:#fff; color:var(--ink)}
    .note-meta{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px; color:var(--muted); font-size:.9rem}
    .note-tools{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}

    .note{color:var(--muted); font-size:.95rem; margin:8px 0 12px}
    .toast{position:fixed; inset-inline:0; bottom:18px; display:flex; justify-content:center; pointer-events:none}
    .toast > div{background:#0ea5e9; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:.25s}
    .toast.show > div{opacity:1; transform:translateY(0)}

    footer{color:var(--muted); font-size:.9rem; text-align:center; margin-top:18px}

    .theme-btn{display:inline-flex; align-items:center; gap:2px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:#fff; color:var(--ink); padding:2px 6px; border-radius:999px; box-shadow:var(--shadow); font-size:.9rem; line-height:1; width:auto; min-width:auto}
    html[data-theme="dark"] .theme-btn{background:#000;}
    .theme-btn:focus{outline:2px solid var(--accent2); outline-offset:3px}

    html[data-theme="dark"]{
      --bg1:#0b1220; --bg2:#0f172a; --panel:#000000; --ink:#e5e7eb; --muted:#94a3b8;
      --accent:#16a34a; --accent2:#38bdf8; --warn:#d97706; --danger:#dc2626;
      --border:rgba(148,163,184,.30);
    }
    html[data-theme="dark"] body{background: linear-gradient(160deg,var(--bg1),var(--bg2));}
    html[data-theme="dark"] select{background:#000000; color:var(--ink); border-color:var(--border)}
    html[data-theme="dark"] .range-box{background:#000000}
    html[data-theme="dark"] .progress{background:#0b0b0b}
    html[data-theme="dark"] .btn.reset{background:#000; color:var(--ink); border:1px solid var(--border)}
    html[data-theme="dark"] .btn{background:#000; color:var(--ink); border:1px solid var(--border)}
    html[data-theme="dark"] .btn.tiny{background:#000; color:var(--ink); border:1px solid var(--border)}
    html[data-theme="dark"] .card{background:#000}
    html[data-theme="dark"] .pill{background:#000; color:var(--ink); border-color:var(--border)}
    html[data-theme="dark"] .note{color:var(--muted)}
    html[data-theme="dark"] textarea#note{background:#000; color:var(--ink); border-color:var(--border)}
    html[data-theme="dark"] .chip{background:#000}

    /* ØªØ®ØµÙŠØµ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© #mode ØªØ­Ø¯ÙŠØ¯Ù‹Ø§ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    html[data-theme="dark"] #mode{
      background:#000 !important;
      color:#e5e7eb !important;
      border:1px solid var(--border) !important;
    }

    .card.disabled{opacity:.55; filter:grayscale(.15)}

    /* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„ */
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:8px}
    th, td{padding:10px 12px; border-bottom:1px solid var(--border); font-size:.95rem}
    th{text-align:right; color:var(--muted)}
    tbody tr:hover{background:rgba(2,6,23,.03)}
    html[data-theme="dark"] tbody tr:hover{background:rgba(148,163,184,.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“– Ù…ØªØ§Ø¨Ø¹Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
      <div class="datebox">
        <span class="chip" id="clock">--:--:-- <span class="sub">Ø§Ù„Ø¢Ù†</span></span>
        <span class="chip" id="hijri">â€” <span class="sub">Ù‡Ø¬Ø±ÙŠ</span></span>
        <span class="chip" id="greg">â€” <span class="sub">Ù…ÙŠÙ„Ø§Ø¯ÙŠ</span></span>
        <button class="theme-btn" id="themeToggle">â˜€ï¸</button>
        <label for="mode" class="chip" style="display:inline-flex; align-items:center; gap:8px;">
          Ø§Ù„Ù‡Ø¯Ù:
          <select id="mode" style="width:auto; min-width:140px; border:none; font-weight:700;">
            <option value="khatmah">Ø®ØªÙ…Ø©</option>
            <option value="wird">ÙˆØ±Ø¯ ÙŠÙˆÙ…ÙŠ</option>
          </select>
        </label>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <div>
          <label for="surah">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©</label>
          <select id="surah"></select>
          <div class="notes">
            <label for="note">âœï¸ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø­ÙˆÙ„ Ø§Ù„Ø³ÙˆØ±Ø©</label>
            <textarea id="note" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ ØªØ¯Ø¨Ù‘Ø±Ùƒ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ..."></textarea>
            <div class="note-meta">
              <span id="saveMsg">Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©â€¦</span>
              <span id="noteCount">0 ÙƒÙ„Ù…Ø©</span>
            </div>
            <div class="note-tools">
              <button class="btn tiny" id="clearNoteBtn">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</button>
              <button class="btn tiny" id="exportNotesBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
            </div>
          </div>
        </div>
        <div>
          <label for="ayahRange">Ø¢Ø®Ø± Ø¢ÙŠØ© ÙˆØµÙ„Øª Ø¥Ù„ÙŠÙ‡Ø§</label>
          <div class="range-box">
            <input id="ayahRange" type="range" min="1" max="7" value="1" step="1" />
            <div class="stat">
              <div>Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span class="pill" id="ayahLabel">1</span></div>
              <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¢ÙŠØ§Øª: <span class="pill" id="ayahMax">7</span></div>
            </div>
            <div class="progress"><div class="bar" id="bar"></div></div>
          </div>
          <div class="actions">
            <button class="btn reset" id="resetBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
            <button class="btn reset" id="completeBeforeBtn">Ø§Ø¹ØªØ¨Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ø®ØªÙˆÙ…Ù‹Ø§</button>
            <button class="btn" id="saveSessionBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
            <button class="btn tiny" id="exportSessionsBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ø¬Ù„ (CSV)</button>
            <button class="btn tiny" id="clearSessionsBtn">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="globalProgressCard">
      <label>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø®ØªÙ…Ø©</label>
      <div class="stat">
        <div>Ø¢ÙŠØ§Øª Ù…ÙƒØªÙ…Ù„Ø©: <span class="pill" id="globalCount">0 / 6236</span></div>
        <div>Ø§Ù„Ù†Ø³Ø¨Ø©: <span class="pill" id="globalPercent">0%</span></div>
      </div>
      <div class="progress"><div class="bar" id="globalBar"></div></div>
      <div id="modeHint" class="note"></div>
    </section>

    <section class="card" id="sessionsCard">
      <label>Ø³Ø¬Ù„ Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„ÙŠÙˆÙ… (Ù…ÙŠÙ„Ø§Ø¯ÙŠ / Ù‡Ø¬Ø±ÙŠ)</th>
            <th>Ø§Ù„ÙˆØ¶Ø¹</th>
            <th>Ø§Ù„Ø³ÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø¢ÙŠØ©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="sessionsBody"></tbody>
      </table>
      <a id="csvLink" style="display:none"></a>
    </section>

  </div>
  <div class="toast" id="toast"><div>âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</div></div>

  <script>
    'use strict';
    // ===== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆØ± (114 Ø³ÙˆØ±Ø© â€” Ù…ØµØ­Ù Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©) =====
    const SURAHS = [
      {i:1,n:"Ø§Ù„ÙØ§ØªØ­Ø©",v:7},{i:2,n:"Ø§Ù„Ø¨Ù‚Ø±Ø©",v:286},{i:3,n:"Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†",v:200},{i:4,n:"Ø§Ù„Ù†Ø³Ø§Ø¡",v:176},
      {i:5,n:"Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©",v:120},{i:6,n:"Ø§Ù„Ø£Ù†Ø¹Ø§Ù…",v:165},{i:7,n:"Ø§Ù„Ø£Ø¹Ø±Ø§Ù",v:206},{i:8,n:"Ø§Ù„Ø£Ù†ÙØ§Ù„",v:75},
      {i:9,n:"Ø§Ù„ØªÙˆØ¨Ø©",v:129},{i:10,n:"ÙŠÙˆÙ†Ø³",v:109},{i:11,n:"Ù‡ÙˆØ¯",v:123},{i:12,n:"ÙŠÙˆØ³Ù",v:111},
      {i:13,n:"Ø§Ù„Ø±Ø¹Ø¯",v:43},{i:14,n:"Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…",v:52},{i:15,n:"Ø§Ù„Ø­Ø¬Ø±",v:99},{i:16,n:"Ø§Ù„Ù†Ø­Ù„",v:128},
      {i:17,n:"Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡",v:111},{i:18,n:"Ø§Ù„ÙƒÙ‡Ù",v:110},{i:19,n:"Ù…Ø±ÙŠÙ…",v:98},{i:20,n:"Ø·Ù‡",v:135},
      {i:21,n:"Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡",v:112},{i:22,n:"Ø§Ù„Ø­Ø¬",v:78},{i:23,n:"Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†",v:118},{i:24,n:"Ø§Ù„Ù†ÙˆØ±",v:64},
      {i:25,n:"Ø§Ù„ÙØ±Ù‚Ø§Ù†",v:77},{i:26,n:"Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡",v:227},{i:27,n:"Ø§Ù„Ù†Ù…Ù„",v:93},{i:28,n:"Ø§Ù„Ù‚ØµØµ",v:88},
      {i:29,n:"Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª",v:69},{i:30,n:"Ø§Ù„Ø±ÙˆÙ…",v:60},{i:31,n:"Ù„Ù‚Ù…Ø§Ù†",v:34},{i:32,n:"Ø§Ù„Ø³Ø¬Ø¯Ø©",v:30},
      {i:33,n:"Ø§Ù„Ø£Ø­Ø²Ø§Ø¨",v:73},{i:34,n:"Ø³Ø¨Ø£",v:54},{i:35,n:"ÙØ§Ø·Ø±",v:45},{i:36,n:"ÙŠØ³",v:83},
      {i:37,n:"Ø§Ù„ØµØ§ÙØ§Øª",v:182},{i:38,n:"Øµ",v:88},{i:39,n:"Ø§Ù„Ø²Ù…Ø±",v:75},{i:40,n:"ØºØ§ÙØ±",v:85},
      {i:41,n:"ÙØµÙ„Øª",v:54},{i:42,n:"Ø§Ù„Ø´ÙˆØ±Ù‰",v:53},{i:43,n:"Ø§Ù„Ø²Ø®Ø±Ù",v:89},{i:44,n:"Ø§Ù„Ø¯Ø®Ø§Ù†",v:59},
      {i:45,n:"Ø§Ù„Ø¬Ø§Ø«ÙŠØ©",v:37},{i:46,n:"Ø§Ù„Ø£Ø­Ù‚Ø§Ù",v:35},{i:47,n:"Ù…Ø­Ù…Ø¯",v:38},{i:48,n:"Ø§Ù„ÙØªØ­",v:29},
      {i:49,n:"Ø§Ù„Ø­Ø¬Ø±Ø§Øª",v:18},{i:50,n:"Ù‚",v:45},{i:51,n:"Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª",v:60},{i:52,n:"Ø§Ù„Ø·ÙˆØ±",v:49},
      {i:53,n:"Ø§Ù„Ù†Ø¬Ù…",v:62},{i:54,n:"Ø§Ù„Ù‚Ù…Ø±",v:55},{i:55,n:"Ø§Ù„Ø±Ø­Ù…Ù†",v:78},{i:56,n:"Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©",v:96},
      {i:57,n:"Ø§Ù„Ø­Ø¯ÙŠØ¯",v:29},{i:58,n:"Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©",v:22},{i:59,n:"Ø§Ù„Ø­Ø´Ø±",v:24},{i:60,n:"Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©",v:13},
      {i:61,n:"Ø§Ù„ØµÙ",v:14},{i:62,n:"Ø§Ù„Ø¬Ù…Ø¹Ø©",v:11},{i:63,n:"Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†",v:11},{i:64,n:"Ø§Ù„ØªØºØ§Ø¨Ù†",v:18},
      {i:65,n:"Ø§Ù„Ø·Ù„Ø§Ù‚",v:12},{i:66,n:"Ø§Ù„ØªØ­Ø±ÙŠÙ…",v:12},{i:67,n:"Ø§Ù„Ù…Ù„Ùƒ",v:30},{i:68,n:"Ø§Ù„Ù‚Ù„Ù…",v:52},
      {i:69,n:"Ø§Ù„Ø­Ø§Ù‚Ø©",v:52},{i:70,n:"Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬",v:44},{i:71,n:"Ù†ÙˆØ­",v:28},{i:72,n:"Ø§Ù„Ø¬Ù†",v:28},
      {i:73,n:"Ø§Ù„Ù…Ø²Ù…Ù„",v:20},{i:74,n:"Ø§Ù„Ù…Ø¯Ø«Ø±",v:56},{i:75,n:"Ø§Ù„Ù‚ÙŠØ§Ù…Ø©",v:40},{i:76,n:"Ø§Ù„Ø¥Ù†Ø³Ø§Ù†",v:31},
      {i:77,n:"Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª",v:50},{i:78,n:"Ø§Ù„Ù†Ø¨Ø£",v:40},{i:79,n:"Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª",v:46},{i:80,n:"Ø¹Ø¨Ø³",v:42},
      {i:81,n:"Ø§Ù„ØªÙƒÙˆÙŠØ±",v:29},{i:82,n:"Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±",v:19},{i:83,n:"Ø§Ù„Ù…Ø·ÙÙÙŠÙ†",v:36},{i:84,n:"Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚",v:25},
      {i:85,n:"Ø§Ù„Ø¨Ø±ÙˆØ¬",v:22},{i:86,n:"Ø§Ù„Ø·Ø§Ø±Ù‚",v:17},{i:87,n:"Ø§Ù„Ø£Ø¹Ù„Ù‰",v:19},{i:88,n:"Ø§Ù„ØºØ§Ø´ÙŠØ©",v:26},
      {i:89,n:"Ø§Ù„ÙØ¬Ø±",v:30},{i:90,n:"Ø§Ù„Ø¨Ù„Ø¯",v:20},{i:91,n:"Ø§Ù„Ø´Ù…Ø³",v:15},{i:92,n:"Ø§Ù„Ù„ÙŠÙ„",v:21},
      {i:93,n:"Ø§Ù„Ø¶Ø­Ù‰",v:11},{i:94,n:"Ø§Ù„Ø´Ø±Ø­",v:8},{i:95,n:"Ø§Ù„ØªÙŠÙ†",v:8},{i:96,n:"Ø§Ù„Ø¹Ù„Ù‚",v:19},
      {i:97,n:"Ø§Ù„Ù‚Ø¯Ø±",v:5},{i:98,n:"Ø§Ù„Ø¨ÙŠÙ†Ø©",v:8},{i:99,n:"Ø§Ù„Ø²Ù„Ø²Ù„Ø©",v:8},{i:100,n:"Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª",v:11},
      {i:101,n:"Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©",v:11},{i:102,n:"Ø§Ù„ØªÙƒØ§Ø«Ø±",v:8},{i:103,n:"Ø§Ù„Ø¹ØµØ±",v:3},{i:104,n:"Ø§Ù„Ù‡Ù…Ø²Ø©",v:9},
      {i:105,n:"Ø§Ù„ÙÙŠÙ„",v:5},{i:106,n:"Ù‚Ø±ÙŠØ´",v:4},{i:107,n:"Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†",v:7},{i:108,n:"Ø§Ù„ÙƒÙˆØ«Ø±",v:3},
      {i:109,n:"Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†",v:6},{i:110,n:"Ø§Ù„Ù†ØµØ±",v:3},{i:111,n:"Ø§Ù„Ù…Ø³Ø¯",v:5},{i:112,n:"Ø§Ù„Ø¥Ø®Ù„Ø§Øµ",v:4},
      {i:113,n:"Ø§Ù„ÙÙ„Ù‚",v:5},{i:114,n:"Ø§Ù„Ù†Ø§Ø³",v:6}
    ];

    document.addEventListener('DOMContentLoaded', () => {
      // Ø¹Ù†Ø§ØµØ± DOM
      const $surah = document.getElementById('surah');
      const $range = document.getElementById('ayahRange');
      const $ayahLabel = document.getElementById('ayahLabel');
      const $ayahMax = document.getElementById('ayahMax');
      const $bar = document.getElementById('bar');
      const $globalBar = document.getElementById('globalBar');
      const $globalPercent = document.getElementById('globalPercent');
      const $globalCount = document.getElementById('globalCount');
      const $mode = document.getElementById('mode');
      const $completeBefore = document.getElementById('completeBeforeBtn');
      const $toast = document.getElementById('toast');
      const $reset = document.getElementById('resetBtn');
      const $themeToggle = document.getElementById('themeToggle');
      const $html = document.documentElement;
      const $clock = document.getElementById('clock');
      const $greg = document.getElementById('greg');
      const $hijri = document.getElementById('hijri');
      const $saveSession = document.getElementById('saveSessionBtn');
      const $exportSessions = document.getElementById('exportSessionsBtn');
      const $clearSessions = document.getElementById('clearSessionsBtn');
      const $sessionsBody = document.getElementById('sessionsBody');
      const $csvLink = document.getElementById('csvLink');
      const $note = document.getElementById('note');
      const $noteCount = document.getElementById('noteCount');
      const $saveMsg = document.getElementById('saveMsg');
      const $clearNoteBtn = document.getElementById('clearNoteBtn');
      const $exportNotesBtn = document.getElementById('exportNotesBtn');

      // Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ†
      const keyFor = (i) => `qread:${i}`;
      const keyMode = () => 'qread:mode';
      const keyLast = () => 'qread:last';
      const keySessions = () => 'qread:sessions';
      const keyNote = (i) => `qread:note:${i}`;

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      $surah.innerHTML = SURAHS.map(s => `<option value="${s.i}">${s.i}. ${s.n}</option>`).join('');

      // ===== Ø§Ù„Ø«ÙŠÙ… =====
      function setTheme(t){
        const theme = (t === 'dark') ? 'dark' : 'light';
        $html.setAttribute('data-theme', theme);
        localStorage.setItem('qread:theme', theme);
        $themeToggle.textContent = (theme === 'dark') ? 'ğŸŒ™' : 'â˜€ï¸';
        $themeToggle.title = (theme === 'dark') ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ';
      }
      function initTheme(){
        const saved = localStorage.getItem('qread:theme');
        if(saved){ setTheme(saved); }
        else{
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          setTheme(prefersDark ? 'dark' : 'light');
        }
      }
      if($themeToggle){
        $themeToggle.addEventListener('click', ()=>{
          const cur = $html.getAttribute('data-theme') || 'light';
          setTheme(cur === 'light' ? 'dark' : 'light');
        });
      }

      // ===== Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª =====
      function fmtGregorian(d){
        return new Intl.DateTimeFormat('ar', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(d);
      }
      function fmtHijri(d){
        return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(d);
      }
      function fmtClock(d){
        const pad = (n)=> String(n).padStart(2,'0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
      function updateDateTime(){
        const now = new Date();
        if($clock) $clock.firstChild.nodeValue = fmtClock(now) + ' ';
        if($greg) $greg.firstChild.nodeValue = fmtGregorian(now) + ' ';
        if($hijri) $hijri.firstChild.nodeValue = fmtHijri(now) + ' ';
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© =====
      const showToast = () => { $toast.classList.add('show'); setTimeout(() => $toast.classList.remove('show'), 800); };
      const getMode = () => ($mode && $mode.value) || 'khatmah';
      const getSavedAyah = (i) => {
        const raw = localStorage.getItem(keyFor(i));
        if (!raw) return 0;
        const s = SURAHS.find(x => x.i === i);
        return Math.min(Math.max(+raw || 0, 0), s ? s.v : 0);
      };

      // ===== Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ø¹Ø§Ù… =====
      const TOTAL_AYAT = 6236;
      function computeGlobalProgressContinuous(){
        let sum = 0;
        for (const s of SURAHS) {
          const v = getSavedAyah(s.i);
          if (v <= 0) break;
          if (v >= s.v) { sum += s.v; } else { sum += v; break; }
        }
        const pct = Math.max(0, Math.min(100, Math.round(sum * 100 / TOTAL_AYAT)));
        if($globalBar) $globalBar.style.width = pct + '%';
        if($globalPercent) $globalPercent.textContent = pct + '%';
        if($globalCount) $globalCount.textContent = sum + ' / ' + TOTAL_AYAT;
      }

      // ===== Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª + Ø¹Ø¯Ù‘Ø§Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª =====
      function countWords(text){
        const t = (text || '').replace(/[\u200f\u200e]/g,'').trim();
        if(!t) return 0;
        const tokens = t.match(/[\p{L}\p{N}]+/gu);
        return tokens ? tokens.length : 0;
      }
      function updateWordCount(){
        if(!$noteCount || !$note) return;
        const c = countWords($note.value);
        $noteCount.textContent = `${c} ÙƒÙ„Ù…Ø©`;
      }
      let noteSaveTimer = null;
      function scheduleNoteSave(){
        if(!$note || !$saveMsg) return;
        $saveMsg.textContent = '... Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸';
        clearTimeout(noteSaveTimer);
        noteSaveTimer = setTimeout(()=>{
          const sid = +$surah.value || 1;
          localStorage.setItem(keyNote(sid), $note.value || '');
          $saveMsg.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
          setTimeout(()=>{ $saveMsg.textContent = 'Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù Ø§Ù„ÙƒØªØ§Ø¨Ø©â€¦'; }, 1200);
        }, 500);
      }
      if($note){
        $note.addEventListener('input', ()=>{ updateWordCount(); scheduleNoteSave(); });
      }
      if($clearNoteBtn && $note){
        $clearNoteBtn.addEventListener('click', ()=>{
          if(!confirm('Ù…Ø³Ø­ Ù…Ù„Ø§Ø­Ø¸Ø© Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙˆØ±Ø©ØŸ')) return;
          $note.value = '';
          updateWordCount();
          const sid = +$surah.value || 1;
          localStorage.setItem(keyNote(sid), '');
          if($saveMsg) $saveMsg.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸';
        });
      }
      if($exportNotesBtn){
        $exportNotesBtn.addEventListener('click', ()=>{
          const rows = [['surahId','surahName','words','note']];
          for(const s of SURAHS){
            const txt = localStorage.getItem(keyNote(s.i)) || '';
            rows.push([s.i, s.n, countWords(txt), txt.replaceAll('"','""')]);
          }
          const csv = rows.map(r=>r.map(c=>`"${String(c)}"`).join(',')).join('\n');
          const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          $csvLink.href = url; $csvLink.download = 'quran-notes.csv'; $csvLink.click();
          setTimeout(()=> URL.revokeObjectURL(url), 800);
        });
      }

      // ===== Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³ÙˆØ±Ø© =====
      function syncSurahUI(i){
        const s = SURAHS.find(x => x.i === i); if (!s) return;
        const saved = Math.max(1, Math.min(getSavedAyah(i) || 1, s.v));
        $range.max = s.v; $ayahMax.textContent = s.v; $range.value = saved; $ayahLabel.textContent = saved;
        const p = Math.round(saved * 100 / s.v); $bar.style.width = p + '%';
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³ÙˆØ±Ø©
        if($note){
          const txt = localStorage.getItem(keyNote(i)) || '';
          $note.value = txt; updateWordCount();
        }
      }

      // ===== ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø¯Ù =====
      function setCompleteBeforeEnabled(enabled){
        const btn = document.getElementById('completeBeforeBtn');
        if(!btn) return;
        btn.disabled = !enabled;
        btn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
        btn.title = enabled ? 'Ø§Ø¹ØªØ¨Ø§Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ù‚Ø±ÙˆØ¡Ø§' : 'ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ';
        btn.style.opacity = enabled ? '1' : '.6';
        btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
      }
      function applyMode(){
        const m = ($mode && $mode.value) || 'khatmah';
        const card = document.getElementById('globalProgressCard');
        const hint = document.getElementById('modeHint');
        const isWird = m === 'wird';
        if(card){
          card.classList.toggle('disabled', isWird);
          card.setAttribute('aria-disabled', isWird ? 'true' : 'false');
        }
        if(hint) hint.textContent = isWird ? 'ØºÙŠØ± Ù…ÙØ¹Ù„ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ÙˆØ±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ' : '';
        setCompleteBeforeEnabled(!isWird);
        if(!isWird) computeGlobalProgressContinuous();
      }

      // ===== Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª =====
      function loadSessions(){
        try{ return JSON.parse(localStorage.getItem(keySessions())||'[]'); }catch{ return []; }
      }
      function saveSessions(list){ localStorage.setItem(keySessions(), JSON.stringify(list)); }
      function renderSessions(){
        const sessionsList = loadSessions().slice().reverse();
        if(!$sessionsBody) return;
        const mapModeLabel = (modeValue) => ({ khatmah: 'Ø®ØªÙ…Ø©', wird: 'ÙˆØ±Ø¯ ÙŠÙˆÙ…ÙŠ' }[modeValue] || modeValue);
        const mapActionLabel = (actionValue) => ({
          save: 'Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©',
          save_session: 'Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©',
          complete_before: 'Ø§Ø¹ØªØ¨Ø§Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ø®ØªÙˆÙ…Ù‹Ø§',
          reset: 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·',
        }[actionValue] || actionValue);
        const rowsHtml = sessionsList.map((s)=>`
          <tr>
            <td>${s.time || ''}</td>
            <td>${(s.greg || '')} / ${(s.hijri || '')}</td>
            <td>${mapModeLabel(s.mode)}</td>
            <td>${s.surahName ?? String(s.surah ?? '')}</td>
            <td>${s.ayah ?? ''}</td>
            <td>${mapActionLabel(s.action)}</td>
          </tr>
        `).join('');
        $sessionsBody.innerHTML = rowsHtml;
      }
      function addSession(action){
        const now = new Date();
        const curId = +$surah.value; const sObj = SURAHS.find(x=>x.i===curId);
        const entry = {
          ts: now.toISOString(),
          time: fmtClock(now),
          greg: fmtGregorian(now),
          hijri: fmtHijri(now),
          mode: getMode(),
          surah: curId,
          surahName: sObj? sObj.n : String(curId),
          ayah: +$range.value,
          action
        };
        const list = loadSessions();
        list.push(entry); saveSessions(list); renderSessions(); showToast();
      }
      function exportSessionsCSV(){
        const list = loadSessions();
        const header = ['timestamp','time','gregorian','hijri','mode','surahId','surahName','ayah','action'];
        const rows = list.map(s=>[
          s.ts, s.time, s.greg, s.hijri, s.mode, s.surah, s.surahName, s.ayah, s.action
        ]);
        const csv = [header, ...rows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        $csvLink.href = url; $csvLink.download = 'quran-reading-sessions.csv';
        $csvLink.click();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      }

      // ===== Ø£Ø­Ø¯Ø§Ø« =====
      if($mode){
        let savedMode = localStorage.getItem(keyMode());
        if(!savedMode){ savedMode = 'khatmah'; localStorage.setItem(keyMode(), 'khatmah'); }
        $mode.value = savedMode;
        $mode.addEventListener('change', () => { localStorage.setItem(keyMode(), $mode.value); applyMode(); });
      }
      $surah.addEventListener('change', () => {
        localStorage.setItem(keyLast(), $surah.value);
        syncSurahUI(+$surah.value);
        if (getMode() === 'khatmah') computeGlobalProgressContinuous();
      });
      $range.addEventListener('input', () => {
        const i = +$surah.value; const v = +$range.value; const max = +$range.max;
        $ayahLabel.textContent = v; $bar.style.width = (Math.round(v * 100 / max)) + '%';
        localStorage.setItem(keyFor(i), v);
        showToast();
        if (getMode() === 'khatmah') computeGlobalProgressContinuous();
      });

      if($completeBefore){
        $completeBefore.addEventListener('click', () => {
          try{
            const modeNow = getMode();
            if (modeNow !== 'khatmah') { alert('Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù…ØªØ§Ø­ ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø®ØªÙ…Ø©'); return; }
            const curSurahId = +$surah.value;
            const idx = SURAHS.findIndex(x => x.i === curSurahId);
            if (idx < 0) { console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©'); return; }
            if (idx === 0) { alert('Ø§Ù„ÙØ§ØªØ­Ø© Ù‡ÙŠ Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§ Ù‚Ø¨Ù„Ù‡Ø§'); return; }
            if (!confirm('Ø³ÙŠØªÙ… Ø§Ø¹ØªØ¨Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…ÙƒØªÙ…Ù„Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
            for (let j = 0; j < idx; j++) { const s = SURAHS[j]; localStorage.setItem(keyFor(s.i), String(s.v)); }
            if (getSavedAyah(curSurahId) <= 0) { localStorage.setItem(keyFor(curSurahId), '1'); }
            computeGlobalProgressContinuous(); syncSurahUI(curSurahId); showToast();
            addSession('complete_before');
          }catch(err){ console.error('completeBefore error:', err); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„'); }
        });
      }

      if ($reset) {
        $reset.addEventListener('click', () => {
          if (!confirm('Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø© Ø¢ÙŠØ© 1 (Ù„Ù† ØªÙØ­Ø°Ù Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;
          for (const s of SURAHS) localStorage.removeItem(keyFor(s.i));
          localStorage.setItem(keyLast(), '1');
          localStorage.setItem(keyFor(1), '1');
          $surah.value = '1'; syncSurahUI(1);
          if(getMode()==='khatmah') computeGlobalProgressContinuous();
          showToast();
          addSession('reset');
        });
      }

      if($saveSession){ $saveSession.addEventListener('click', ()=> addSession('save')); }
      if($exportSessions){ $exportSessions.addEventListener('click', exportSessionsCSV); }
      if($clearSessions){
        $clearSessions.addEventListener('click', ()=>{
          if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) return;
          localStorage.removeItem(keySessions()); renderSessions(); showToast();
        });
      }

      // ===== ØªÙ‡ÙŠØ¦Ø© =====
      initTheme();
      const last = +(localStorage.getItem(keyLast()) || 1); $surah.value = String(last);
      syncSurahUI(last);
      applyMode();
      renderSessions();

      // ===== Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª =====
      console.assert(SURAHS.length === 114, 'âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙˆØ± 114');
      console.assert(document.getElementById('surah') !== null, 'âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ select#surah');
      console.assert(typeof computeGlobalProgressContinuous === 'function', 'âŒ computeGlobalProgressContinuous ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙØ©');
      console.assert(['khatmah','wird'].includes(($mode.value || 'khatmah')), 'âŒ ÙˆØ¶Ø¹ Ø§Ù„Ù‡Ø¯Ù ØºÙŠØ± ØµØ­ÙŠØ­');
      (function testNoExtraParens(){ let ok = true; try { computeGlobalProgressContinuous(); } catch(e){ ok = false; } console.assert(ok, 'âŒ Ø®Ø·Ø£ ØµÙŠØ§ØºØ© (Ø£Ù‚ÙˆØ§Ø³) ÙÙŠ computeGlobalProgressContinuous'); })();
      (function testDateBlocks(){
        console.assert($clock && $greg && $hijri, 'âŒ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        updateDateTime();
      })();
      (function testWordCount(){
        if(!$note) return;
        const prev = $note.value;
        $note.value = 'Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…';
        updateWordCount();
        console.assert(($noteCount.textContent||'').includes('4'), 'âŒ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ø§ ÙŠØ¹Ø·ÙŠ 4 Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
        $note.value = prev; updateWordCount();
      })();
      (function testSessions(){
        const before = loadSessions().length; addSession('Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'); const after = loadSessions().length;
        console.assert(after === before + 1, 'âŒ Ù„Ù… ØªØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù„Ø³Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„');
        const arr = loadSessions(); arr.pop(); saveSessions(arr);
      })();
      console.assert(!!$completeBefore, 'âŒ Ø²Ø± Ø§Ø¹ØªØ¨Ø± Ù…Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø³ÙˆØ±Ø© Ù…Ø®ØªÙˆÙ…Ù‹Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    });
  </script>
</body>
</html>
