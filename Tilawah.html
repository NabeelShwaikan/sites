<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> متابعة قراءة القرآن الكريم</title>
  <style>
    :root{
      --bg1:#f8fafc; --bg2:#eef2ff; --panel:#ffffff; --ink:#0f172a; --muted:#475569;
      --accent:#16a34a; --accent2:#60a5fa; --warn:#d97706; --danger:#dc2626;
      --border:rgba(2,6,23,.10); --radius:18px; --shadow: 0 14px 36px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Naskh Arabic", "Amiri", Arial, sans-serif;
      background: linear-gradient(160deg,var(--bg1),var(--bg2));
      color:var(--ink); margin:0; padding:24px;
    }
    .wrap{max-width:980px; margin:0 auto;}
    header{display:flex; align-items:start; justify-content:space-between; gap:16px; margin-bottom:20px; flex-wrap:wrap}
    h1{font-size: clamp(1.2rem, 1rem + 1.6vw, 2rem); margin:0}

    .datebox{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{background:var(--panel); border:1px solid var(--border); border-radius:999px; padding:8px 12px; box-shadow:var(--shadow); font-weight:600}
    .chip .sub{font-weight:500; color:var(--muted); margin-inline-start:6px}

    .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px 18px 6px; margin-bottom:18px}
    label{display:block; font-weight:600; margin-bottom:8px}
    select, input[type="range"], button{ width:100%; font-size:1rem; }
    select{ padding:12px; border-radius:14px; border:1px solid var(--border); background:#fff; }
    .row{display:grid; grid-template-columns: 1fr; gap:14px}
    @media (min-width:820px){ .row{ grid-template-columns: 1.2fr 1fr } }

    .stat{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 2px}
    .pill{font-variant-numeric:tabular-nums; background:#f1f5f9; border:1px solid var(--border); padding:6px 10px; border-radius:999px}

    .range-box{padding:12px; background:#f8fafc; border:1px dashed var(--border); border-radius:14px}
    input[type="range"]{ accent-color: var(--accent); }
    .progress{height:10px; border-radius:999px; background:#e2e8f0; overflow:hidden;}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent2));}

    .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .btn{cursor:pointer; border:none; border-radius:12px; padding:10px 14px; font-weight:700}
    .btn.reset{background:#f1f5f9; color:var(--ink); border:1px solid var(--border)}
    .btn.tiny{padding:6px 10px; font-size:.85rem; font-weight:600}

    .notes{margin-top:12px}
    textarea#note{width:100%; border:1px solid var(--border); border-radius:14px; padding:12px; resize:vertical; min-height:96px; font-family:inherit; font-size:1rem; background:#fff; color:var(--ink)}
    .note-meta{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px; color:var(--muted); font-size:.9rem}
    .note-tools{display:flex; gap:8px; margin-top:8px; flex-wrap:wrap}

    .note{color:var(--muted); font-size:.95rem; margin:8px 0 12px}
    .toast{position:fixed; inset-inline:0; bottom:18px; display:flex; justify-content:center; pointer-events:none}
    .toast > div{background:#0ea5e9; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:.25s}
    .toast.show > div{opacity:1; transform:translateY(0)}

    footer{color:var(--muted); font-size:.9rem; text-align:center; margin-top:18px}

    .theme-btn{display:inline-flex; align-items:center; gap:2px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:#fff; color:var(--ink); padding:2px 6px; border-radius:999px; box-shadow:var(--shadow); font-size:.9rem; line-height:1; width:auto; min-width:auto}
    html[data-theme="dark"] .theme-btn{background:#000;}
    .theme-btn:focus{outline:2px solid var(--accent2); outline-offset:3px}

    html[data-theme="dark"]{
      --bg1:#0b1220; --bg2:#0f172a; --panel:#000000; --ink:#e5e7eb; --muted:#94a3b8;
      --accent:#16a34a; --accent2:#38bdf8; --warn:#d97706; --danger:#dc2626;
      --border:rgba(148,163,184,.30);
    }
    html[data-theme="dark"] body{background: linear-gradient(160deg,var(--bg1),var(--bg2));}
    html[data-theme="dark"] select{background:#000000; color:var(--ink); border-color:var(--border)}
    html[data-theme="dark"] .range-box{background:#000000}
    html[data-theme="dark"] .progress{background:#0b0b0b}
    html[data-theme="dark"] .btn.reset{background:#000; color:var(--ink); border:1px solid var(--border)}
    html[data-theme="dark"] .btn{background:#000; color:var(--ink); border:1px solid var(--border)}
    html[data-theme="dark"] .btn.tiny{background:#000; color:var(--ink); border:1px solid var(--border)}
    html[data-theme="dark"] .card{background:#000}
    html[data-theme="dark"] .pill{background:#000; color:var(--ink); border-color:var(--border)}
    html[data-theme="dark"] .note{color:var(--muted)}
    html[data-theme="dark"] textarea#note{background:#000; color:var(--ink); border-color:var(--border)}
    html[data-theme="dark"] .chip{background:#000}

    /* تخصيص القائمة #mode تحديدًا في الوضع الليلي */
    html[data-theme="dark"] #mode{
      background:#000 !important;
      color:#e5e7eb !important;
      border:1px solid var(--border) !important;
    }

    .card.disabled{opacity:.55; filter:grayscale(.15)}

    /* جدول السجل */
    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:8px}
    th, td{padding:10px 12px; border-bottom:1px solid var(--border); font-size:.95rem}
    th{text-align:right; color:var(--muted)}
    tbody tr:hover{background:rgba(2,6,23,.03)}
    html[data-theme="dark"] tbody tr:hover{background:rgba(148,163,184,.06)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>📖 متابعة قراءة القرآن الكريم</h1>
      <div class="datebox">
        <span class="chip" id="clock">--:--:-- <span class="sub">الآن</span></span>
        <span class="chip" id="hijri">— <span class="sub">هجري</span></span>
        <span class="chip" id="greg">— <span class="sub">ميلادي</span></span>
        <button class="theme-btn" id="themeToggle">☀️</button>
        <label for="mode" class="chip" style="display:inline-flex; align-items:center; gap:8px;">
          الهدف:
          <select id="mode" style="width:auto; min-width:140px; border:none; font-weight:700;">
            <option value="khatmah">ختمة</option>
            <option value="wird">ورد يومي</option>
          </select>
        </label>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <div>
          <label for="surah">اختر السورة</label>
          <select id="surah"></select>
          <div class="notes">
            <label for="note">✏️ ملاحظاتك حول السورة</label>
            <textarea id="note" placeholder="اكتب هنا تدبّرك أو ملاحظاتك..."></textarea>
            <div class="note-meta">
              <span id="saveMsg">سيتم الحفظ تلقائيًا بعد توقف الكتابة…</span>
              <span id="noteCount">0 كلمة</span>
            </div>
            <div class="note-tools">
              <button class="btn tiny" id="clearNoteBtn">🗑️ مسح الملاحظة</button>
              <button class="btn tiny" id="exportNotesBtn">⬇️ تصدير كل الملاحظات</button>
            </div>
          </div>
        </div>
        <div>
          <label for="ayahRange">آخر آية وصلت إليها</label>
          <div class="range-box">
            <input id="ayahRange" type="range" min="1" max="7" value="1" step="1" />
            <div class="stat">
              <div>الآية الحالية: <span class="pill" id="ayahLabel">1</span></div>
              <div>عدد الآيات: <span class="pill" id="ayahMax">7</span></div>
            </div>
            <div class="progress"><div class="bar" id="bar"></div></div>
          </div>
          <div class="actions">
            <button class="btn reset" id="resetBtn">إعادة الضبط</button>
            <button class="btn reset" id="completeBeforeBtn">اعتبر ما قبل السورة مختومًا</button>
            <button class="btn" id="saveSessionBtn">💾 حفظ الجلسة</button>
            <button class="btn tiny" id="exportSessionsBtn">⬇️ تصدير السجل (CSV)</button>
            <button class="btn tiny" id="clearSessionsBtn">🗑️ مسح السجل</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="globalProgressCard">
      <label>التقدم العام للختمة</label>
      <div class="stat">
        <div>آيات مكتملة: <span class="pill" id="globalCount">0 / 6236</span></div>
        <div>النسبة: <span class="pill" id="globalPercent">0%</span></div>
      </div>
      <div class="progress"><div class="bar" id="globalBar"></div></div>
      <div id="modeHint" class="note"></div>
    </section>

    <section class="card" id="sessionsCard">
      <label>سجل جلسات القراءة</label>
      <table>
        <thead>
          <tr>
            <th>الوقت</th>
            <th>اليوم (ميلادي / هجري)</th>
            <th>الوضع</th>
            <th>السورة</th>
            <th>الآية</th>
            <th>الإجراء</th>
          </tr>
        </thead>
        <tbody id="sessionsBody"></tbody>
      </table>
      <a id="csvLink" style="display:none"></a>
    </section>

  </div>
  <div class="toast" id="toast"><div>✅ تم الحفظ محليًا</div></div>

  <script>
    'use strict';
    // ===== بيانات السور (114 سورة — مصحف المدينة) =====
    const SURAHS = [
      {i:1,n:"الفاتحة",v:7},{i:2,n:"البقرة",v:286},{i:3,n:"آل عمران",v:200},{i:4,n:"النساء",v:176},
      {i:5,n:"المائدة",v:120},{i:6,n:"الأنعام",v:165},{i:7,n:"الأعراف",v:206},{i:8,n:"الأنفال",v:75},
      {i:9,n:"التوبة",v:129},{i:10,n:"يونس",v:109},{i:11,n:"هود",v:123},{i:12,n:"يوسف",v:111},
      {i:13,n:"الرعد",v:43},{i:14,n:"إبراهيم",v:52},{i:15,n:"الحجر",v:99},{i:16,n:"النحل",v:128},
      {i:17,n:"الإسراء",v:111},{i:18,n:"الكهف",v:110},{i:19,n:"مريم",v:98},{i:20,n:"طه",v:135},
      {i:21,n:"الأنبياء",v:112},{i:22,n:"الحج",v:78},{i:23,n:"المؤمنون",v:118},{i:24,n:"النور",v:64},
      {i:25,n:"الفرقان",v:77},{i:26,n:"الشعراء",v:227},{i:27,n:"النمل",v:93},{i:28,n:"القصص",v:88},
      {i:29,n:"العنكبوت",v:69},{i:30,n:"الروم",v:60},{i:31,n:"لقمان",v:34},{i:32,n:"السجدة",v:30},
      {i:33,n:"الأحزاب",v:73},{i:34,n:"سبأ",v:54},{i:35,n:"فاطر",v:45},{i:36,n:"يس",v:83},
      {i:37,n:"الصافات",v:182},{i:38,n:"ص",v:88},{i:39,n:"الزمر",v:75},{i:40,n:"غافر",v:85},
      {i:41,n:"فصلت",v:54},{i:42,n:"الشورى",v:53},{i:43,n:"الزخرف",v:89},{i:44,n:"الدخان",v:59},
      {i:45,n:"الجاثية",v:37},{i:46,n:"الأحقاف",v:35},{i:47,n:"محمد",v:38},{i:48,n:"الفتح",v:29},
      {i:49,n:"الحجرات",v:18},{i:50,n:"ق",v:45},{i:51,n:"الذاريات",v:60},{i:52,n:"الطور",v:49},
      {i:53,n:"النجم",v:62},{i:54,n:"القمر",v:55},{i:55,n:"الرحمن",v:78},{i:56,n:"الواقعة",v:96},
      {i:57,n:"الحديد",v:29},{i:58,n:"المجادلة",v:22},{i:59,n:"الحشر",v:24},{i:60,n:"الممتحنة",v:13},
      {i:61,n:"الصف",v:14},{i:62,n:"الجمعة",v:11},{i:63,n:"المنافقون",v:11},{i:64,n:"التغابن",v:18},
      {i:65,n:"الطلاق",v:12},{i:66,n:"التحريم",v:12},{i:67,n:"الملك",v:30},{i:68,n:"القلم",v:52},
      {i:69,n:"الحاقة",v:52},{i:70,n:"المعارج",v:44},{i:71,n:"نوح",v:28},{i:72,n:"الجن",v:28},
      {i:73,n:"المزمل",v:20},{i:74,n:"المدثر",v:56},{i:75,n:"القيامة",v:40},{i:76,n:"الإنسان",v:31},
      {i:77,n:"المرسلات",v:50},{i:78,n:"النبأ",v:40},{i:79,n:"النازعات",v:46},{i:80,n:"عبس",v:42},
      {i:81,n:"التكوير",v:29},{i:82,n:"الانفطار",v:19},{i:83,n:"المطففين",v:36},{i:84,n:"الانشقاق",v:25},
      {i:85,n:"البروج",v:22},{i:86,n:"الطارق",v:17},{i:87,n:"الأعلى",v:19},{i:88,n:"الغاشية",v:26},
      {i:89,n:"الفجر",v:30},{i:90,n:"البلد",v:20},{i:91,n:"الشمس",v:15},{i:92,n:"الليل",v:21},
      {i:93,n:"الضحى",v:11},{i:94,n:"الشرح",v:8},{i:95,n:"التين",v:8},{i:96,n:"العلق",v:19},
      {i:97,n:"القدر",v:5},{i:98,n:"البينة",v:8},{i:99,n:"الزلزلة",v:8},{i:100,n:"العاديات",v:11},
      {i:101,n:"القارعة",v:11},{i:102,n:"التكاثر",v:8},{i:103,n:"العصر",v:3},{i:104,n:"الهمزة",v:9},
      {i:105,n:"الفيل",v:5},{i:106,n:"قريش",v:4},{i:107,n:"الماعون",v:7},{i:108,n:"الكوثر",v:3},
      {i:109,n:"الكافرون",v:6},{i:110,n:"النصر",v:3},{i:111,n:"المسد",v:5},{i:112,n:"الإخلاص",v:4},
      {i:113,n:"الفلق",v:5},{i:114,n:"الناس",v:6}
    ];

    document.addEventListener('DOMContentLoaded', () => {
      // عناصر DOM
      const $surah = document.getElementById('surah');
      const $range = document.getElementById('ayahRange');
      const $ayahLabel = document.getElementById('ayahLabel');
      const $ayahMax = document.getElementById('ayahMax');
      const $bar = document.getElementById('bar');
      const $globalBar = document.getElementById('globalBar');
      const $globalPercent = document.getElementById('globalPercent');
      const $globalCount = document.getElementById('globalCount');
      const $mode = document.getElementById('mode');
      const $completeBefore = document.getElementById('completeBeforeBtn');
      const $toast = document.getElementById('toast');
      const $reset = document.getElementById('resetBtn');
      const $themeToggle = document.getElementById('themeToggle');
      const $html = document.documentElement;
      const $clock = document.getElementById('clock');
      const $greg = document.getElementById('greg');
      const $hijri = document.getElementById('hijri');
      const $saveSession = document.getElementById('saveSessionBtn');
      const $exportSessions = document.getElementById('exportSessionsBtn');
      const $clearSessions = document.getElementById('clearSessionsBtn');
      const $sessionsBody = document.getElementById('sessionsBody');
      const $csvLink = document.getElementById('csvLink');
      const $note = document.getElementById('note');
      const $noteCount = document.getElementById('noteCount');
      const $saveMsg = document.getElementById('saveMsg');
      const $clearNoteBtn = document.getElementById('clearNoteBtn');
      const $exportNotesBtn = document.getElementById('exportNotesBtn');

      // مفاتيح التخزين
      const keyFor = (i) => `qread:${i}`;
      const keyMode = () => 'qread:mode';
      const keyLast = () => 'qread:last';
      const keySessions = () => 'qread:sessions';
      const keyNote = (i) => `qread:note:${i}`;

      // بناء القائمة
      $surah.innerHTML = SURAHS.map(s => `<option value="${s.i}">${s.i}. ${s.n}</option>`).join('');

      // ===== الثيم =====
      function setTheme(t){
        const theme = (t === 'dark') ? 'dark' : 'light';
        $html.setAttribute('data-theme', theme);
        localStorage.setItem('qread:theme', theme);
        $themeToggle.textContent = (theme === 'dark') ? '🌙' : '☀️';
        $themeToggle.title = (theme === 'dark') ? 'الوضع الليلي' : 'الوضع النهاري';
      }
      function initTheme(){
        const saved = localStorage.getItem('qread:theme');
        if(saved){ setTheme(saved); }
        else{
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          setTheme(prefersDark ? 'dark' : 'light');
        }
      }
      if($themeToggle){
        $themeToggle.addEventListener('click', ()=>{
          const cur = $html.getAttribute('data-theme') || 'light';
          setTheme(cur === 'light' ? 'dark' : 'light');
        });
      }

      // ===== التاريخ والوقت =====
      function fmtGregorian(d){
        return new Intl.DateTimeFormat('ar', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(d);
      }
      function fmtHijri(d){
        return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {weekday:'long', year:'numeric', month:'long', day:'numeric'}).format(d);
      }
      function fmtClock(d){
        const pad = (n)=> String(n).padStart(2,'0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
      function updateDateTime(){
        const now = new Date();
        if($clock) $clock.firstChild.nodeValue = fmtClock(now) + ' ';
        if($greg) $greg.firstChild.nodeValue = fmtGregorian(now) + ' ';
        if($hijri) $hijri.firstChild.nodeValue = fmtHijri(now) + ' ';
      }
      updateDateTime();
      setInterval(updateDateTime, 1000);

      // ===== أدوات عامة =====
      const showToast = () => { $toast.classList.add('show'); setTimeout(() => $toast.classList.remove('show'), 800); };
      const getMode = () => ($mode && $mode.value) || 'khatmah';
      const getSavedAyah = (i) => {
        const raw = localStorage.getItem(keyFor(i));
        if (!raw) return 0;
        const s = SURAHS.find(x => x.i === i);
        return Math.min(Math.max(+raw || 0, 0), s ? s.v : 0);
      };

      // ===== المؤشر العام =====
      const TOTAL_AYAT = 6236;
      function computeGlobalProgressContinuous(){
        let sum = 0;
        for (const s of SURAHS) {
          const v = getSavedAyah(s.i);
          if (v <= 0) break;
          if (v >= s.v) { sum += s.v; } else { sum += v; break; }
        }
        const pct = Math.max(0, Math.min(100, Math.round(sum * 100 / TOTAL_AYAT)));
        if($globalBar) $globalBar.style.width = pct + '%';
        if($globalPercent) $globalPercent.textContent = pct + '%';
        if($globalCount) $globalCount.textContent = sum + ' / ' + TOTAL_AYAT;
      }

      // ===== الملاحظات + عدّاد الكلمات =====
      function countWords(text){
        const t = (text || '').replace(/[\u200f\u200e]/g,'').trim();
        if(!t) return 0;
        const tokens = t.match(/[\p{L}\p{N}]+/gu);
        return tokens ? tokens.length : 0;
      }
      function updateWordCount(){
        if(!$noteCount || !$note) return;
        const c = countWords($note.value);
        $noteCount.textContent = `${c} كلمة`;
      }
      let noteSaveTimer = null;
      function scheduleNoteSave(){
        if(!$note || !$saveMsg) return;
        $saveMsg.textContent = '... جارٍ الحفظ';
        clearTimeout(noteSaveTimer);
        noteSaveTimer = setTimeout(()=>{
          const sid = +$surah.value || 1;
          localStorage.setItem(keyNote(sid), $note.value || '');
          $saveMsg.textContent = 'تم الحفظ';
          setTimeout(()=>{ $saveMsg.textContent = 'سيتم الحفظ تلقائيًا بعد توقف الكتابة…'; }, 1200);
        }, 500);
      }
      if($note){
        $note.addEventListener('input', ()=>{ updateWordCount(); scheduleNoteSave(); });
      }
      if($clearNoteBtn && $note){
        $clearNoteBtn.addEventListener('click', ()=>{
          if(!confirm('مسح ملاحظة هذه السورة؟')) return;
          $note.value = '';
          updateWordCount();
          const sid = +$surah.value || 1;
          localStorage.setItem(keyNote(sid), '');
          if($saveMsg) $saveMsg.textContent = 'تم الحفظ';
        });
      }
      if($exportNotesBtn){
        $exportNotesBtn.addEventListener('click', ()=>{
          const rows = [['surahId','surahName','words','note']];
          for(const s of SURAHS){
            const txt = localStorage.getItem(keyNote(s.i)) || '';
            rows.push([s.i, s.n, countWords(txt), txt.replaceAll('"','""')]);
          }
          const csv = rows.map(r=>r.map(c=>`"${String(c)}"`).join(',')).join('\n');
          const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          $csvLink.href = url; $csvLink.download = 'quran-notes.csv'; $csvLink.click();
          setTimeout(()=> URL.revokeObjectURL(url), 800);
        });
      }

      // ===== مزامنة واجهة السورة =====
      function syncSurahUI(i){
        const s = SURAHS.find(x => x.i === i); if (!s) return;
        const saved = Math.max(1, Math.min(getSavedAyah(i) || 1, s.v));
        $range.max = s.v; $ayahMax.textContent = s.v; $range.value = saved; $ayahLabel.textContent = saved;
        const p = Math.round(saved * 100 / s.v); $bar.style.width = p + '%';
        // تحميل الملاحظة لهذه السورة
        if($note){
          const txt = localStorage.getItem(keyNote(i)) || '';
          $note.value = txt; updateWordCount();
        }
      }

      // ===== وضع الهدف =====
      function setCompleteBeforeEnabled(enabled){
        const btn = document.getElementById('completeBeforeBtn');
        if(!btn) return;
        btn.disabled = !enabled;
        btn.setAttribute('aria-disabled', enabled ? 'false' : 'true');
        btn.title = enabled ? 'اعتبار ما قبل السورة مقروءا' : 'غير متاح في وضع الورد اليومي';
        btn.style.opacity = enabled ? '1' : '.6';
        btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
      }
      function applyMode(){
        const m = ($mode && $mode.value) || 'khatmah';
        const card = document.getElementById('globalProgressCard');
        const hint = document.getElementById('modeHint');
        const isWird = m === 'wird';
        if(card){
          card.classList.toggle('disabled', isWird);
          card.setAttribute('aria-disabled', isWird ? 'true' : 'false');
        }
        if(hint) hint.textContent = isWird ? 'غير مفعل في وضع الورد اليومي' : '';
        setCompleteBeforeEnabled(!isWird);
        if(!isWird) computeGlobalProgressContinuous();
      }

      // ===== سجل الجلسات =====
      function loadSessions(){
        try{ return JSON.parse(localStorage.getItem(keySessions())||'[]'); }catch{ return []; }
      }
      function saveSessions(list){ localStorage.setItem(keySessions(), JSON.stringify(list)); }
      function renderSessions(){
        const sessionsList = loadSessions().slice().reverse();
        if(!$sessionsBody) return;
        const mapModeLabel = (modeValue) => ({ khatmah: 'ختمة', wird: 'ورد يومي' }[modeValue] || modeValue);
        const mapActionLabel = (actionValue) => ({
          save: 'حفظ الجلسة',
          save_session: 'حفظ الجلسة',
          complete_before: 'اعتبار ما قبل السورة مختومًا',
          reset: 'إعادة الضبط',
        }[actionValue] || actionValue);
        const rowsHtml = sessionsList.map((s)=>`
          <tr>
            <td>${s.time || ''}</td>
            <td>${(s.greg || '')} / ${(s.hijri || '')}</td>
            <td>${mapModeLabel(s.mode)}</td>
            <td>${s.surahName ?? String(s.surah ?? '')}</td>
            <td>${s.ayah ?? ''}</td>
            <td>${mapActionLabel(s.action)}</td>
          </tr>
        `).join('');
        $sessionsBody.innerHTML = rowsHtml;
      }
      function addSession(action){
        const now = new Date();
        const curId = +$surah.value; const sObj = SURAHS.find(x=>x.i===curId);
        const entry = {
          ts: now.toISOString(),
          time: fmtClock(now),
          greg: fmtGregorian(now),
          hijri: fmtHijri(now),
          mode: getMode(),
          surah: curId,
          surahName: sObj? sObj.n : String(curId),
          ayah: +$range.value,
          action
        };
        const list = loadSessions();
        list.push(entry); saveSessions(list); renderSessions(); showToast();
      }
      function exportSessionsCSV(){
        const list = loadSessions();
        const header = ['timestamp','time','gregorian','hijri','mode','surahId','surahName','ayah','action'];
        const rows = list.map(s=>[
          s.ts, s.time, s.greg, s.hijri, s.mode, s.surah, s.surahName, s.ayah, s.action
        ]);
        const csv = [header, ...rows].map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        $csvLink.href = url; $csvLink.download = 'quran-reading-sessions.csv';
        $csvLink.click();
        setTimeout(()=> URL.revokeObjectURL(url), 1000);
      }

      // ===== أحداث =====
      if($mode){
        let savedMode = localStorage.getItem(keyMode());
        if(!savedMode){ savedMode = 'khatmah'; localStorage.setItem(keyMode(), 'khatmah'); }
        $mode.value = savedMode;
        $mode.addEventListener('change', () => { localStorage.setItem(keyMode(), $mode.value); applyMode(); });
      }
      $surah.addEventListener('change', () => {
        localStorage.setItem(keyLast(), $surah.value);
        syncSurahUI(+$surah.value);
        if (getMode() === 'khatmah') computeGlobalProgressContinuous();
      });
      $range.addEventListener('input', () => {
        const i = +$surah.value; const v = +$range.value; const max = +$range.max;
        $ayahLabel.textContent = v; $bar.style.width = (Math.round(v * 100 / max)) + '%';
        localStorage.setItem(keyFor(i), v);
        showToast();
        if (getMode() === 'khatmah') computeGlobalProgressContinuous();
      });

      if($completeBefore){
        $completeBefore.addEventListener('click', () => {
          try{
            const modeNow = getMode();
            if (modeNow !== 'khatmah') { alert('هذا الخيار متاح فقط في وضع الختمة'); return; }
            const curSurahId = +$surah.value;
            const idx = SURAHS.findIndex(x => x.i === curSurahId);
            if (idx < 0) { console.warn('لم يتم العثور على السورة الحالية'); return; }
            if (idx === 0) { alert('الفاتحة هي الأولى ولا يوجد ما قبلها'); return; }
            if (!confirm('سيتم اعتبار جميع السور السابقة مكتملة. هل أنت متأكد؟')) return;
            for (let j = 0; j < idx; j++) { const s = SURAHS[j]; localStorage.setItem(keyFor(s.i), String(s.v)); }
            if (getSavedAyah(curSurahId) <= 0) { localStorage.setItem(keyFor(curSurahId), '1'); }
            computeGlobalProgressContinuous(); syncSurahUI(curSurahId); showToast();
            addSession('complete_before');
          }catch(err){ console.error('completeBefore error:', err); alert('حدث خطأ أثناء الإكمال'); }
        });
      }

      if ($reset) {
        $reset.addEventListener('click', () => {
          if (!confirm('سيتم إعادة ضبط التقدم والعودة إلى سورة الفاتحة آية 1 (لن تُحذف الملاحظات). هل أنت متأكد؟')) return;
          for (const s of SURAHS) localStorage.removeItem(keyFor(s.i));
          localStorage.setItem(keyLast(), '1');
          localStorage.setItem(keyFor(1), '1');
          $surah.value = '1'; syncSurahUI(1);
          if(getMode()==='khatmah') computeGlobalProgressContinuous();
          showToast();
          addSession('reset');
        });
      }

      if($saveSession){ $saveSession.addEventListener('click', ()=> addSession('save')); }
      if($exportSessions){ $exportSessions.addEventListener('click', exportSessionsCSV); }
      if($clearSessions){
        $clearSessions.addEventListener('click', ()=>{
          if(!confirm('هل تريد مسح سجل الجلسات بالكامل؟')) return;
          localStorage.removeItem(keySessions()); renderSessions(); showToast();
        });
      }

      // ===== تهيئة =====
      initTheme();
      const last = +(localStorage.getItem(keyLast()) || 1); $surah.value = String(last);
      syncSurahUI(last);
      applyMode();
      renderSessions();

      // ===== اختبارات =====
      console.assert(SURAHS.length === 114, '❌ يجب أن يكون عدد السور 114');
      console.assert(document.getElementById('surah') !== null, '❌ لم يتم العثور على select#surah');
      console.assert(typeof computeGlobalProgressContinuous === 'function', '❌ computeGlobalProgressContinuous غير معرّفة');
      console.assert(['khatmah','wird'].includes(($mode.value || 'khatmah')), '❌ وضع الهدف غير صحيح');
      (function testNoExtraParens(){ let ok = true; try { computeGlobalProgressContinuous(); } catch(e){ ok = false; } console.assert(ok, '❌ خطأ صياغة (أقواس) في computeGlobalProgressContinuous'); })();
      (function testDateBlocks(){
        console.assert($clock && $greg && $hijri, '❌ عناصر التاريخ/الوقت غير موجودة');
        updateDateTime();
      })();
      (function testWordCount(){
        if(!$note) return;
        const prev = $note.value;
        $note.value = 'بسم الله الرحمن الرحيم';
        updateWordCount();
        console.assert(($noteCount.textContent||'').includes('4'), '❌ عداد الكلمات لا يعطي 4 لكلمة الاختبار');
        $note.value = prev; updateWordCount();
      })();
      (function testSessions(){
        const before = loadSessions().length; addSession('بداية القراءة'); const after = loadSessions().length;
        console.assert(after === before + 1, '❌ لم تتم إضافة جلسة إلى السجل');
        const arr = loadSessions(); arr.pop(); saveSessions(arr);
      })();
      console.assert(!!$completeBefore, '❌ زر اعتبر ما قبل السورة مختومًا غير موجود');
    });
  </script>
</body>
</html>
