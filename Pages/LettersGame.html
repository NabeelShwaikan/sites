<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ â€” Ø£Ø³Ù…Ø§Ø¡ØŒ Ø­ÙŠÙˆØ§Ù†ØŒ Ù†Ø¨Ø§Øªâ€¦</title>
  <style>
    :root {
      --bg: #0f172a;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --card: #111827;
      --border: #1f2937;
      --field: #020617;
      --accent: #22c55e;
      --accent-soft: #064e3b;
      --danger: #b91c1c;
      --shadow: 0 10px 25px rgba(15,23,42,0.5);
    }

    body[data-theme="light"] {
      --bg: #f3f4f6;
      --fg: #111827;
      --muted: #6b7280;
      --card: #ffffff;
      --border: #e5e7eb;
      --field: #f9fafb;
      --accent: #16a34a;
      --accent-soft: #dcfce7;
      --danger: #b91c1c;
      --shadow: 0 10px 25px rgba(15,23,42,0.1);
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
      margin: 0;
      padding: 16px;
      box-sizing: border-box;
      transition: background 0.25s ease, color 0.25s ease;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .muted {
      color: var(--muted);
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    .card {
      background: var(--card);
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: background 0.25s ease, border-color 0.25s ease;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .row > * {
      flex: 1 1 0;
      min-width: 0;
    }
    label {
      font-size: 0.9rem;
      margin-bottom: 4px;
      display: block;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--field);
      color: var(--fg);
      box-sizing: border-box;
      font-size: 0.9rem;
      transition: background 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }
    input[type="number"] {
      text-align: center;
    }
    input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    select {
      cursor: pointer;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.2s ease, color 0.2s ease;
    }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
    }
    button.primary {
      background: var(--accent);
      color: #022c22;
      font-weight: 600;
    }
    button.secondary {
      background: var(--field);
      color: var(--fg);
    }
    button.danger {
      background: var(--danger);
      color: #fee2e2;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--field);
      color: var(--fg);
      border: 1px solid var(--border);
    }
    .big-letter {
      font-size: 3rem;
      font-weight: 700;
      text-align: center;
      margin: 6px 0;
    }
    .center {
      text-align: center;
    }
    .small {
      font-size: 0.8rem;
    }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
    }
    .field-card {
      background: var(--field);
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid var(--border);
    }
    .field-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 0.85rem;
      color: #cbd5f5;
    }
    body[data-theme="light"] .field-header {
      color: #1f2937;
    }
    .score-input {
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .score-input input {
      max-width: 60px;
    }
    .totals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }
    .totals-row .box {
      background: var(--field);
      border-radius: 10px;
      padding: 6px 10px;
      border: 1px solid var(--border);
      min-width: 120px;
      text-align: center;
      font-size: 0.9rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    th, td {
      border-bottom: 1px solid var(--border);
      padding: 6px 4px;
      text-align: center;
    }
    th {
      background: var(--field);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .letter-tag {
      font-weight: 700;
      font-size: 1rem;
    }
    .pill {
      border-radius: 999px;
      padding: 2px 8px;
      background: var(--field);
      border: 1px solid var(--border);
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .timer-big {
      font-size: 2.2rem;
      font-weight: 700;
      text-align: center;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 12px;
      display: inline-block;
      min-width: 140px;
      background: var(--field);
      border: 2px solid var(--border);
    }
    .timer-green {
      border-color: #22c55e;
      color: #22c55e;
    }
    .timer-yellow {
      border-color: #eab308;
      color: #eab308;
    }
    .timer-red {
      border-color: #ef4444;
      color: #ef4444;
    }
    .flip-letters {
      font-family: "Courier New", monospace;
      font-size: 1.5rem;
      letter-spacing: 0.25rem;
      text-align: center;
      margin-top: 4px;
      min-height: 2rem;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.3rem; }
      .big-letter { font-size: 2.4rem; }
      .row { flex-direction: column; align-items: stretch; }
      .timer-big { font-size: 1.8rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div>
        <button id="themeToggle" class="secondary" type="button">ğŸŒ™ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ</button>
      </div>
      <div>
        <button id="newMatchBtn" class="secondary" type="button">ğŸ”„ Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>
    </div>

    <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</h1>
    <div class="muted">
      Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© Ù†ÙØ³Ù‡ Ù„ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ Ø«Ù… Ø§Ø¶ØºØ· â€œØ§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©â€.<br>
      ØªØ¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø£Ù‚Ø±Ø¨ Ø¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø© â±ï¸
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div class="card">
      <div class="row" style="margin-bottom: 8px;">
        <div>
          <label for="roomCode">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (ÙŠØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†)</label>
          <input id="roomCode" type="text" placeholder="Ù…Ø«Ø§Ù„: CLASSA2025" />
        </div>
        <div>
          <label for="roundDuration">Ù…Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© (Ø«ÙˆØ§Ù†Ù)</label>
          <select id="roundDuration">
            <option value="30">30 Ø«Ø§Ù†ÙŠØ© (Ø³Ø±ÙŠØ¹)</option>
            <option value="60" selected>60 Ø«Ø§Ù†ÙŠØ© (Ø§ÙØªØ±Ø§Ø¶ÙŠ)</option>
            <option value="90">90 Ø«Ø§Ù†ÙŠØ© (Ù…Ø±ÙŠØ­)</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="center">
          <button id="startRoundBtn" class="primary" type="button">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
        </div>
        <div class="center">
          <button id="endGameBtn" class="danger" type="button">â›” Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
        </div>
      </div>
      <div class="row" style="margin-top: 8px;">
        <div class="center small">
          <span class="badge">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentRound">0</span></span>
        </div>
        <div class="center small">
          <span class="badge">Ø­Ø±ÙˆÙ Ù…ÙØ³ØªØ®Ø¯Ù…Ø©: <span id="usedLettersCount">0</span> / 28</span>
        </div>
      </div>
      <div class="row" style="margin-top: 6px;">
        <div class="center small">
          <span id="syncInfo" class="pill">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø±Ø§Ø©â€¦</span>
        </div>
        <div class="center small">
          Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ: <span id="nowTime">--:--:--</span>
        </div>
      </div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±Ù ÙˆØ§Ù„Ø¬ÙˆÙ„Ø© -->
    <div class="card">
      <div class="center small" style="margin-bottom: 4px;">
        Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¹Ù†Ø¯: <span id="scheduledStart">â€”</span><br>
        Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø©:
      </div>
      <div class="center">
        <span id="preCountdown" class="timer-big timer-green">â€”</span>
      </div>
      <div class="flip-letters" id="flipLetters"> </div>

      <div class="big-letter" id="currentLetter">â€”</div>
      <div class="center small" style="margin-top: 4px;">
        Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø¬ÙˆÙ„Ø©:
      </div>
      <div class="center">
        <span id="roundCountdown" class="timer-big timer-green">â€”</span>
      </div>
    </div>

    <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
    <div class="card">
      <div class="row" style="margin-bottom: 6px;">
        <div class="box">
          <span>Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©: </span>
          <strong><span id="roundTotal">0</span> Ù†Ù‚Ø·Ø©</strong>
        </div>
        <div class="box">
          <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†: </span>
          <strong><span id="globalTotal">0</span> Ù†Ù‚Ø·Ø©</strong>
        </div>
      </div>

      <div class="grid-2" id="fieldsContainer">
        <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
      </div>

      <div class="totals-row">
        <div class="small">
          <button id="saveRoundBtn" class="secondary" disabled type="button">ğŸ’¾ ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
          <span style="margin-right:6px;font-size:0.8rem;color:var(--muted);">
            Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚ØªØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (0 / 5 / 10) Ø«Ù… Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø©.
          </span>
        </div>
      </div>
    </div>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª -->
    <div class="card">
      <div class="row" style="margin-bottom: 4px;">
        <div><strong>Ø³Ø¬Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª</strong></div>
        <div class="small" style="text-align:left;">
          ÙŠÙ…ÙƒÙ† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ØªÙØ³ØªØ®Ø¯Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø±Ù.
        </div>
      </div>
      <div style="max-height: 230px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th># Ø§Ù„Ø¬ÙˆÙ„Ø©</th>
              <th>Ø§Ù„Ø­Ø±Ù</th>
              <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¬ÙˆÙ„Ø©</th>
            </tr>
          </thead>
          <tbody id="roundsTableBody">
            <!-- Ø§Ù„ØµÙÙˆÙ ØªÙØ¶Ø§Ù Ù‡Ù†Ø§ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ----- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø±ÙˆÙ -----
    const LETTERS = [
      'Ø£','Ø¨','Øª','Ø«','Ø¬','Ø­','Ø®',
      'Ø¯','Ø°','Ø±','Ø²','Ø³','Ø´',
      'Øµ','Ø¶','Ø·','Ø¸','Ø¹','Øº',
      'Ù','Ù‚','Ùƒ','Ù„','Ù…','Ù†','Ù‡Ù€','Ùˆ','ÙŠ'
    ];

    const FIELDS = [
      'Ø§Ø³Ù… Ø¹Ù„Ù… Ù…Ø°ÙƒÙ‘Ø±',
      'Ø§Ø³Ù… Ø¹Ù„Ù… Ù…Ø¤Ù†Ù‘Ø«',
      'Ø­ÙŠÙˆØ§Ù†',
      'Ø·Ø§Ø¦Ø±',
      'Ù†Ø¨Ø§Øª',
      'Ø¬Ù…Ø§Ø¯',
      'Ø¯ÙˆÙ„Ø©',
      'Ù…Ø¯ÙŠÙ†Ø©'
    ];

    // Ø¹Ù†Ø§ØµØ± DOM
    const roomCodeInput = document.getElementById('roomCode');
    const roundDurationSelect = document.getElementById('roundDuration');
    const startRoundBtn = document.getElementById('startRoundBtn');
    const endGameBtn = document.getElementById('endGameBtn');
    const newMatchBtn = document.getElementById('newMatchBtn');
    const themeToggleBtn = document.getElementById('themeToggle');

    const currentRoundSpan = document.getElementById('currentRound');
    const usedLettersCountSpan = document.getElementById('usedLettersCount');
    const nowTimeSpan = document.getElementById('nowTime');
    const syncInfoSpan = document.getElementById('syncInfo');
    const scheduledStartSpan = document.getElementById('scheduledStart');
    const preCountdownSpan = document.getElementById('preCountdown');
    const roundCountdownSpan = document.getElementById('roundCountdown');
    const currentLetterSpan = document.getElementById('currentLetter');
    const flipLettersSpan = document.getElementById('flipLetters');

    const roundTotalSpan = document.getElementById('roundTotal');
    const globalTotalSpan = document.getElementById('globalTotal');
    const fieldsContainer = document.getElementById('fieldsContainer');
    const saveRoundBtn = document.getElementById('saveRoundBtn');
    const roundsTableBody = document.getElementById('roundsTableBody');

    // Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
    let gameActive = true;
    let currentRound = 0;
    let pendingRound = null;        // Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    let preCountdownTimer = null;   // Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­ØªÙ‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
    let flipLettersTimer = null;    // Ù…Ø¤Ø«Ø± Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…ØªÙ‚Ù„Ø¨Ø©
    let roundTimer = null;          // Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø©
    let scheduledStartTime = null;  // ÙˆÙ‚Øª Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
    let usedLetters = [];
    let globalTotal = 0;
    let roundFields = [];           // Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
    const roundResults = {};        // ØªØ®Ø²ÙŠÙ† Ù†ØªÙŠØ¬Ø© ÙƒÙ„ Ø¬ÙˆÙ„Ø©: { roundNumber: { total, row } }

    // --- Ø«ÙŠÙ… Ù„ÙŠÙ„ÙŠ/Ù†Ù‡Ø§Ø±ÙŠ ---
    function applyTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      if (theme === 'light') {
        themeToggleBtn.textContent = 'â˜€ï¸ ÙˆØ¶Ø¹ Ù†Ù‡Ø§Ø±ÙŠ';
      } else {
        themeToggleBtn.textContent = 'ğŸŒ™ ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ';
      }
      localStorage.setItem('lettersGameTheme', theme);
    }

    const savedTheme = localStorage.getItem('lettersGameTheme') || 'dark';
    applyTheme(savedTheme);

    themeToggleBtn.addEventListener('click', () => {
      const current = document.body.getAttribute('data-theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });

    // --- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø© ---
    function buildFields() {
      fieldsContainer.innerHTML = '';
      roundFields = [];
      FIELDS.forEach((labelText) => {
        const wrapper = document.createElement('div');
        wrapper.className = 'field-card';

        const header = document.createElement('div');
        header.className = 'field-header';
        header.innerHTML = `<span>${labelText}</span><span class="small">ÙƒÙ„Ù…Ø© + Ø¯Ø±Ø¬Ø©</span>`;
        wrapper.appendChild(header);

        const wordInput = document.createElement('input');
        wordInput.type = 'text';
        wordInput.placeholder = 'Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ù‡Ù†Ø§';
        wordInput.disabled = true;
        wrapper.appendChild(wordInput);

        const scoreWrapper = document.createElement('div');
        scoreWrapper.className = 'score-input';
        const scoreLabel = document.createElement('span');
        scoreLabel.textContent = 'Ø§Ù„Ø¯Ø±Ø¬Ø©:';
        const scoreInput = document.createElement('input');
        scoreInput.type = 'number';
        scoreInput.min = '0';
        scoreInput.max = '10';
        scoreInput.step = '5';
        scoreInput.value = '';
        scoreInput.disabled = true;

        scoreInput.addEventListener('input', () => {
          clampScore(scoreInput);
          updateRoundTotal();
        });

        scoreWrapper.appendChild(scoreLabel);
        scoreWrapper.appendChild(scoreInput);
        wrapper.appendChild(scoreWrapper);

        fieldsContainer.appendChild(wrapper);

        roundFields.push({
          wordInput,
          scoreInput,
          scoreWrapper
        });
      });
    }

    function clampScore(input) {
      if (input.value === '') return;
      let v = parseInt(input.value, 10);
      if (isNaN(v)) { input.value = ''; return; }
      if (v < 0) v = 0;
      if (v > 10) v = 10;
      const mod = v % 5;
      if (mod !== 0) {
        v = v - mod + (mod >= 3 ? 5 : 0);
      }
      input.value = v;
    }

    function updateRoundTotal() {
      let sum = 0;
      roundFields.forEach(f => {
        const v = parseInt(f.scoreInput.value, 10);
        if (!isNaN(v)) sum += v;
      });
      roundTotalSpan.textContent = sum;
    }

    // ---- ØªÙ…ÙƒÙŠÙ† / ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ----
    function setWordInputsEnabled(enabled) {
      roundFields.forEach(f => {
        f.wordInput.disabled = !enabled;
      });
    }

    function setScoreInputsEnabled(enabled) {
      roundFields.forEach(f => {
        f.scoreInput.disabled = !enabled;
      });
    }

    function showScores(show) {
      roundFields.forEach(f => {
        f.scoreWrapper.style.display = show ? 'flex' : 'none';
      });
    }

    function clearCurrentRoundInputs() {
      roundFields.forEach(f => {
        f.wordInput.value = '';
        f.scoreInput.value = '';
      });
      roundTotalSpan.textContent = '0';
    }

    // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ---
    function updateNowTime() {
      const now = new Date();
      nowTimeSpan.textContent = now.toLocaleTimeString('ar-SA', { hour12: false });
    }
    setInterval(updateNowTime, 500);
    updateNowTime();

    // --- Ø­Ø³Ø§Ø¨ Ø£Ù‚Ø±Ø¨ Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø© Ù‚Ø§Ø¯Ù…Ø© ---
    function getNextMinuteDate() {
      const now = new Date();
      const next = new Date(now);
      next.setSeconds(0, 0);
      if (now.getSeconds() > 0 || now.getMilliseconds() > 0) {
        next.setMinutes(next.getMinutes() + 1);
      }
      return next;
    }

    function formatTime(date) {
      if (!date) return 'â€”';
      return date.toLocaleTimeString('ar-SA', { hour12: false });
    }

    // --- Ø¯Ø§Ù„Ø© Ù‡Ø§Ø´ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù…Ù† Ø§Ù„Ù†Øµ ---
    function hashStringToInt(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = (hash * 31 + str.charCodeAt(i)) >>> 0;
      }
      return hash;
    }

    // --- Ø§Ø®ØªÙŠØ§Ø± Ø­Ø±Ù Ù„Ù„Ø¬ÙˆÙ„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© + Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© ---
    function pickLetter(roomCode, roundNumber) {
      if (!roomCode || roundNumber <= 0) return 'â€”';
      const baseSeed = hashStringToInt(roomCode + '#' + roundNumber);
      let availableLetters = LETTERS.slice();

      // Ù†Ø­Ø°Ù Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø³Ø§Ø¨Ù‚Ù‹Ø§
      usedLetters.forEach(l => {
        const idx = availableLetters.indexOf(l);
        if (idx !== -1) availableLetters.splice(idx, 1);
      });

      // Ù„Ùˆ Ø§Ù†ØªÙ‡Øª ÙƒÙ„ Ø§Ù„Ø£Ø­Ø±Ù Ù†Ø±Ø¬Ø¹ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯
      if (availableLetters.length === 0) {
        availableLetters = LETTERS.slice();
        usedLetters = [];
      }

      const idx = baseSeed % availableLetters.length;
      const letter = availableLetters[idx];
      return letter;
    }

    // --- Ù…Ø¤Ù‚Øª Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…ØªÙ‚Ù„Ø¨Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ---
    function startFlipLetters() {
      stopFlipLetters();
      flipLettersTimer = setInterval(() => {
        let out = '';
        for (let i = 0; i < 3; i++) {
          const randomIndex = Math.floor(Math.random() * LETTERS.length);
          out += LETTERS[randomIndex] + ' ';
        }
        flipLettersSpan.textContent = out.trim();
      }, 50); // Ø³Ø±Ø¹Ø© Ø¹Ø§Ù„ÙŠØ© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
    }

    function stopFlipLetters() {
      if (flipLettersTimer) {
        clearInterval(flipLettersTimer);
        flipLettersTimer = null;
      }
      flipLettersSpan.textContent = '';
    }

    // --- Ø¨Ø¯Ø¡ Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­ØªÙ‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ---
    function startPreCountdown() {
      clearInterval(preCountdownTimer);
      preCountdownTimer = null;

      if (!scheduledStartTime) {
        preCountdownSpan.textContent = 'â€”';
        return;
      }

      startFlipLetters();

      preCountdownTimer = setInterval(() => {
        const now = new Date();
        const diffMs = scheduledStartTime - now;
        if (diffMs <= 0) {
          clearInterval(preCountdownTimer);
          preCountdownTimer = null;
          preCountdownSpan.textContent = '00:00';
          stopFlipLetters();
          // Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©
          beginRoundNow();
        } else {
          const diffSec = Math.floor(diffMs / 1000);
          const mm = String(Math.floor(diffSec / 60)).padStart(2, '0');
          const ss = String(diffSec % 60).padStart(2, '0');
          preCountdownSpan.textContent = `${mm}:${ss}`;
        }
      }, 250);
    }

    // --- Ø¨Ø¯Ø¡ Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ÙØ¹Ù„ÙŠ ---
    function startRoundCountdown(durationSeconds) {
      clearInterval(roundTimer);
      roundTimer = null;

      let remaining = durationSeconds;
      updateRoundTimerDisplay(remaining, durationSeconds);

      roundTimer = setInterval(() => {
        remaining--;
        if (remaining <= 0) {
          clearInterval(roundTimer);
          roundTimer = null;
          roundCountdownSpan.textContent = 'Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª';
          roundCountdownSpan.classList.remove('timer-green', 'timer-yellow', 'timer-red');
          roundCountdownSpan.classList.add('timer-red');
          syncInfoSpan.textContent = 'Ø§Ù†ØªÙ‡Ù‰ ÙˆÙ‚Øª Ø§Ù„Ø¬ÙˆÙ„Ø©ØŒ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø«Ù… Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø£Ùˆ Ø§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©.';
          // Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª: Ù†Ù…Ù†Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„ÙƒÙ† Ù†ØªØ±Ùƒ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª
          setWordInputsEnabled(false);
          showScores(true);
          setScoreInputsEnabled(true);
          saveRoundBtn.disabled = false;
        } else {
          updateRoundTimerDisplay(remaining, durationSeconds);
        }
      }, 1000);
    }

    function updateRoundTimerDisplay(remaining, total) {
      const mm = String(Math.floor(remaining / 60)).padStart(2, '0');
      const ss = String(remaining % 60).padStart(2, '0');
      roundCountdownSpan.textContent = `${mm}:${ss}`;

      roundCountdownSpan.classList.remove('timer-green', 'timer-yellow', 'timer-red');
      const fraction = remaining / total;
      if (fraction > 0.6) {
        roundCountdownSpan.classList.add('timer-green');
      } else if (fraction > 0.3) {
        roundCountdownSpan.classList.add('timer-yellow');
      } else {
        roundCountdownSpan.classList.add('timer-red');
      }
    }

    // --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© ÙØ¹Ù„ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© ---
    function beginRoundNow() {
      if (!gameActive) return;
      if (!pendingRound || !scheduledStartTime) return;

      const roomCode = roomCodeInput.value.trim();
      if (!roomCode) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© Ø£ÙˆÙ„Ù‹Ø§.');
        return;
      }

      currentRound = pendingRound;
      currentRoundSpan.textContent = currentRound;
      syncInfoSpan.textContent = 'Ø§Ù„Ø¬ÙˆÙ„Ø© Ù‚ÙŠØ¯ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø¢Ù† âœ…';

      // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø±Ù
      const letter = pickLetter(roomCode, currentRound);
      currentLetterSpan.textContent = letter;

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø±Ù Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
      if (!usedLetters.includes(letter)) {
        usedLetters.push(letter);
        usedLettersCountSpan.textContent = usedLetters.length;
      }

      // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      clearCurrentRoundInputs();
      setWordInputsEnabled(true);
      showScores(false);        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨
      setScoreInputsEnabled(false);
      saveRoundBtn.disabled = true;

      // Ø¨Ø¯Ø¡ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø©
      const duration = parseInt(roundDurationSelect.value, 10) || 60;
      startRoundCountdown(duration);

      // ØªÙ†Ø¸ÙŠÙ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
      pendingRound = null;
      scheduledStartTime = null;
      scheduledStartSpan.textContent = 'â€”';
      preCountdownSpan.textContent = 'â€”';
    }

    // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©" ---
    startRoundBtn.addEventListener('click', () => {
      if (!gameActive) {
        alert('Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ©. Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù„Ø¹Ø¨Ø©.');
        return;
      }

      const roomCode = roomCodeInput.value.trim();
      if (!roomCode) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª.');
        return;
      }

      const nextMinute = getNextMinuteDate();
      const nextMinuteKey = nextMinute.toISOString().slice(0,16); // YYYY-MM-DDTHH:MM

      if (pendingRound && scheduledStartTime) {
        const currentKey = scheduledStartTime.toISOString().slice(0,16);
        if (currentKey === nextMinuteKey) {
          syncInfoSpan.textContent = 'Ø¬ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©. Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.';
          return;
        }
      }

      pendingRound = currentRound + 1;
      scheduledStartTime = nextMinute;
      scheduledStartSpan.textContent = formatTime(scheduledStartTime);
      syncInfoSpan.textContent = 'Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±â€¦ Ø³ØªØ¨Ø¯Ø£ Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©.';
      preCountdownSpan.textContent = '00:00';

      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ù‰ Ø£Ù† ØªØ¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©
      setWordInputsEnabled(false);
      setScoreInputsEnabled(false);
      showScores(false);
      clearCurrentRoundInputs();
      currentLetterSpan.textContent = 'â€”';

      startPreCountdown();
    });

    // --- Ø²Ø± "ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©" ---
    saveRoundBtn.addEventListener('click', () => {
      if (!gameActive) return;
      if (currentRound === 0) {
        alert('Ù„Ù… ØªØ¨Ø¯Ø£ Ø£ÙŠ Ø¬ÙˆÙ„Ø© Ø¨Ø¹Ø¯.');
        return;
      }

      const roundTotal = parseInt(roundTotalSpan.textContent, 10) || 0;

      if (roundResults[currentRound]) {
        // ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹ -> ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø·
        const oldTotal = roundResults[currentRound].total;
        globalTotal = globalTotal - oldTotal + roundTotal;
        roundResults[currentRound].total = roundTotal;
        roundResults[currentRound].tdTotal.textContent = roundTotal;
      } else {
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        globalTotal += roundTotal;

        const tr = document.createElement('tr');
        const tdRound = document.createElement('td');
        const tdLetter = document.createElement('td');
        const tdTotal = document.createElement('td');

        tdRound.textContent = currentRound;
        tdLetter.innerHTML = `<span class="letter-tag">${currentLetterSpan.textContent}</span>`;
        tdTotal.textContent = roundTotal;

        tr.appendChild(tdRound);
        tr.appendChild(tdLetter);
        tr.appendChild(tdTotal);
        roundsTableBody.appendChild(tr);

        roundResults[currentRound] = {
          total: roundTotal,
          row: tr,
          tdTotal
        };
      }

      globalTotalSpan.textContent = globalTotal;
      syncInfoSpan.textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø¬ÙˆÙ„Ø© Ù†ÙØ³Ù‡Ø§ØŒ ÙˆÙ„Ù† ÙŠÙØ¶Ø§Ù ØµÙ Ø¬Ø¯ÙŠØ¯.';
    });

    // --- Ø²Ø± "Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©" ---
    endGameBtn.addEventListener('click', () => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.')) {
        return;
      }
      gameActive = false;
      startRoundBtn.disabled = true;
      endGameBtn.disabled = true;
      saveRoundBtn.disabled = true;
      setWordInputsEnabled(false);
      setScoreInputsEnabled(false);
      clearInterval(preCountdownTimer);
      clearInterval(roundTimer);
      stopFlipLetters();
      syncInfoSpan.textContent = 'Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ©. Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„.';
    });

    // --- Ø²Ø± "Ø§Ø¨Ø¯Ø£ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©" ---
    newMatchBtn.addEventListener('click', () => {
      if (!confirm('Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø³ØªØµÙØ± Ø§Ù„Ø¬ÙˆÙ„Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø³Ø¬Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

      // Ù†Ø­ØªÙØ¸ Ø¨ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ù„Ø«ÙŠÙ… ÙÙ‚Ø·
      currentRound = 0;
      pendingRound = null;
      scheduledStartTime = null;
      usedLetters = [];
      globalTotal = 0;

      for (const key in roundResults) {
        delete roundResults[key];
      }
      roundsTableBody.innerHTML = '';

      currentRoundSpan.textContent = '0';
      usedLettersCountSpan.textContent = '0';
      globalTotalSpan.textContent = '0';
      roundTotalSpan.textContent = '0';
      currentLetterSpan.textContent = 'â€”';
      scheduledStartSpan.textContent = 'â€”';
      preCountdownSpan.textContent = 'â€”';
      roundCountdownSpan.textContent = 'â€”';
      syncInfoSpan.textContent = 'ØªÙ… Ø¨Ø¯Ø¡ Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨.';
      flipLettersSpan.textContent = '';

      clearInterval(preCountdownTimer);
      clearInterval(roundTimer);
      stopFlipLetters();
      preCountdownTimer = null;
      roundTimer = null;

      clearCurrentRoundInputs();
      setWordInputsEnabled(false);
      setScoreInputsEnabled(false);
      showScores(false);
      saveRoundBtn.disabled = true;

      gameActive = true;
      startRoundBtn.disabled = false;
      endGameBtn.disabled = false;
    });

    // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ ---
    // (Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙˆÙ‚ Ø¨Ù€ setInterval)

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    buildFields();
  </script>
</body>
</html>
