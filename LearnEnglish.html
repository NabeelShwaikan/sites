<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸˆ Ù…Ø¯Ø±Ù‘Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†</title>
  <style>
    :root{
      --bg1:#fdf2f8; --bg2:#e9d5ff; --panel:#ffffff; --border:rgba(2,6,23,.10);
      --text:#1f2937; --muted:#6b7280; --accent:#f472b6; --accent2:#a78bfa;
      --ok:#16a34a; --warn:#d97706; --bad:#dc2626; --radius:20px; --shadow:0 14px 36px rgba(2,6,23,.12);
    }
    html[data-theme="day"]{ --bg1:#f1f5f9; --bg2:#e2e8f0; --panel:#ffffff; --text:#0f172a; --muted:#475569; --accent:#38bdf8; --accent2:#22d3ee }
    html[data-theme="morning"]{ --bg1:#e0f2fe; --bg2:#ede9fe; --panel:#ffffff; --text:#0f172a; --muted:#334155; --accent:#818cf8; --accent2:#38bdf8 }
    html[data-theme="dark"]{ --bg1:#000; --bg2:#000; --panel:#000; --text:#e5e7eb; --muted:#9ca3af; --accent:#ffffff; --accent2:#00ffff; --border:rgba(255,255,255,.16) }
    html[data-theme="ocean"]{ --bg1:#dbeafe; --bg2:#bfdbfe; --panel:#ffffff; --text:#0f172a; --muted:#334155; --accent:#60a5fa; --accent2:#06b6d4 }
    html[data-theme="sunset"]{ --bg1:#ffe4e6; --bg2:#fde68a; --panel:#ffffff; --text:#111827; --muted:#4b5563; --accent:#fb7185; --accent2:#f59e0b }
    html[data-theme="forest"]{ --bg1:#dcfce7; --bg2:#bbf7d0; --panel:#ffffff; --text:#052e16; --muted:#14532d; --accent:#10b981; --accent2:#84cc16 }
    html[data-theme="kids"]{ --bg1:#fdf2f8; --bg2:#e9d5ff; --panel:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#f472b6; --accent2:#a78bfa }
    html[data-theme="high-contrast"]{ --bg1:#000; --bg2:#000; --panel:#000; --text:#fff; --muted:#e5e7eb; --accent:#fff000; --accent2:#00ffff }

    html,body{height:100%}
    body{margin:0; background:linear-gradient(180deg,var(--bg1),var(--bg2)); color:var(--text); font-family:"Segoe UI", system-ui, -apple-system, Tahoma, Arial, sans-serif; padding:16px 16px 120px}
    .app{width:min(1100px,100%); margin:0 auto}
    h1{margin:0 0 10px; font-size:clamp(22px,4.5vw,36px)}

    .topbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; background:rgba(255,255,255,.75); border:1px solid var(--border); border-radius:18px; padding:10px 12px; box-shadow:var(--shadow); margin:10px 0 14px}
    html[data-theme="dark"] .topbar{ background:rgba(0,0,0,.85) }
    .label{font-size:14px; color:var(--muted)}
    select,input,button{border-radius:14px; border:1px solid rgba(2,6,23,.14); padding:12px 14px; background:#f8fafc; color:var(--text)}
    html[data-theme="dark"] select, html[data-theme="dark"] input, html[data-theme="dark"] button{ background:#000; color:#e5e7eb; border-color:rgba(255,255,255,.16)}
    .theme-select{font-weight:800}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-inline-start:auto}
    .chip{background:#f1f5f9; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}

    .grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:12px; box-shadow:var(--shadow)}
    .card h2{margin:8px 0 10px; font-size:20px}

    .viewer{display:grid; gap:12px}
    .media{display:grid; grid-template-columns: 240px 1fr; gap:14px; align-items:center}
    @media (max-width:720px){ .media{grid-template-columns:1fr} }
    .imgwrap{position:relative; width:100%; aspect-ratio:1/1; background:#f1f5f9; border:1px solid var(--border); border-radius:18px; overflow:hidden}
    .imgwrap img{width:100%; height:100%; object-fit:cover}
    .badge{position:absolute; inset:10px auto auto 10px; background:rgba(0,0,0,.6); color:#fff; font-size:12px; padding:4px 8px; border-radius:999px}

    .word{font-size:40px; font-weight:900}
    .tr{color:var(--muted); font-size:22px}
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; padding:4px 10px; border-radius:999px; font-size:12px}

    .bigbar{display:flex; flex-wrap:wrap; gap:8px}
    .btn{cursor:pointer; border:none; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#0b1220; font-weight:900; box-shadow:0 10px 24px rgba(2,6,23,.14)}
    .ghost{background:transparent; border:1px solid rgba(2,6,23,.2); color:var(--text)}
    .pill{background:#f1f5f9; border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:14px}

    .row{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    @media (max-width:680px){ .row{grid-template-columns:1fr 1fr} }
    @media (max-width:480px){ .row{grid-template-columns:1fr} }

    .list{display:grid; grid-template-columns: repeat(auto-fill, minmax(190px,1fr)); gap:10px}
    .item{border:1px solid var(--border); border-radius:14px; padding:10px; background:var(--panel)}
    .section{margin-top:10px;}
    .sec{display:flex; align-items:center; justify-content:space-between; margin:14px 0 8px; font-size:16px}
    .sec small{color:var(--muted)}
    .list.online .item{background:linear-gradient(180deg, rgba(167,139,250,.08), rgba(56,189,248,.08)); border-style:dashed}
    .badge-mini{display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:#f8fafc;}
    html[data-theme="dark"] .list.online .item{background:#0a0a0a; border-style:dashed}
    .lists-wrap{display:grid; gap:6px}
    .scroller{max-height:340px; overflow:auto; padding-right:2px}
    .rowline{height:1px; background:linear-gradient(90deg,transparent, rgba(2,6,23,.15), transparent)}

    .kpi{background:#ffffff; border:1px solid var(--border); border-radius:14px; padding:12px}
    .kpi h3{margin:0 0 6px; font-size:18px}

    .foot{color:var(--muted); font-size:12px}
    /* --- Dark theme hard overrides to remove white cards/chips --- */
  html[data-theme="dark"] .chip,
  html[data-theme="dark"] .pill,
  html[data-theme="dark"] .badge-mini{ background:#0a0a0a; color:#e5e7eb; border-color:rgba(255,255,255,.16) }
  html[data-theme="dark"] .kpi,
  html[data-theme="dark"] .item{ background:#0a0a0a; border-color:rgba(255,255,255,.16) }
  html[data-theme="dark"] .imgwrap{ background:#0a0a0a; border-color:rgba(255,255,255,.16) }
  html[data-theme="dark"] .rowline{ background:linear-gradient(90deg,transparent, rgba(255,255,255,.15), transparent) }
</style>
</head>
<body>
  <div class="app">
    <h1>ğŸˆ Ù…Ø¯Ø±Ù‘Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© â€” Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†</h1>

    <div class="topbar">
      <span class="label">Ø§Ù„Ù†Ù…Ø·:</span>
      <select id="themeSelect" class="theme-select" title="Ø§Ø®ØªØ± Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶">
        <option value="kids">Ø£Ø·ÙØ§Ù„ Ù…Ø±Ø­</option>
        <option value="morning">ØµØ¨Ø§Ø­ÙŠ Ù…Ø´Ø±Ù‚</option>
        <option value="day">Ù†Ù‡Ø§Ø±ÙŠ</option>
        <option value="dark">Ø¯Ø§ÙƒÙ† Ø­ÙŠÙˆÙŠ</option>
        <option value="ocean">Ø£Ø²Ø±Ù‚ Ù…Ø­ÙŠØ·ÙŠ</option>
        <option value="sunset">ØºØ±ÙˆØ¨ Ø¯Ø§ÙØ¦</option>
        <option value="forest">ØºØ§Ø¨Ø© Ø®Ø¶Ø±Ø§Ø¡</option>
      </select>
      <div class="chips">
        <span class="chip" id="chipTime">Ø§Ù„ÙˆÙ‚Øª â€”:â€”:â€”</span>
        <span class="chip" id="chipHijri">Ù‡Ø¬Ø±ÙŠ â€”</span>
        <span class="chip" id="chipGreg">Ù…ÙŠÙ„Ø§Ø¯ÙŠ â€”</span>
      </div>
    </div>

    <p class="foot" style="margin:0 0 12px">ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø³Ø·Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„: Ø£Ø²Ø±Ø§Ø± ÙƒØ¨ÙŠØ±Ø©ØŒ Ø£Ù„ÙˆØ§Ù† Ø³Ø¹ÙŠØ¯Ø©ØŒ Ù†Ø·Ù‚ØŒ ØµÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ©ØŒ ÙˆØ§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚ØµÙŠØ±Ø©. ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§.</p>

    <div class="grid">
      <div class="card">
        <h2>ğŸ´ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒÙ„Ù…Ø©</h2>
        <div class="viewer">
          <div class="media">
            <div class="imgwrap">
              <img id="img" alt="image" src="" />
              <span class="badge" id="imgBadge">Wikipedia</span>
            </div>
            <div>
              <div class="word" id="wWord">cat</div>
              <div class="tr" id="wTrans">Ù‚Ø·Ø©</div>
              <div class="tags" style="margin-top:4px">
                <span class="tag" id="wTopic">Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</span>
                <span class="tag" id="wLevel">Ø³Ù‡Ù„</span>
              </div>
              <div class="bigbar" style="margin-top:10px">
                <button class="btn" id="speak">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</button>
                <button class="btn ghost" id="prev">â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                <button class="btn ghost" id="next">â¡ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="btn ghost" id="shuffle">ğŸ”€ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>
                <button class="btn ghost" id="lockImg">ğŸ”’ Ù‚ÙÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>
                <button class="btn ghost" id="changeImg">ğŸ–¼ï¸ Ø¨Ø¯Ù‘Ù„ Ø§Ù„ØµÙˆØ±Ø©</button>
              </div>
              <div class="bigbar" style="margin-top:8px">
                <button class="pill" id="markKnown">âœ”ï¸ Ø£Ø¹Ø±ÙÙ‡Ø§</button>
                <button class="pill" id="markPractice">ğŸŸ¡ Ø£Ø­ØªØ§Ø¬ ØªØ¯Ø±ÙŠØ¨</button>
                <span class="pill" id="statKnown">Ù…Ø¹Ø±ÙˆÙØ©: 0</span>
                <span class="pill" id="statPractice">Ù„Ù„ØªØ¯Ø±ÙŠØ¨: 0</span>
              </div>
            </div>
          </div>

          <div class="row">
            <select id="filterTopic"></select>
            <select id="filterLevel">
              <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</option>
              <option value="easy">Ø³Ù‡Ù„</option>
              <option value="medium">Ù…ØªÙˆØ³Ø·</option>
              <option value="hard">ØµØ¹Ø¨</option>
            </select>
            <input id="customImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ù…Ø®ØµÙ‘Øµ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
          </div>
        </div>
      </div>

      <div class="card">
        <h2>ğŸ—‚ï¸ ÙƒÙ„Ù…Ø§ØªÙŠ & ğŸŒ Ø§Ø³ØªÙƒØ´Ø§Ù</h2>
        <div class="viewer">
          <div class="row">
            <input id="newWord" placeholder="Word (EN)" />
            <input id="newTrans" placeholder="Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" />
            <select id="newTopic"></select>
          </div>
          <div class="row">
            <select id="newLevel">
              <option value="easy">Ø³Ù‡Ù„</option>
              <option value="medium">Ù…ØªÙˆØ³Ø·</option>
              <option value="hard">ØµØ¹Ø¨</option>
            </select>
            <button class="btn" id="addWord">â• Ø¥Ø¶Ø§ÙØ©</button>
            <button class="btn ghost" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ±</button>
            <input type="file" id="importFile" accept="application/json" />
          </div>
          <div class="row">
            <input id="topicQuery" placeholder="Ù…ÙˆØ¶ÙˆØ¹ (animals, food â€¦ Ø£Ùˆ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)" />
            <select id="wantedLevel">
              <option value="any">Ø£ÙŠ Ù…Ø³ØªÙˆÙ‰</option>
              <option value="easy">Ø³Ù‡Ù„</option>
              <option value="medium">Ù…ØªÙˆØ³Ø·</option>
              <option value="hard">ØµØ¹Ø¨</option>
            </select>
            <button class="btn" id="fetchOnline">ğŸŒ Ø¬Ù„Ø¨ ÙƒÙ„Ù…Ø§Øª</button>
          </div>
          <div class="lists-wrap">
            <div class="section">
              <h3 class="sec">ğŸ“š Ù‚Ø§Ø¦Ù…ØªÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠØ© <small id="countLocal">0 Ø¹Ù†ØµØ±</small></h3>
              <div class="rowline"></div>
              <div class="list scroller" id="list"></div>
            </div>
            <div class="section">
              <h3 class="sec">ğŸ§© ÙƒÙ„Ù…Ø§Øª Ù…Ù‚ØªØ±Ø­Ø© Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª <small id="countOnline">0 Ø¹Ù†ØµØ±</small></h3>
              <div class="rowline"></div>
              <div class="list online scroller" id="onlineList"></div>
            </div>
          </div>
        </div>

        <h2 style="margin-top:12px">ğŸ§  Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</h2>
        <div class="row">
          <select id="quizMode">
            <option value="missing">Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù†Ø§Ù‚Øµ</option>
            <option value="meaning">Ø§Ù„Ù…Ø¹Ù†Ù‰ (Ø§Ø®ØªÙŠØ§Ø±)</option>
            <option value="pos">Ù†ÙˆØ¹ Ø§Ù„ÙƒÙ„Ù…Ø©</option>
          </select>
          <select id="quizSource">
            <option value="all">ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</option>
            <option value="topic">Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
            <option value="level">Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
          </select>
          <div style="display:flex; gap:8px">
            <button class="btn" id="startQuiz">Ø§Ø¨Ø¯Ø£</button>
            <button class="btn ghost" id="nextQ" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>
        <div id="quizArea" style="min-height:110px; margin-top:6px">
          <div class="kpi"><h3>Ø§Ø®ØªØ± Ù†Ù…Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø«Ù… Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£"</h3><div class="foot">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù‚Ø§Ø¦Ù…ØªÙƒ.</div></div>
        </div>
      </div>
    </div>

    <p class="foot" style="margin-top:10px">Ø§Ù„ØµÙˆØ± Ù…Ù† Wikipedia/Wikimedia (ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)ØŒ Ø§Ù„Ù†Ø·Ù‚ Ø¹Ø¨Ø± Web Speech APIØŒ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ØªÙÙÙ„ØªØ± Ù‚Ø§Ù…ÙˆØ³ÙŠÙ‹Ø§ (Datamuse + ØªØ¹Ø±ÙŠÙØ§Øª) ÙˆØªÙÙ‚Ø³Ù‘Ù… Ø­Ø³Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¥Ù„Ù‰ Ø³Ù‡Ù„/Ù…ØªÙˆØ³Ø·/ØµØ¹Ø¨. Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ.</p>
  </div>

  <script defer>
  (function(){
    function ready(fn){ if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', fn); } else { fn(); } }
    ready(function(){
      // ====== Theme & Clock ======
      const THEME_KEY='trainer:theme:v1';
      const CLOCK_TZ='Asia/Riyadh';
      const themeSelect=document.getElementById('themeSelect');
      function setTheme(t){ document.documentElement.setAttribute('data-theme', t); try{ localStorage.setItem(THEME_KEY,t);}catch(e){} themeSelect.value=t; }
      (function(){ const saved=localStorage.getItem(THEME_KEY)||'kids'; setTheme(saved); themeSelect.addEventListener('change',()=> setTheme(themeSelect.value)); })();

      const elTime=document.getElementById('chipTime'); const elHijri=document.getElementById('chipHijri'); const elGreg=document.getElementById('chipGreg');
      function updateClock(){
        const now=new Date();
        const timeStr=new Intl.DateTimeFormat('ar-SA',{hour:'numeric',minute:'2-digit',second:'2-digit',hour12:true,timeZone:CLOCK_TZ}).format(now);
        const gregStr=new Intl.DateTimeFormat('ar-SA',{weekday:'long',year:'numeric',month:'long',day:'numeric',timeZone:CLOCK_TZ}).format(now);
        const hijriStr=new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{weekday:'long',year:'numeric',month:'long',day:'numeric',timeZone:CLOCK_TZ}).format(now);
        elTime.textContent='Ø§Ù„ÙˆÙ‚Øª ' + timeStr; elGreg.textContent='Ù…ÙŠÙ„Ø§Ø¯ÙŠ ' + gregStr; elHijri.textContent='Ù‡Ø¬Ø±ÙŠ ' + hijriStr;
      }
      updateClock(); setInterval(updateClock, 1000);

      // ====== Storage & Seed ======
      const STORAGE_KEY='trainer:data:v2';
      const PROG_KEY='trainer:progress:v1';
      const IMG_CACHE='trainer:imgcache:v1';

      const defaultTopics=['Ø§Ù„ØªØ­ÙŠØ©','Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©','Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª','Ø§Ù„Ø·Ø¹Ø§Ù…','Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„ÙØ§ÙƒÙ‡Ø©','Ø§Ù„Ù…Ø¯Ø±Ø³Ø©','Ø§Ù„Ø£Ù„ÙˆØ§Ù†','Ø§Ù„Ø¬Ø³Ù…','Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª','Ø§Ù„Ø·Ù‚Ø³'];
      const seedWords=[
        {word:'cat', tr:'Ù‚Ø·Ø©', level:'easy', topic:'Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª'},
        {word:'dog', tr:'ÙƒÙ„Ø¨', level:'easy', topic:'Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª'},
        {word:'apple', tr:'ØªÙØ§Ø­Ø©', level:'easy', topic:'Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„ÙØ§ÙƒÙ‡Ø©'},
        {word:'orange (fruit)', tr:'Ø¨Ø±ØªÙ‚Ø§Ù„Ø©', level:'easy', topic:'Ø§Ù„Ø®Ø¶Ø§Ø± ÙˆØ§Ù„ÙØ§ÙƒÙ‡Ø©'},
        {word:'bus', tr:'Ø­Ø§ÙÙ„Ø©', level:'easy', topic:'Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª'},
        {word:'teacher', tr:'Ù…Ø¹Ù„Ù‘Ù…', level:'easy', topic:'Ø§Ù„Ù…Ø¯Ø±Ø³Ø©'},
        {word:'elephant', tr:'ÙÙŠÙ„', level:'medium', topic:'Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª'},
        {word:'umbrella', tr:'Ù…Ø¸Ù„Ù‘Ø©', level:'medium', topic:'Ø§Ù„Ø·Ù‚Ø³'},
        {word:'refrigerator', tr:'Ø«Ù„Ø§Ø¬Ø©', level:'hard', topic:'Ø§Ù„Ù…Ù†Ø²Ù„'}
      ];

      function loadData(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'null') || {topics:defaultTopics, words:seedWords}; }catch(e){ return {topics:defaultTopics, words:seedWords}; } }
      function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }
      function loadProg(){ try{ return JSON.parse(localStorage.getItem(PROG_KEY)||'{}'); }catch(e){ return {}; } }
      function saveProg(p){ localStorage.setItem(PROG_KEY, JSON.stringify(p)); }
      function loadImgCache(){ try{ return JSON.parse(localStorage.getItem(IMG_CACHE)||'{}'); }catch(e){ return {}; } }
      function saveImgCache(c){ localStorage.setItem(IMG_CACHE, JSON.stringify(c)); }

      let DB=loadData(); let PROG=loadProg(); let IMG=loadImgCache();

      // ====== DOM refs ======
      const elImg=document.getElementById('img'); const elBadge=document.getElementById('imgBadge');
      const elWord=document.getElementById('wWord'); const elTrans=document.getElementById('wTrans'); const elTopic=document.getElementById('wTopic'); const elLevel=document.getElementById('wLevel');
      const btnSpeak=document.getElementById('speak'); const btnPrev=document.getElementById('prev'); const btnNext=document.getElementById('next'); const btnShuffle=document.getElementById('shuffle');
      const btnLock=document.getElementById('lockImg'); const btnChange=document.getElementById('changeImg'); const inputCustomImg=document.getElementById('customImage');
      const btnKnown=document.getElementById('markKnown'); const btnPractice=document.getElementById('markPractice'); const statKnown=document.getElementById('statKnown'); const statPractice=document.getElementById('statPractice');
      const filterTopic=document.getElementById('filterTopic'); const filterLevel=document.getElementById('filterLevel');
      const list=document.getElementById('list');
      const countLocal=document.getElementById('countLocal');
      const countOnline=document.getElementById('countOnline');
      const newWord=document.getElementById('newWord'); const newTrans=document.getElementById('newTrans'); const newTopic=document.getElementById('newTopic'); const newLevel=document.getElementById('newLevel');
      const addWordBtn=document.getElementById('addWord');
      const exportBtn=document.getElementById('exportBtn'); const importFile=document.getElementById('importFile');
      const onlineList=document.getElementById('onlineList'); const topicQuery=document.getElementById('topicQuery'); const wantedLevel=document.getElementById('wantedLevel'); const fetchOnline=document.getElementById('fetchOnline');

      // ====== Helpers ======
      function levelAr(l){ return l==='easy'?'Ø³Ù‡Ù„': l==='medium'?'Ù…ØªÙˆØ³Ø·':'ØµØ¹Ø¨'; }
      function speak(text){ try{ const u=new SpeechSynthesisUtterance(text); u.lang='en-US'; u.rate=0.95; u.pitch=1.0; speechSynthesis.cancel(); speechSynthesis.speak(u); }catch(e){} }

      const statusBar=(function(){
        const p=document.createElement('div');
        p.className='foot';
        p.style.marginTop='6px';
        p.id='statusBar';
        p.textContent='';
        document.querySelector('.app').appendChild(p);
        return p;
      })();
      function setStatus(msg, ok=true){ if(!statusBar) return; statusBar.style.color = ok? 'var(--muted)' : 'var(--bad)'; statusBar.textContent = msg||''; }

      function updateStats(){ const known=Object.values(PROG).filter(x=>x==='known').length; const practice=Object.values(PROG).filter(x=>x==='practice').length; statKnown.textContent='Ù…Ø¹Ø±ÙˆÙØ©: ' + known; statPractice.textContent='Ù„Ù„ØªØ¯Ø±ÙŠØ¨: ' + practice; }

      async function wikiImageFor(term){
        const key=term.toLowerCase(); if(IMG[key] && IMG[key].locked) return IMG[key].url; if(IMG[key] && IMG[key].url) return IMG[key].url;
        try{ const q=encodeURIComponent(term.split('(fruit)').join('').trim()); const r=await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + q); if(r.ok){ const j=await r.json(); const url=(j && j.thumbnail && j.thumbnail.source) || (j && j.originalimage && j.originalimage.source); if(url){ IMG[key]={url:url}; saveImgCache(IMG); return url; } } }catch(e){}
        try{ const q=encodeURIComponent(term); const r=await fetch('https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=' + q + '&gsrlimit=1&prop=imageinfo&iiprop=url&iiurlwidth=640&format=json&origin=*'); const j=await r.json(); const pages=j && j.query && j.query.pages ? j.query.pages : {}; const first=Object.keys(pages).length? pages[Object.keys(pages)[0]] : null; const url= first && first.imageinfo && first.imageinfo[0] && (first.imageinfo[0].thumburl || first.imageinfo[0].url); if(url){ IMG[key]={url:url}; saveImgCache(IMG); return url; } }catch(e){}
        return '';
      }
      function lockCurrentImage(){ const w=DB.words[currentIndex]; if(!w) return; const key=w.word.toLowerCase(); if(!IMG[key]) IMG[key]={}; IMG[key].locked=true; saveImgCache(IMG); elBadge.textContent='Locked'; }
      function setCustomImage(url){ const w=DB.words[currentIndex]; if(!w) return; const key=w.word.toLowerCase(); IMG[key]={url:url,locked:true}; saveImgCache(IMG); showImage(url,'Custom'); }
      function showImage(url,source){ elImg.src=url||''; elBadge.textContent=source||'Wikipedia'; }

      const MINI_DICT={ cat:'Ù‚Ø·Ø©', dog:'ÙƒÙ„Ø¨', apple:'ØªÙØ§Ø­Ø©', orange:'Ø¨Ø±ØªÙ‚Ø§Ù„Ø©', bus:'Ø­Ø§ÙÙ„Ø©', teacher:'Ù…Ø¹Ù„Ù‘Ù…', elephant:'ÙÙŠÙ„', umbrella:'Ù…Ø¸Ù„Ù‘Ø©', refrigerator:'Ø«Ù„Ø§Ø¬Ø©' };
      async function autoTranslate(en){
        const key=en.toLowerCase().split('(fruit)').join('').trim(); if(MINI_DICT[key]) return MINI_DICT[key];
        try{ const r=await fetch('https://api.mymemory.translated.net/get?q=' + encodeURIComponent(en) + '&langpair=en|ar'); if(r.ok){ const j=await r.json(); const txt=j && j.responseData ? j.responseData.translatedText : ''; if(txt) return txt; } }catch(e){}
        return '';
      }

      function refreshTopicSelects(){
        const opts=['<option value="all">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>'].concat(DB.topics.map(function(t){return '<option value="'+t+'">'+t+'</option>'; })).join('');
        filterTopic.innerHTML=opts; newTopic.innerHTML=DB.topics.map(function(t){return '<option value="'+t+'">'+t+'</option>';}).join('');
      }

      let currentIndex=0;
      function filteredWords(){ return DB.words.filter(function(w){ return (filterLevel.value==='all'||w.level===filterLevel.value) && (filterTopic.value==='all'||w.topic===filterTopic.value); }); }

      async function showCurrent(forceImg){
        const arr=filteredWords(); if(arr.length===0){ elWord.textContent='â€”'; elTrans.textContent='Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª'; elTopic.textContent='â€”'; elLevel.textContent='â€”'; showImage('', ''); return; }
        const i=Math.max(0, Math.min(currentIndex, arr.length-1)); const item=arr[i];
        elWord.textContent=item.word; elTrans.textContent=item.tr||'â€”'; elTopic.textContent=item.topic; elLevel.textContent=levelAr(item.level);
        if(!item.tr){ item.tr = await autoTranslate(item.word) || 'â€”'; saveData(DB); elTrans.textContent=item.tr; }
        if(forceImg || !elImg.getAttribute('src')){ const custom=inputCustomImg.value.trim(); if(custom){ setCustomImage(custom); } else { const url=await wikiImageFor(item.word); showImage(url, (IMG[item.word.toLowerCase()] && IMG[item.word.toLowerCase()].locked)?'Locked':'Wikipedia'); } }
        updateStats();
      }

      function gotoNext(){ const arr=filteredWords(); if(arr.length===0) return; currentIndex=(currentIndex+1)%arr.length; showCurrent(true); }
      function gotoPrev(){ const arr=filteredWords(); if(arr.length===0) return; currentIndex=(currentIndex-1+arr.length)%arr.length; showCurrent(true); }
      function shuffle(){ const arr=filteredWords(); if(arr.length===0) return; currentIndex=Math.floor(Math.random()*arr.length); showCurrent(true); }

      function mark(status){ const word=elWord.textContent; if(!word||word==='â€”') return; PROG[word]=status; saveProg(PROG); updateStats(); }

      function renderList(){
        try{
          list.innerHTML='';
          DB.words.forEach(function(w,i){
            const div=document.createElement('div'); div.className='item';
            div.innerHTML='<div style="display:flex; justify-content:space-between; align-items:center; gap:8px">\
              <div><span class="badge-mini">ÙÙŠ Ù‚Ø§Ø¦Ù…ØªÙŠ</span> <b style="direction:ltr">'+w.word+'</b> â€” <span style="color:var(--muted)">'+(w.tr||'â€”')+'</span><br/>\
                <span class="tag">'+w.topic+'</span> <span class="tag">'+levelAr(w.level)+'</span>\
              </div>\
              <div style="display:flex; gap:6px">\
                <button class="ghost" data-act="use">Ø¹Ø±Ø¶</button>\
                <button class="ghost" data-act="del">Ø­Ø°Ù</button>\
              </div>\
            </div>';
            div.querySelector('[data-act="use"]').addEventListener('click',function(){ currentIndex=i; showCurrent(true); });
            div.querySelector('[data-act="del"]').addEventListener('click',function(){ DB.words.splice(i,1); saveData(DB); renderList(); });
            list.appendChild(div);
          });
          if(countLocal) countLocal.textContent=DB.words.length + ' Ø¹Ù†ØµØ±';
          setStatus('');
        }catch(e){ setStatus('âš ï¸ Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…ØªÙƒ: '+ (e.message||e), false); }
      }

      function addWord(){
        const w=newWord.value.trim(); if(!w) return; const t=newTrans.value.trim(); const tp=newTopic.value; const lv=newLevel.value;
        const item={word:w, tr:t, topic:tp, level:lv}; DB.words.push(item); saveData(DB); renderList(); newWord.value=''; newTrans.value=''; currentIndex=DB.words.length-1; showCurrent(true);
      }

      function exportJSON(){ const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='trainer-data.json'; a.click(); URL.revokeObjectURL(url); }
      function importJSON(file){ const fr=new FileReader(); fr.onload=function(){ try{ const data=JSON.parse(fr.result); if(data.topics&&data.words){ DB=data; saveData(DB); refreshTopicSelects(); renderList(); showCurrent(true);} }catch(e){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } }; fr.readAsText(file); }

      // ======== Online Fetch: dictionary filtering + levels by frequency ========
      const AR_TOPIC_MAP={ 'Ø­ÙŠÙˆØ§Ù†Ø§Øª':'animals','Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª':'animals','Ø·Ø¹Ø§Ù…':'food','Ø§Ù„Ø·Ø¹Ø§Ù…':'food','Ø®Ø¶Ø§Ø±':'vegetables','Ø§Ù„Ø®Ø¶Ø§Ø±':'vegetables','ÙØ§ÙƒÙ‡Ø©':'fruit','Ø§Ù„ÙØ§ÙƒÙ‡Ø©':'fruit','Ø³ÙØ±':'travel','Ø§Ù„Ø³ÙØ±':'travel','Ù…Ø¯Ø±Ø³Ø©':'school','Ø§Ù„Ù…Ø¯Ø±Ø³Ø©':'school','Ø·Ù‚Ø³':'weather','Ø§Ù„Ø·Ù‚Ø³':'weather','Ø±ÙŠØ§Ø¶Ø©':'sports','Ø§Ù„Ø±ÙŠØ§Ø¶Ø©':'sports','Ø£Ù„ÙˆØ§Ù†':'colors','Ø§Ù„Ø£Ù„ÙˆØ§Ù†':'colors','Ù…ÙˆØ§ØµÙ„Ø§Øª':'transport','Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª':'transport','ØªØ­ÙŠØ©':'greetings','Ø§Ù„ØªØ­ÙŠØ©':'greetings' };

      const STOP_WORDS=new Set(['the','a','an','and','or','but','if','so','to','of','in','on','for','as','by','with','at','from','into','about','than','then','that','this','these','those','be','is','am','are','was','were','been','being','do','does','did','done','have','has','had','i','you','he','she','it','we','they']);

      function looksDictionaryLike(w){
        if(!/^[a-z][a-z\-]*$/i.test(w)) return false;
        if(/[\-]{2,}/.test(w)) return false;
        if(w.length<2 || w.length>14) return false;
        if(!/[aeiouy]/i.test(w)) return false;
        return true;
      }

      function inferLevelFromFreq(freq, word){
        const len=word.replace(/[^a-z]/gi,'').length;
        const f=freq||0;
        if(f>=50) return 'easy';
        if(f>=20) return len<=7 ? 'medium' : 'hard';
        return len<=5 ? 'medium' : 'hard';
      }

      async function fetchFromDatamuse(topic){
        const raw=topic.trim(); const t=AR_TOPIC_MAP[raw]||raw; const q=encodeURIComponent(t.toLowerCase());
        let items=[];
        try{
          const r=await fetch('https://api.datamuse.com/words?topics=' + q + '&max=80&md=fpd');
          if(r.ok){ items=await r.json(); }
        }catch(e){}
        if(!items || items.length<10){
          try{
            const r2=await fetch('https://api.datamuse.com/words?ml=' + q + '&max=80&md=fpd');
            if(r2.ok){ const j2=await r2.json(); items=items.concat(j2); }
          }catch(e){}
        }
        if(!items) return [];

        const seen=new Set();
        const cleaned=items.map(function(it){
          const w=(it.word||'').toLowerCase().trim();
          const tags=Array.isArray(it.tags)? it.tags : [];
          const defok = Array.isArray(it.defs) && it.defs.length>0;
          let pos='n';
          for(let k=0;k<tags.length;k++){
            const t=tags[k];
            if(t==='n'||t==='v'||t==='adj'){ pos=t; break; }
            if(/^p:/.test(t)){
              const p=t.replace('p:',''); if(p==='n'||p==='v'||p==='adj'){ pos=p; break; }
            }
          }
          let freqTag = tags.find(function(t){return /^f:/.test(t);});
          const freq = freqTag ? parseFloat(freqTag.split(':')[1]) : 0;
          return {word:w, tags, defok, pos, freq};
        }).filter(function(it){
          if(!looksDictionaryLike(it.word)) return false;
          if(STOP_WORDS.has(it.word)) return false;
          if(!(it.pos==='n' || it.pos==='v' || it.pos==='adj')) return false;
          if(!it.defok) return false;
          if(seen.has(it.word)) return false; seen.add(it.word); return true;
        });

        cleaned.forEach(function(it){ it.level=inferLevelFromFreq(it.freq, it.word); });
        cleaned.sort(function(a,b){
          const order={easy:0, medium:1, hard:2};
          if(order[a.level]!==order[b.level]) return order[a.level]-order[b.level];
          return (b.freq||0) - (a.freq||0);
        });

        return cleaned.map(function(it){ return {word:it.word, level:it.level, pos:it.pos, freq:it.freq}; });
      }

      function renderOnline(words){
        try{
          onlineList.innerHTML='';
          let shown=0;
          if(!words||words.length===0){ onlineList.innerHTML='<div class="item" style="text-align:center; color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬. Ø¬Ø±Ù‘Ø¨ Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ Ø¢Ø®Ø±.</div>'; if(countOnline) countOnline.textContent='0 Ø¹Ù†ØµØ±'; return; }
          const topic=topicQuery.value||'Ù…ÙˆØ¶ÙˆØ¹';
          words.forEach(function(row){
            const w=row.word; const lv=row.level;
            if(wantedLevel.value!=='any' && lv!==wantedLevel.value) return;
            shown++;
            const div=document.createElement('div'); div.className='item';
            div.innerHTML='<div style="display:flex; justify-content:space-between; align-items:center; gap:8px">\
              <div><span class="badge-mini">Ù…ÙØ±Ø´Ù‘ÙØ­ Ø¬Ø¯ÙŠØ¯</span> <b style="direction:ltr">'+w+'</b><br/><span class="tag">'+topic+'</span> <span class="tag">'+levelAr(lv)+'</span></div>\
              <div style="display:flex; gap:6px">\
                <button class="ghost" data-act="add">Ø¥Ø¶Ø§ÙØ©</button>\
              </div>\
            </div>';
            const addBtn=div.querySelector('[data-act="add"]');
            addBtn.addEventListener('click', async function(){
              try{
                const tr=await autoTranslate(w) || prompt('Ø§ÙƒØªØ¨ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„ÙƒÙ„Ù…Ø©: ' + w,'') || '';
                if(!tr) { alert('ØªÙ… Ø§Ù„ØªØ¬Ø§Ù‡Ù„ Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØ±Ø¬Ù…Ø©.'); return; }
                DB.words.push({word:w, tr:tr, level:lv, topic:topic}); saveData(DB); renderList();
                addBtn.textContent='Ø£ÙØ¶ÙŠÙØª'; addBtn.disabled=true; addBtn.style.opacity=.6;
                setStatus('âœ… Ø£ÙØ¶ÙŠÙØª "'+w+'" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…ØªÙƒ');
              }catch(e){ setStatus('âš ï¸ ØªØ¹Ø°Ù‘Ø±Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ù…Ø©: '+(e.message||e), false); }
            });
            onlineList.appendChild(div);
          });
          if(shown===0){ onlineList.innerHTML='<div class="item" style="text-align:center; color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®ØªØ§Ø±.</div>'; }
          if(countOnline) countOnline.textContent=shown + ' Ø¹Ù†ØµØ±';
        }catch(e){ setStatus('âš ï¸ Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø´Ù‘Ø­Ø§Øª: '+ (e.message||e), false); }
      }

      // ====== Button listeners ======
      btnSpeak.addEventListener('click',function(){ speak(elWord.textContent); });
      btnNext.addEventListener('click', gotoNext); btnPrev.addEventListener('click', gotoPrev); btnShuffle.addEventListener('click', shuffle);
      btnLock.addEventListener('click', lockCurrentImage);
      btnChange.addEventListener('click', async function(){ const custom=inputCustomImg.value.trim(); if(custom){ setCustomImage(custom); } else { const term=elWord.textContent; const url=await wikiImageFor(term); showImage(url,'Wikipedia'); } });
      btnKnown.addEventListener('click', function(){ mark('known'); }); btnPractice.addEventListener('click', function(){ mark('practice'); });

      filterTopic.addEventListener('change', function(){ currentIndex=0; showCurrent(true); });
      filterLevel.addEventListener('change', function(){ currentIndex=0; showCurrent(true); });

      addWordBtn.addEventListener('click', addWord);
      exportBtn.addEventListener('click', exportJSON);
      importFile.addEventListener('change', function(e){ if(e.target.files && e.target.files[0]) importJSON(e.target.files[0]); });

      fetchOnline.addEventListener('click', async function(){
        const topic=topicQuery.value.trim(); if(!topic){ alert('Ø§ÙƒØªØ¨ Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§'); return; }
        onlineList.innerHTML='<div class="item" style="text-align:center">â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø¬Ù„Ø¨â€¦</div>';
        if(countOnline) countOnline.textContent='â€¦';
        try{
          const words=await fetchFromDatamuse(topic); renderOnline(words);
        }catch(e){ setStatus('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª: '+(e.message||e), false); onlineList.innerHTML='<div class="item" style="text-align:center; color:var(--bad)">ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¢Ù†.</div>'; if(countOnline) countOnline.textContent='0 Ø¹Ù†ØµØ±'; }
      });

      function init(){
        const opts=['<option value="all">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>'].concat(DB.topics.map(function(t){return '<option value="'+t+'">'+t+'</option>'; })).join('');
        filterTopic.innerHTML=opts; newTopic.innerHTML=DB.topics.map(function(t){return '<option value="'+t+'">'+t+'</option>';}).join('');
        renderList(); showCurrent(true); updateStats();
      }
      init();

      // ====== Central click delegation (backup) ======
      document.addEventListener('click', async function(e){
        const el = e.target instanceof HTMLElement ? e.target : null; if(!el) return; const id = el.id || '';
        try {
          if(id==='speak'){ e.preventDefault(); speak(elWord.textContent); }
          else if(id==='next'){ e.preventDefault(); gotoNext(); }
          else if(id==='prev'){ e.preventDefault(); gotoPrev(); }
          else if(id==='shuffle'){ e.preventDefault(); shuffle(); }
          else if(id==='lockImg'){ e.preventDefault(); lockCurrentImage(); }
          else if(id==='changeImg'){ e.preventDefault(); const custom=inputCustomImg.value.trim(); if(custom){ setCustomImage(custom);} else { const term=elWord.textContent; const url=await wikiImageFor(term); showImage(url,'Wikipedia'); } }
          else if(id==='markKnown'){ e.preventDefault(); mark('known'); }
          else if(id==='markPractice'){ e.preventDefault(); mark('practice'); }
          else if(id==='addWord'){ e.preventDefault(); addWord(); }
          else if(id==='exportBtn'){ e.preventDefault(); exportJSON(); }
          else if(id==='startQuiz'){ e.preventDefault(); document.getElementById('nextQ')?.click(); }
        } catch(err){ try{ setStatus('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø²Ø±: '+(err.message||err), false); }catch(_){} }
      });

      // ====== Quiz ======
      (function(){
        const quizArea=document.getElementById('quizArea');
        const quizMode=document.getElementById('quizMode');
        const quizSource=document.getElementById('quizSource');
        const btnStart=document.getElementById('startQuiz');
        const btnNextQ=document.getElementById('nextQ');
        let pool=[]; let score=0; let total=0; let locked=false;

        function filterPool(){
          let list=DB.words.slice();
          if(quizSource.value==='topic'){ list=list.filter(function(w){ return filterTopic.value==='all' ? true : w.topic===filterTopic.value; }); }
          if(quizSource.value==='level'){ list=list.filter(function(w){ return filterLevel.value==='all' ? true : w.level===filterLevel.value; }); }
          return list;
        }
        function shuffleArr(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
        function status(){ return '<div class="foot">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <b>' + score + '</b> Ù…Ù† <b>' + total + '</b></div>'; }

        function uiMissing(word){
          const letters=word.split(''); let idx=Math.floor(Math.random()*letters.length); if(letters.length<=4) idx=Math.max(1, Math.min(letters.length-2, idx)); const correct=letters[idx].toLowerCase(); letters[idx]='_';
          quizArea.innerHTML='<div class="kpi">\
            <h3>Ø£ÙƒÙ…Ù„ Ø§Ù„ÙƒÙ„Ù…Ø©</h3>\
            <div class="value" style="direction:ltr; font-family:monospace; font-size:24px">'+letters.join('')+'</div>\
            <div class="detail">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ù…ÙÙ‚ÙˆØ¯:</div>\
            <div style="display:flex; gap:8px; align-items:center; margin-top:8px">\
              <input id="ansMissing" type="text" style="flex:0 0 160px; padding:12px 14px; border-radius:14px; border:1px solid rgba(2,6,23,.12)" maxlength="1" placeholder="A" />\
              <button class="btn" id="submitMissing">ØªØ­Ù‚Ù‚</button>\
            </div>\
            '+status()+'\
          </div>';
          const inp=document.getElementById('ansMissing'); const btn=document.getElementById('submitMissing'); inp.focus();
          inp.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); btn.click(); }});
          btn.onclick=function(){ if(locked) return; locked=true; const val=(inp.value||'').trim().toLowerCase(); const ok=val===correct; showResult(ok, 'Ø§Ù„Ø­Ø±Ù Ø§Ù„ØµØ­ÙŠØ­: <b>'+correct.toUpperCase()+'</b> â€” Ø§Ù„ÙƒÙ„Ù…Ø©: <b style="direction:ltr">'+word+'</b>'); };
        }

        function pick(n,arr,except){ const out=[]; for(let i=0;i<arr.length;i++){ if(arr[i].word!==except.word) out.push(arr[i]); } return shuffleArr(out).slice(0,n); }
        function uiMeaning(item){
          const others=pick(3, DB.words, item).filter(function(x){ return !!x.tr; });
          const options=shuffleArr([item].concat(others));
          quizArea.innerHTML='<div class="kpi">\
            <h3>Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù…Ø¹Ù†Ù‰</h3>\
            <div class="detail">Ø§Ù„Ù…Ø¹Ù†Ù‰: <b>'+(item.tr||'â€”')+'</b></div>\
            <div id="opts" style="display:grid; gap:8px; margin-top:10px"></div>\
            '+status()+'\
          </div>';
          const wrap=document.getElementById('opts');
          options.forEach(function(opt){ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=opt.word; b.style.justifyContent='center'; b.onclick=function(){ if(locked) return; locked=true; const ok=(opt.word===item.word); showResult(ok, 'Ø§Ù„ØµØ­ÙŠØ­Ø©: <b style="direction:ltr">'+item.word+'</b>'); }; wrap.appendChild(b); });
        }

        const POS_CACHE_KEY='trainer:poscache:v1';
        function loadPOSCache(){ try{ return JSON.parse(localStorage.getItem(POS_CACHE_KEY)||'{}'); }catch(e){ return {}; } }
        function savePOSCache(c){ try{ localStorage.setItem(POS_CACHE_KEY, JSON.stringify(c)); }catch(e){} }
        async function fetchPOS(word){ const cache=loadPOSCache(); const key=word.toLowerCase(); if(cache[key]) return cache[key]; try{ const r=await fetch('https://api.datamuse.com/words?sp=' + encodeURIComponent(key) + '&md=p&max=1'); if(r.ok){ const j=await r.json(); let tag='n'; if(j[0] && j[0].tags){ for(let k=0;k<j[0].tags.length;k++){ const t=j[0].tags[k]; if(t==='n'||t==='v'||t==='adj'||t==='adv'){ tag=t; break; } } } cache[key]=tag; savePOSCache(cache); return tag; } }catch(e){} return 'n'; }
        const POS_MAP={ n:'Ø§Ø³Ù…', v:'ÙØ¹Ù„', adj:'ØµÙØ©', adv:'Ø­Ø§Ù„' };
        function uiPOS(item){
          const opts=[["n","Ø§Ø³Ù…"],["v","ÙØ¹Ù„"],["adj","ØµÙØ©"],["adv","Ø­Ø§Ù„"]];
          quizArea.innerHTML='<div class="kpi">\
            <h3>Ø­Ø¯Ù‘Ø¯ Ù†ÙˆØ¹ Ø§Ù„ÙƒÙ„Ù…Ø©</h3>\
            <div class="value" style="direction:ltr; font-size:26px">'+item.word+'</div>\
            <div id="posOpts" style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; margin-top:10px"></div>\
            '+status()+'\
          </div>';
          const wrap=document.getElementById('posOpts');
          opts.forEach(function(pair){ const code=pair[0]; const ar=pair[1]; const b=document.createElement('button'); b.className='btn ghost'; b.textContent=ar; b.onclick=async function(){ if(locked) return; locked=true; const p=await fetchPOS(item.word); const ok=(p===code); const arAns=POS_MAP[p]||'Ø§Ø³Ù…'; showResult(ok, 'Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ØµØ­ÙŠØ­: <b>'+arAns+'</b>'); }; wrap.appendChild(b); });
        }

        function showResult(ok,msg){ if(ok) score++; total++; const box=document.createElement('div'); box.className='foot'; box.style.marginTop='10px'; box.style.color= ok? 'var(--ok)':'var(--bad)'; box.innerHTML=(ok? 'âœ”ï¸ ØµØ­ÙŠØ­':'âŒ Ø®Ø·Ø£')+' â€” '+msg+' â€” <b>'+score+'</b>/<b>'+total+'</b>'; quizArea.appendChild(box); btnNextQ.disabled=false; }
        function nextQuestion(){ locked=false; btnNextQ.disabled=true; pool = pool && pool.length? pool : shuffleArr(filterPool()); if(pool.length===0){ quizArea.innerHTML='<div class="kpi"><h3>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3></div>'; return; } const current=pool.pop(); const mode=quizMode.value; if(mode==='missing') uiMissing(current.word); else if(mode==='meaning') uiMeaning(current); else uiPOS(current); }

        btnStart.addEventListener('click',function(){ score=0; total=0; pool=[]; nextQuestion(); });
        btnNextQ.addEventListener('click', nextQuestion);
      })();

      // ====== Minimal self-tests (console) ======
      (function tests(){
        try{
          console.assert(looksDictionaryLike('apple')===true, 'apple should be dict-like');
          console.assert(looksDictionaryLike('x')===false, 'too short should be false');
          console.assert(inferLevelFromFreq(80,'apple')==='easy', 'high freq easy');
          console.assert(['medium','hard'].includes(inferLevelFromFreq(10,'planet')), 'low freq not easy');
          console.log('%cSelf-tests passed','color:green');
        }catch(e){ console.warn('Self-tests error', e); }
      })();

    }); // ready
  })();
  </script>
</body>
</html>
